<!DOCTYPE html><html lang="ja">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <meta http-equiv="Content-Script-Type" content="text/javascript">
  <title>timetable</title>
  <link rel="stylesheet" href="../CSS/szDefault.css" />
  <style type="text/css" class="core">
    .right {text-align: right;}
    .image, .timetable {
      max-width: 100%;
      overflow-x: scroll;
    }
    .timetable, .timetable div {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      display: grid;
      --color: #ccc;
      --boldLine : solid 2px var(--color);
      --thinLine : dotted 1px var(--color);
    }
    .timetable span {
      padding-left: 0.3rem;
      white-space: nowrap;
    }
    /*.timetable .controller {}*/
    .timetable .main {
      grid-template-rows: 2rem 1fr;
      grid-template-columns: 1fr;
    }
    .timetable .main .header {
      grid-row: 1/2;
      grid-column: 1/2;
      grid-template-columns: repeat(3, 1fr);
      border: var(--boldLine);
    }
    .timetable .main .header div:nth-child(2n) {
      background-color: var(--color);
    }
    .timetable .main .timeline {
      grid-row: 2/3;
      grid-column: 1/2;
      grid-template-columns: repeat(12, 1fr);
      border-bottom: var(--boldLine);
    }
    .timetable .main .timeline div {
      min-width: 1rem;
      min-height: 1rem;
    }
    .timetable .main .timeline div:nth-child(2n+1) {
      border-left: var(--boldLine);
    }
    .timetable .main .timeline div:nth-child(2n) {
      border-left: var(--thinLine);
    }
    .timetable .main .timeline div:last-child {
      border-right: var(--boldLine);
    }
    .timetable .main .tasks {
      grid-row: 2/3;
      grid-column: 1/2;
      z-index: 1;
    }
    .timetable .main .tasks > div {
      max-height: 1.6rem;
      grid-column: 1/37;
      margin-bottom: 0.5rem;
    }
    .timetable .main .tasks > div:first-child {
      margin-top: 0.5rem;
    }
    .timetable .main .tasks .bar {
      grid-template-columns: repeat(36, 1fr);
    }
    .timetable .main .tasks .bar [name="1.1"]{
      grid-column: 4/12;
      background-color: var(--color);
    }
    .timetable .main .tasks .bar [name="1.2"]{
      grid-column: 15/20;
      background-color: var(--color);
    }

    .timetable .dialog {
      margin-top: 1rem;
      display: none;
    }
    .timetable .dialog div {
      padding: 0.5rem;
    }
    .timetable .dialog > div {
      grid-template-columns: 5rem 1fr;
    }
  </style>
</head>
<body>
  <div><h1>タイムテーブル</h1>
    <div class="timetable" name="tt01">
      <div class="controller"></div>
      <div class="main">
        <div class="header"></div>
        <div class="timeline"></div>
        <div class="tasks"></div>
      </div>
      <div class="dialog"></div>
    </div>

    <!--div class="timetable" name="tt02">
      <div class="controller">コントローラ</div>
      <div class="main">
        <div class="header">
          <div><span>8:00</span></div>
          <div><span>9:00</span></div>
          <div><span>10:00</span></div>
        </div>
        <div class="timeline">
          <div></div><div></div><div></div><div></div>
          <div></div><div></div><div></div><div></div>
          <div></div><div></div><div></div><div></div>
        </div>
        <div class="tasks">
          <div class="label"><span>午前の部</span></div>
          <div class="bar"><span name="1.1">受付</span></div>
          <div class="bar"><span name="1.2">挨拶</span></div>
        </div>
      </div>
      <div class="dialog">ダイアログ</div>
    </div-->

  </div>

<!--================================================
  外部スクリプト
================================================-->
<script src="../lib/jsLib.js"></script>

<!--================================================
  timetable コアスクリプト
================================================-->
<script type="text/javascript" class="core">

/**
 * @typedef {Object} Member - タスクの達成に必要な人的資源
 * @prop {number} ideal - 理想的な担当者数
 * @prop {string[]} fixed - 担当者名の配列
 * 
 * @typedef {Object} Resource - タスク達成に必要な資源
 * @prop {string} name - 資源の名前。ビニール紐、等
 * @prop {number} quantity - 必要な数量
 * @prop {string} unit - 単位名。円、個、等
 * @prop {string} procurement - 調達方法。学校、○○さん持参、購入、等
 * @prop {number} budget - 必要な予算額(見込)
 * @prop {string} note - 備考
 * 
 * 
 * @typedef {Object} Task - タスクの定義
 * @prop {string} id - 親ID＋自No。プログラム内部で自動採番
 * @prop {string} name - セクションまたはタスクの名称
 * @prop {string} [summary] - タスクの概要
 * @prop {string} [pending] - 要検討事項
 * @prop {string} [note] - 備考
 * @prop {Task[]} [children] - 子タスクの配列。指定した場合、以下は指定不可
 * 
 * @prop {Date} start - 開始日時
 * @prop {Date} end - 終了日時
 * @prop {string} location - 集合場所、作業場所
 * @prop {Member} members - タスクの担当者(人的資源)
 * @prop {Resource[]} resources - タスクの達成に必要な物的資源
 * @prop {string} output - タスクの成果物
 * @prop {string} style - タスクをバー表示する時の表示スタイル
 * 
 * 
 * @typedef {Object.<string>:<string>} CSSDef - 要素のデザインのオブジェクト。JavaScriptでのプロパティ名：値となるオブジェクト
 * 
 * @typedef {Object} Project
 * @prop {Task[]} tasks - 目標達成に必要なタスクの配列
 * @prop {Object.<string>:<CSSDef>} design - タスクをバー表示する時のスタイル定義
 * @prop {number} unit=5 - バーを表示する際の精度(単位：分)
 * @prop {string[]} period - タスクを追加する際の開始/終了日時の既定値
 * @prop {Object.<string>:<Task>} map - task.idをキーにタスクを検索するマップ。自動生成
 * 
 */


/**
 * @typedef {Object} opt
 * @prop {string} datatype - データのタイプ。sheet:シートデータ
 */

/**
 * @classdesc HTMLにタイムテーブルを描画する
 */

class TimeTable {

  /**
   * @constructor
   * @param {string} selector - タイムテーブルを描画する要素のCSSセレクタ
   * @param {Object} data - タイムテーブル用のデータ
   * @param {Object} opt - オプションを指定するオブジェクト
   * @returns {void}
   */
  constructor(selector,data,opt){
    // オプションの既定値設定
    this.opt = mergeDeeply({
      datatype: null, // dataが加工済ならnull
      unit: 5,
      design: {
        default: {
          color: "#000",
          backgroundColor: "rgba(196,196,196,0.6)",
          border: "solid 1px #aaa",
        },
        critical: {
          color: "#fff",
          backgroundColor: "rgba(255,96,96,0.6)",
          border: "solid 1px #f00",
        },
      },
    },opt);
    console.log(this.opt);
    this.tasks = this.opt.datatype === null ? data : this.#process(data);
    console.log(this.tasks);
  }

  #process(raw){
    const v = {sheet:[{children:[]}],idmap:{0:0}};
    console.log('process start.');

    this.tasks = [];
    // [01] configシート
    this.opt.sheetDef = {};
    v.header = raw.config[0]; // ヘッダ行
    for( v.i=1 ; v.i<raw.config.length ; v.i++ ){
      v.l = raw.config[v.i];
      if( String(v.l[0]).length > 0 ){ // 空白行スキップ
        v.o = {};
        for( v.j=2 ; v.j<v.l.length ; v.j++ ){
          v.o[v.header[v.j]] = v.l[v.j];
        }
        if( !(v.l[0] in this.opt.sheetDef) ){
          // シートのオブジェクトが未定義なら追加
          this.opt.sheetDef[v.l[0]] = {};
        }
        this.opt.sheetDef[v.l[0]][v.l[1]] = v.o;
      }
    }
    console.log(this.opt.sheetDef);

    // [02] timetableシート
    v.header = raw.timetable[0]; // ヘッダ行
    v.idmapIndex = 0; // v.idmapの添字
    console.log(v.header)
    // 1. v.sheetにリニアに追加する
    for( v.i=1 ; v.i<raw.timetable.length ; v.i++ ){
      v.l = raw.timetable[v.i];
      // 有効な行データをオブジェクト化する
      if( Number(v.l[0]) > 0 ){ // 空白行スキップ
        v.o = {};
        for( v.j=0 ; v.j<v.l.length ; v.j++ ){
          v.colType = this.opt.sheetDef.timetable[v.header[v.j]].type.toLowerCase();
          switch( v.colType ){
            case 'Date':
              v.o[v.header[v.j]] = new Date(v.l[v.j]).getTime();
              break;
            default:
              v.o[v.header[v.j]] = v.l[v.j];
          }
        }
        v.sheet.push(v.o);
        v.idmapIndex++;
        v.idmap[v.o.id] = v.idmapIndex;        
      }
    }
    console.log(v.sheet);
    console.log(v.idmap);

    // 2.親子関係を設定
    for( v.i=1 ; v.i<v.sheet.length ; v.i++ ){ // 0はrootなので飛ばす
      //console.log('v.sheet[v.i]=',v.sheet[v.i])
      //console.log('v.sheet[v.i].pId='+v.sheet[v.i].pId);
      //console.log('v.idmap[v.sheet[v.i].pId]='+v.idmap[v.sheet[v.i].pId]);
      //console.log('v.sheet['+v.idmap[v.sheet[v.i].pId]+']=',v.sheet[v.idmap[v.sheet[v.i].pId]]);
      v.parent = v.sheet[v.idmap[v.sheet[v.i].pId]];
      if( !('children' in v.parent) ) v.parent.children = [];
      v.parent.children.push(v.sheet[v.i]);
      console.log('v.sheet['+v.i+']=',v.sheet[v.i],'\nv.parent=',v.parent);
    }
    console.log(v.sheet);

    // [03] resourcesシート
    v.header = raw.resources[0];  // ヘッダ行
    for( v.i=1 ; v.i<raw.resources.length ; v.i++ ){
      v.o = {};
      for( v.j=0 ; v.j<v.header.length ; v.j++ ){
        v.o[v.header[v.j]] = raw.resources[v.i][v.j];
      }
      console.log('v.o=',v.o);
      console.log('v.idmap[v.o.tId]=',v.idmap[v.o.tId]);
      console.log('v.sheet[v.idmap[v.o.tId]]=',v.sheet[v.idmap[v.o.tId]]);
      v.parent = v.sheet[v.idmap[v.o.tId]];
      if( !('resources' in v.parent) ) v.parent.resources = [];
      v.parent.resources.push(v.o);
    }

    //this.tasks = v.sheet[0].children;
    for( v.i=0 ; v.i<v.sheet.length ; v.i++ ){
      if( v.sheet[v.i].pId == 0 ){
        // 第一階層のタスクはthis.tasksに追加
        this.tasks.push(v.sheet[v.i]);
      }
    }
    console.log(this.tasks);

    console.log('process end.');
  }
}

</script>

<!--================================================
  テスト
================================================-->
<script type="text/javascript" class="test">
</script>

<!--================================================
  メイン処理
================================================-->
<script type="text/javascript" class="main">
window.addEventListener('DOMContentLoaded',() => {
  console.log('timetable test start.');
  fetch("https://script.google.com/macros/s/AKfycbxNJm9X2Dse9brDmCWFTsg9WoQ6vyE8QXYcUPUq8aXELXP7RRbmz5gepaqU25ZvOGx3/exec")
  .then(response => response.json()).then(r => {
    const v = {raw:r};
    const tt01 = new TimeTable('tt01',v.raw,{datatype:'sheet'});
});
});
</script>
</body>
</html>