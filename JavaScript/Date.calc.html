<!DOCTYPE html><html lang="ja">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <meta http-equiv="Content-Script-Type" content="text/javascript">
  <title>Date.calc</title>
</head>
<body>
  <p>Webアプリは無し。</p>
  <p>テストは開発者コンソールでおよび以下で確認。</p>
  <textarea rows="10" cols="40"></textarea>
</body>
<!--================================================
  Date.calc コアスクリプト

  参考：novace/src/lib/ena.js - class DateEx
  file:///Users/ena.kaon/Desktop/GitHub/novace/README.md
================================================-->
<script src="../lib/jsLib.js">/* use: whichType */</script>
<script type="text/javascript" class="core">
/**
 * @typedef {object} DateCalcArg
 * @prop {number} [y] - 年
 * @prop {number} [M] - 月
 * @prop {number} [d] - 日
 * @prop {number} [h] - 時
 * @prop {number} [m] - 分
 * @prop {number} [s] - 秒
 * @prop {number} [n] - ミリ秒
 */

/** 指定日に年/月/日/時/分/秒/ミリ秒数を加減した日時を計算する"calc()"メソッドをDate型に追加する。
 * @param {string|number[]|DateCalcArg} arg - 加減する年/月/日/時/分/秒/ミリ秒数の指定
 * @returns {string} 加減したDateオブジェクト(新規、非破壊)。無効な指定ならNull
 * 
 * arg = string -> "+1M"(1ヶ月後)のように、加減する値＋単位で指定
 * arg = number[] -> [年,月,日,時,分,秒,ミリ秒]で複数単位での加減を一括指定
 * arg = DateCalcArg -> 単位を指定した複数単位での加減。例：1時間10分後なら{h:1,m:10}
 * 
 * @example
 * ```
 * base: 2001/01/01 00:00:00.000
 * "+3y" ⇒ 2004/01/01 00:00:00.000
 * "2M" ⇒ 2001/03/01 00:00:00.000
 * "1d" ⇒ 2001/01/02 00:00:00.000
 * "-1h" ⇒ 2000/12/31 23:00:00.000
 * "-2m" ⇒ 2000/12/31 23:58:00.000
 * "-3s" ⇒ 2000/12/31 23:59:57.000
 * "-4n" ⇒ 2000/12/31 23:59:59.996
 * [3,2,1,-1,-2,-3,-4] ⇒ 2004/03/01 22:57:56.996
 * [3,2,1] ⇒ 2004/03/02 00:00:00.000
 * {"y":3,"M":2,"d":1} ⇒ 2004/03/02 00:00:00.000
 * ```
 */

function Date_calc(arg){
  console.log('===== Date.calc start.');
  const v = {rv:null,
    diff:{y:0,M:0,d:0,h:0,m:0,s:0,n:0},
    seq:['y','M','d','h','m','s','n']
  };
  try {

    // 加減する値を計算
    switch( whichType(arg) ){
      case 'String':
        v.m = arg.match(/^([+-]?[0-9]+)([yMdhmsn])$/);
        if( !v.m ) throw new Error('加減する値の指定が不適切です');
        v.diff[v.m[2]] = Number(v.m[1]);
        break;
      case 'Array' :
        for( v.i=0 ; v.i<arg.length ; v.i++ ){
          v.diff[v.seq[v.i]] = arg[v.i];
        }
        break;
      case 'Object' :
        for( v.x in arg ){
          v.diff[v.x] = arg[v.x];
        }
        break;
      default:
        throw new Error('Date.calc()の引数の型が不適切です');
    }
    //console.log(v);

    v.rv = new Date(
      this.getFullYear() + v.diff.y,
      this.getMonth() + v.diff.M,
      this.getDate() + v.diff.d,
      this.getHours() + v.diff.h,
      this.getMinutes() + v.diff.m,
      this.getSeconds() + v.diff.s,
      this.getMilliseconds() + v.diff.n
    );

    //console.log('v.rv='+JSON.stringify(v.rv));
    console.log('===== Date.calc end.');
    return v.rv;
  } catch(e){
    // ブラウザで実行する場合はアラート表示
    if( typeof window !== 'undefined' ) alert(e.stack); 
    //throw e; //以降の処理を全て停止
    v.rv.stack = e.stack; return v.rv; // 処理継続
  }
}
Date.prototype.calc = Date_calc;
</script>

<!--================================================
  テスト関係(仕様書、スクリプト)
================================================-->
<script type="text/javascript" class="test">
function calcTest(){
  const v = {
    d: new Date(2001,0,1,0,0,0,0),
    data: [
      '+3y','2M','1d','-1h','-2m','-3s','-4n',
      [3,2,1,-1,-2,-3,-4],
      [3,2,1],
      {y:+3,M:2,d:1},
    ],
    result: '',
  };
  v.result = 'base: ' + v.d.toLocale('yyyy/MM/dd hh:mm:ss.nnn');

  //console.log(v.d.calc());  // 引数無し -> 正常にエラーとして処理
  v.data.forEach(x => {
    v.r = v.d.calc(x).toLocale('yyyy/MM/dd hh:mm:ss.nnn');
    console.log(x,v.r);
    v.result += '\n' + JSON.stringify(x) + ' ⇒ ' + v.r;
  })
  document.querySelector('textarea').value = v.result;
}
</script>

<!--================================================
  メイン処理
================================================-->
<script type="text/javascript" class="main">
window.addEventListener('DOMContentLoaded',() => {
  calcTest();  // テスト実行
});
</script>
</html>