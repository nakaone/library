<!DOCTYPE html><html lang="ja">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <meta http-equiv="Content-Script-Type" content="text/javascript">
  <title>textContent</title>
  <!--================================================
    スタイルシート
  ================================================-->
  <link rel="stylesheet" href="../CSS/szDefault.css" />
  <style type="text/css" class="page">  /* textContent特有CSS */
  </style>
</head>
<body>
  <!--================================================
    HTML
  ================================================-->
  <div class="webApp">  <!-- textContent Webアプリ表示画面 -->
    <h1>textContent</h1>
    <div>CSS selector:<br><input type="text" name="selector" onchange="webApp()" /></div>
    <div>html:<br><textarea name="html" onchange="webApp()"></textarea></div>
    <div>result:<br><textarea name="result"></textarea></div>
  </div>
</body>
<!--================================================
  外部スクリプト
================================================-->
<script src="../lib/jsLib.js"></script>
<!-- MarkDownテキストをHTML化するCDN -->
<script src="https://taisukef.github.io/marked_md/marked.min.js"></script>
<!-- バッチ処理で読み込んだ内容をDOM化
  [Node.jsのサーバサイドでDOMを使う](https://moewe-net.com/nodejs/jsdom) -->
<script src="https://cdn.jsdelivr.net/npm/jsdom@22.1.0/lib/jsdom/browser/Window.min.js"></script>

<!--================================================
  textContent コアスクリプト
================================================-->
<script type="text/javascript" class="core">

/** textContent: HTMLの指定CSSセレクタの内容を抽出
 * @param {string} content - エレメント(HTML)の全ソース
 * @param {string[]} selectors - 抽出対象となるCSSセレクタ
 * @returns {string} 抽出された指定CSSセレクタ内のテキスト
 */

function textContent(content,sections){
  console.log('===== textContent start.');
  const v = {rv:'',
    sections: [],
    extract: (document,selector) => {
      console.log('----- extract start.');
      let rv = '';
      v.elements = document.querySelectorAll(selector);
      v.elements.forEach(element => rv+=String(element.innerHTML).trim()+'\n');
      //console.log('rv='+rv);
      console.log('----- extract end.');
      return rv;
    }
  };
  try {

    // 指定CSSセレクタが単一なら配列化
    v.sections = typeof sections === 'string' ? [sections] : sections;

    if( typeof window === 'undefined' ){
      const { JSDOM } = require("jsdom");
      const { document } = new JSDOM(content).window;
      v.sections.forEach(x => {
        v.r = v.extract(document,x);
        if( v.r.hasOwnProperty('stack') ) throw v.r;
        v.rv += v.r;
      });
    } else {
      v.source = document.createElement('div');
      v.source.innerHTML = content;
      v.sections.forEach(x => {
        v.r = v.extract(v.source,x);
        if( v.r.hasOwnProperty('stack') ) throw v.r;
        v.rv += v.r;
      });
    }

    console.log('v.rv='+v.rv);
    console.log('===== textContent end.');
    return v.rv;
  } catch(e){
    // ブラウザで実行する場合はアラート表示
    if( typeof window !== 'undefined' ) alert(e.stack);
    console.error(e.stack);
    //throw e; //以降の処理を全て停止
    v.rv.stack = e.stack; return v.rv; // 処理継続
  }
}
</script>

<!--================================================
  メイン処理
================================================-->
<script type="text/javascript" class="main">
const v = {};
if( typeof window === 'undefined' ){
  // コンソール(Node.js)で実行する場合の処理

  // 事前処理：引数チェック、既定値の設定
  v.argv = analyzeArg();
  if(v.argv.hasOwnProperty('stack')) throw v.argv;

  // ファイルの読み込み、textContentの呼び出し
  v.fs = require('fs');
  v.content = v.fs.readFileSync(v.argv.opt.i,'utf-8');
  v.rv = textContent(v.content,v.argv.val);
  if( v.rv.hasOwnProperty('stack') ) throw v.rv;  // debug

  // 結果の書き出し
  v.content = v.fs.writeFileSync(v.argv.opt.o,v.rv,'utf-8');  

} else {
  // Webアプリとして動作する場合の処理

  window.addEventListener('DOMContentLoaded',() => {

    // HTML欄に入力されたテキストからMarkdownを作成
    v.selector = String(document.querySelector('input[name="selector"]').value).trim();
    v.html = String(document.querySelector('textarea[name="html"]').value).trim();
    if( v.selector.length > 0 && v.html.length > 0 ){
      v.md = textContent(v.html,v.selector);
      if( v.md.hasOwnProperty('stack') ) throw v.md;
      document.querySelector('textarea[name="result"]').value = v.md;
    }

  });
}
</script>
</html>