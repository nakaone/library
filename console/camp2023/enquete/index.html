<!DOCTYPE html><html xml:lang="ja" lang="ja"><head>
<title>アンケート集計結果</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!--link href="../szLib.css" rel="stylesheet" /-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/alasql/4.1.9/alasql.min.js" integrity="sha512-IzHzpfkI8XohefrAjzVVXmvPS84vIe9VtcXq1JPK9nkgcB9/mjs41T0QaAiTlHRk49Si3ydIf2i82D/f4FSoGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1"></script>
<style type="text/css">
th, .th {
  padding: 0.3em;
  background-color: #888;
  color: white;
  text-align: left;
}
td, .td {
  padding: 0.3em;
  border-bottom: solid 1px #aaa;
  border-right: solid 1px #aaa;
  text-align: right;
}
table[name="summary"] th {
  width: 5rem;
}
</style>
</head><body>

</body>
<script type="text/javascript">
window.addEventListener('DOMContentLoaded',() => {
  const v = {
    whois: 'DOMContentLoaded',step:0,ans:[],free:[],
    url: 'https://script.google.com/macros/s/AKfycbwGNl_1fFlU0srOzHpM1o0zyUk4IlIv3WGgdU-FMcXSAlDaYV70cDNbMU2wjIYHqKk/exec',
    questions:[
      //{name:'n00',label:'回答日時',question:'タイムスタンプ',opt:{}},
      {name:'n01',label:'宿泊',question:'Q1.各イベントの評価は？ [テント、宿泊]',
        opt:{'楽しかった':5,'少し楽しかった':4,'普通':3,'あまり楽しくなかった':2,'楽しくなかった':1}},
      {name:'n02',label:'待機時間',question:'Q1.各イベントの評価は？ [(テント設営中の)待機時間]',opt:{'楽しかった':5,'少し楽しかった':4,'普通':3,'あまり楽しくなかった':2,'楽しくなかった':1}},
      {name:'n03',label:'カレー',question:'Q1.各イベントの評価は？ [カレー]',opt:{'楽しかった':5,'少し楽しかった':4,'普通':3,'あまり楽しくなかった':2,'楽しくなかった':1}},
      {name:'n04',label:'校内探検',question:'Q1.各イベントの評価は？ [校内探検]',opt:{'楽しかった':5,'少し楽しかった':4,'普通':3,'あまり楽しくなかった':2,'楽しくなかった':1}},
      {name:'n05',label:'ラジオ体操',question:'Q1.各イベントの評価は？ [ラジオ体操]',opt:{'楽しかった':5,'少し楽しかった':4,'普通':3,'あまり楽しくなかった':2,'楽しくなかった':1}},
      {name:'n06',label:'朝食',question:'Q1.各イベントの評価は？ [朝食]',opt:{'楽しかった':5,'少し楽しかった':4,'普通':3,'あまり楽しくなかった':2,'楽しくなかった':1}},
      {name:'n07',label:'宿泊形態',question:'Q2.テント・宿泊はどうされましたか？',
        opt:{'テントで宿泊':3,'体育館で宿泊':2,'日帰り参加':1}},
      {name:'n08',label:'募集パンフ',question:'Q3.イベント運営の評価はいかがですか？ [募集チラシ(紙媒体)]',opt:{'非常に良い':5,'良い':4,'普通':3,'悪い':2,'非常に悪い':1}},
      {name:'n09',label:'案内サイト',question:'Q3.イベント運営の評価はいかがですか？ [案内サイト(Web)]',opt:{'非常に良い':5,'良い':4,'普通':3,'悪い':2,'非常に悪い':1}},
      {name:'n10',label:'応募フォーム',question:'Q3.イベント運営の評価はいかがですか？ [応募フォーム(Web)]',opt:{'非常に良い':5,'良い':4,'普通':3,'悪い':2,'非常に悪い':1}},
      {name:'n11',label:'当落通知',question:'Q3.イベント運営の評価はいかがですか？ [メールでの当落通知]',opt:{'非常に良い':5,'良い':4,'普通':3,'悪い':2,'非常に悪い':1}},
      {name:'n12',label:'受付',question:'Q3.イベント運営の評価はいかがですか？ [(スマホでの)受付]',opt:{'非常に良い':5,'良い':4,'普通':3,'悪い':2,'非常に悪い':1}},
      {name:'n13',label:'情報配信',question:'Q3.イベント運営の評価はいかがですか？ [スマホへの情報配信]',opt:{'非常に良い':5,'良い':4,'普通':3,'悪い':2,'非常に悪い':1}},
      {name:'n14',label:'混雑状況',question:'Q3.イベント運営の評価はいかがですか？ [参加者数、混雑状況]',opt:{'非常に良い':5,'良い':4,'普通':3,'悪い':2,'非常に悪い':1}},
      {name:'n15',label:'宿泊',question:'Q3.イベント運営の評価はいかがですか？ [宿泊関係]',opt:{'非常に良い':5,'良い':4,'普通':3,'悪い':2,'非常に悪い':1}},
      {name:'n16',label:'来年度以降',question:'Q4.来年以降も継続すべきですか？',opt:{'①このまま継続':1,'②細かい点の改善を行った上で継続':2,'③大幅な改善・強化を行った上で継続':3,'④中止すべき':4,'⑤分からない':5}},
      //{name:'n17',label:'自由記入欄',question:'Q5.その他、全体を通じてご意見・ご指摘があればお願いします。',opt:{}},
    ],
  };
  console.log(v.whois+' start.');
  try {

    v.step = 1; // シートからデータを取得
    fetch(v.url).then(r => r.json()).then(raw => {
      // データ形式を変換、v.ansに格納
      for( v.i=0 ; v.i<raw.data.length ; v.i++ ){
        // 選択式設問以外は初期値で設定
        v.o = {
          '回答日時':new Date(raw.data[v.i]['タイムスタンプ']),
          '自由記入欄':raw.data[v.i]['Q5.その他、全体を通じてご意見・ご指摘があればお願いします。'].trim(),
        };
        // 選択式設問
        for( v.j=0 ; v.j<v.questions.length ; v.j++ ){
          v.a = raw.data[v.i][v.questions[v.j].question];
          v.o[v.questions[v.j].label] = v.a.length === 0 ? null : v.questions[v.j].opt[v.a];
        }
        v.ans.push(v.o);
      }
      console.log('v.ans',v.ans);

      // 設問ごとに集計
      for( v.i=0 ; v.i<v.questions.length ; v.i++ ){
        drawPage(v.questions[v.i],v.ans);
        console.log(v.questions[v.i])
        //draw(v.questions[v.i]);
      }

      // 全体通じた集計
    });


    //console.log("%s step.%s\n",v.whois,v.step,this);

    //console.log(v.whois+' normal end.\n',v.rv);
    //return v.rv;

  } catch(e){
    console.error(v.whois+' abnormal end(step.'+v.step+').',e,v);
    return e;
  }
});


/**
 * - alasql: [Looking for various statistical operations](https://github.com/AlaSQL/alasql/issues/521)
 */
const drawPage = (q,a) => {
  const v = {whois:'drawPage',rv:q,step:0,
    palette:[
      '54, 162, 235', // 青
      '75, 192, 192', // 緑
      '255, 205, 86', // 黄
      '255, 99, 132', // 赤
      '153, 102, 255',  // 紫
      //'255, 159, 64', // 橙
      '201, 203, 207',  // 灰色
    ],
  };
  console.log(v.whois+' start.',q.label,a);
  try {
    v.step = 1; // parent,pageを作成し、タイトルと問題文を追記
    v.parent = document.querySelector('body');
    v.page = createElement({attr:{name:q.name},children:[
      {tag:'h1',text:q.label},
      {attr:{class:'question'},children:[
        {tag:'h2',text:'設問'},
        {tag:'p',text:q.question},
        {tag:'ul'},
      ]},
      {attr:{class:'chart'},children:[
        {tag:'canvas',attr:{name:'all'}},
      ]},
      {attr:{class:'table'},children:[
        {tag:'table',attr:{name:'summary'},children:[
          {tag:'thead',children:[
            {tag:'tr',children:[
              {tag:'th',attr:{colspan:'2',rowspan:'2'},text:''},
              {tag:'th',attr:{colspan:'4'},text:'回答あり'},
              {tag:'th',attr:{rowspan:'2'},text:'無回答'},
            ]},
            {tag:'tr',children:[
              {tag:'th',text:'回答数'},
              {tag:'th',text:'平均値'},
              {tag:'th',text:'中央値'},
              {tag:'th',text:'標準偏差'},
            ]},
          ]},
          {tag:'tbody'},
        ]},
      ]},
      // 所感、見解
      {attr:{class:'desc'}},
      // 自由記入欄の意見
      // スタッフ内部の評価 -> スタッフの評価・課題の分類をこれに合わせる
      // 写真
    ]});

    v.step = 2; // 番号->選択肢ラベルの逆引きをroptとして作成
    q.ropt = [];
    for( v.i in q.opt ){
      q.ropt[Number(q.opt[v.i])] = v.i;
    }

    v.step = 3; // 選択肢を追記
    v.ul = v.page.querySelector('.question ul');
    for( v.i=(q.ropt.length-1) ; v.i>0 ; v.i-- ){
      v.ul.appendChild(createElement({tag:'li',text:q.opt[q.ropt[v.i]]+': '+q.ropt[v.i]}));
    }

    v.step = 4; // マスタを作成(対象となる設問の回答をansとし、無回答を除外)
    v.sql = 'select *,['+q.label+'] as ans'
    + ', case when ['+q.label+']=1 then 1 else 0 end as a1'
    + ', case when ['+q.label+']=2 then 1 else 0 end as a2'
    + ', case when ['+q.label+']=3 then 1 else 0 end as a3'
    + ', case when ['+q.label+']=4 then 1 else 0 end as a4'
    + ', case when ['+q.label+']=5 then 1 else 0 end as a5'
    + ' from ?';
    v.master = alasql(v.sql,[a]);

    [
      {label:[{tag:'th',attr:{rowspan:'3'},text:'宿泊'},
        {tag:'th',text:'テント[a]'}],cond:'[宿泊形態]=3'},
      {label:{tag:'th',text:'体育館[b]'},cond:'[宿泊形態]=2'},
      {label:{tag:'th',text:'宿泊計[c=a+b]'},cond:'[宿泊形態]>1'},
      {label:{tag:'th',attr:{colspan:'2'},text:'日帰り[d]'},cond:'[宿泊形態]=1'},
      {label:{tag:'th',attr:{colspan:'2'},text:'参加形態判明[e=c+d]'},cond:'[宿泊形態] is not null'},
      {label:{tag:'th',attr:{colspan:'2'},text:'参加形態不明[f]'},cond:'[宿泊形態] is null'},
      {label:{tag:'th',attr:{colspan:'2'},text:'全体[e+f]'},cond:''},
    ].forEach(x => {
      v.step = 5; // 平均値、中央値、標準偏差、選択肢ごとの数
      v.t1 = alasql('select count(*) as cn' // 回答数
      + ', avg(ans) as av' // 平均
      + ', median(ans) as md'  // 中央値
      + ', STDEV(ans) as se'     // 標準偏差(standard deviation)。√(Σ(数値-平均)^2/n)
      + ' from ?'
      + (x.cond.length === 0 ? '' : ' where ' + x.cond)
      ,[v.master])[0];
      // 無回答
      v.t2 = alasql('select count(*) as noans from ?'
      + ' where ['+q.label+'] is null'
      + (x.cond.length === 0 ? '' : ' and ' + x.cond)
      ,[a])[0];
      v.tr = createElement({tag:'tr'});
      createElement(x.label,v.tr);
      //v.tr.appendChild(createElement(x.label));
      createElement([
        {tag:'td',text:v.t1.cn},  // 回答数
        {tag:'td',text:(Math.round(v.t1.av*10000)/10000).toFixed(4)},  // 平均値
        {tag:'td',text:v.t1.md},  // 中央値
        {tag:'td',text:(Math.round(v.t1.se*10000)/10000).toFixed(4)},  // 標準偏差
        {tag:'td',text:v.t2.noans}, // 無回答
      ],v.tr);
      v.page.querySelector('tbody').appendChild(v.tr);
    });


    v.t3 = alasql('select ans'
    + ', case when [宿泊形態]=3 then 1 else 0 end as t'
    + ', case when [宿泊形態]=2 then 1 else 0 end as g'
    + ', case when [宿泊形態]=1 then 1 else 0 end as d'
    + ', case when [宿泊形態] is null then 1 else 0 end as u'
    + ' from ?'
    ,[v.master]);
    console.log('v.t3',v.t3);

    v.data = {
      labels: ['テント泊','体育館泊','日帰り','不明'],
      datasets: [],
    }
    for( v.i=q.ropt.length-1 ; v.i>0 ; v.i-- ){
      v.t4 = alasql('select'
      + ' ' + v.i + ' as ans'
      + ', sum(t) as tent'
      + ', sum(g) as gym'
      + ', sum(d) as dayuse'
      + ', sum(u) as unknown'
      + ' from ?'
      + ' where ans=' + v.i
      ,[v.t3])[0];
      console.log('v.t4',v.i,v.t4);

      v.sum = v.t4.tent + v.t4.gym + v.t4.dayuse + v.t4.unknown;
      v.data.datasets.push({
        label: q.ropt[v.i],
        data:[v.t4.tent/v.sum,v.t4.gym/v.sum,v.t4.dayuse/v.sum,v.t4.unknown/v.sum],
        borderColor: 'rgba('+v.palette[v.i]+', 0.8)',
        borderWidth: 1,
        backgroundColor:'rgba('+v.palette[v.i]+', 0.2)',
      });
    }

    new Chart(v.page.querySelector('.chart canvas[name="all"]').getContext('2d'),{
      type: 'bar',
      data: v.data,
      options: {
        indexAxis: 'y',
        //plugins: {title: {display: true,text: 'Chart.js Bar Chart - Stacked'}},
        responsive: true,
        scales: {x:{stacked: true},y:{stacked: true}},
      }        
    });


    /*
    // 全体グラフ
    v.data = {
      labels: ['全体','テント'],
      datasets: [
        {label:'楽しかった',data:[10,20], // [テント,体育館,日帰り,不明]
          borderColor: 'rgba('+v.palette[0]+', 0.8)',
          borderWidth: 1,
          backgroundColor:'rgba('+v.palette[0]+', 0.2)'},
        {label:'少し楽しかった',data:[20,10],
          borderColor: 'rgba('+v.palette[1]+', 0.8)',
          borderWidth: 1,
          backgroundColor:'rgba('+v.palette[1]+', 0.2)'},
        {label:'普通',data:[10,20],
          borderColor: 'rgba('+v.palette[2]+', 0.8)',
          borderWidth: 1,
          backgroundColor:'rgba('+v.palette[2]+', 0.2)'},
        {label:'あまり楽しくなかった',data:[20,10],
          borderColor: 'rgba('+v.palette[3]+', 0.8)',
          borderWidth: 1,
          backgroundColor:'rgba('+v.palette[3]+', 0.2)'},
        {label:'楽しくなかった',data:[10,20],
          borderColor: 'rgba('+v.palette[4]+', 0.8)',
          borderWidth: 1,
          backgroundColor:'rgba('+v.palette[4]+', 0.2)'},
        {label:'無回答',data:[30,20],
          borderColor: 'rgba('+v.palette[5]+', 0.8)',
          borderWidth: 1,
          backgroundColor:'rgba('+v.palette[5]+', 0.2)'},
      ]
    };
    */


    v.step = 99; // 終了処理
    v.parent.appendChild(v.page);
    console.log(v.whois+' normal end.\n',v.rv);
    return v.rv;

  } catch(e){
    console.error(v.whois+' abnormal end(step.'+v.step+').',e,v);
    return e;
  }
}

/** HTMLElementを生成する
 * @param {}
 * @param {HTMLElement|string} [parent] - 親要素としてそこに追加する
 */
function createElement(arg,parent=null){
  const v = {whois:'createElement',rv:[],step:0,isArr:Array.isArray(arg)};
  console.log(v.whois+' start.',arg);
  try {
    v.step = 1.1; // 引数を強制的に配列化
    if( !v.isArr ) arg = [arg];
    v.step = 1.2; // 親要素の特定
    if( parent !== null ){
      v.parent = typeof parent === 'string' ? document.querySelector(parent) : parent;
    }


    for( v.i = 0 ; v.i<arg.length ; v.i++ ){
      v.step = 2; // 既定値の設定
      v.def = {tag: 'div',attr: {},style:{},event:{},text: '',html:'',children:[]};
      Object.assign(v.def,(typeof arg[v.i] === 'string' ? {tag:arg} : arg[v.i]))

      v.step = 3; // HTMLElementを生成、v.objとする
      v.obj = document.createElement(v.def.tag);

      v.step = 4; // HTMLElementの属性を定義
      for( v.j in v.def.attr ){
        v.obj.setAttribute(v.j,v.x = v.def.attr[v.j]);
      }

      v.step = 5; // 論理属性を定義(ex.checked)
      for( v.j in v.def.logical ){
        if( v.def.logical[v.j] ){
          v.obj.setAttribute(v.j,true);
        }
      }

      v.step = 6; // style属性の定義
      for( v.j in v.def.style ){
        if( v.j.match(/^\-\-/) ){ // CSS変数
          v.obj.style.setProperty(v.j,v.def.style[v.j]);
        } else {
          v.obj.style[v.j] = v.def.style[v.j];
        }
      }

      v.step = 7; // イベントの定義
      for( v.j in v.def.event ){
        v.obj.addEventListener(v.j,v.def.event[v.j],false);
      }

      v.step = 8; // 内部文字列(html or text)
      if( v.def.html.length > 0 ){
        v.obj.innerHTML = v.def.html;
      } else {
        v.obj.innerText = v.def.text;
      }

      v.step = 9; // 子要素の追加(parentは指定しない)
      for( v.j=0 ; v.j<v.def.children.length ; v.j++ ){
        v.obj.appendChild(createElement(v.def.children[v.j]));
      }

      v.step = 10; // 戻り値への登録
      v.rv.push(v.obj);

      v.step = 11; // 親要素への追加
      if( parent !== null ){
        v.parent.appendChild(v.obj);
      }
    }

    v.step = 12; // 配列で渡されたら配列で、オブジェクトならオブジェクトを返す
    v.rv = v.isArr ? v.rv : v.rv[0];
    console.log(v.whois+' normal end.\n',v.rv);
    return v.rv;

  } catch(e){
    console.error(v.whois+' abnormal end(step.'+v.step+').',e,v);
    return e;
  }
}
</script>
</html>