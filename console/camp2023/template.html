<!DOCTYPE html><html xml:lang="ja" lang="ja"><head>
  <title>校庭キャンプ2023</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <!-- link rel="stylesheet" type="text/css" href="../../component/szLib.css" -->
  <style type="text/css" data-embed="../../component/szLib.css"></style>
  <style type="text/css" data-embed="../../component/loading.css"></style>

  <style type="text/css">
    .img {
      width: 100%;
      overflow: scroll;
    }
    .PlantUML {
      overflow-x: auto;
    }
    .BurgerMenu[name="main"] {
      margin-top: 1rem; /* 最上位メニューの上に余白設定 */
    }
    .BurgerMenu .page {
      padding: 1rem;
      width: calc(100% - 2rem);
      height: calc(100% - 2rem);
    }
    [data-BurgerMenu] {
      padding: 1rem;
      width: calc(100% - 2rem);
    }
  </style>
</head>
<body>
  <div name="loading"><div><div class="loading5">loading...</div></div></div>

  <div data-BurgerMenu="label:'お知らせ'">
    <div data-BurgerMenu="label:'掲示板'">
      <div class="page">
        <div name="board"></div>
      </div>
    </div>
    <div data-BurgerMenu="label:'注意事項'" class="markdown" data-embed="注意事項.md"></div>
    <div data-BurgerMenu="label:'持ち物'" class="markdown" data-embed="持ち物リスト.md"></div>
  </div>
  <div data-BurgerMenu="label:'パスポート'"></div>

</body>
<!-- =====================================================
  CDN
===================================================== -->
<!-- UML: PlantUML
  参考：JavaScriptを用いてPlantUMLを呼び出す
  https://168iroha.net/blog/topic/?id=202206081036&sorting=post_date
-->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/plantuml-encoder@1.4.0/dist/plantuml-encoder.min.js"></script>

<!-- MarkDownテキストをHTML化するCDN -->
<script src="https://taisukef.github.io/marked_md/marked.min.js"></script>

<!-- 共通鍵暗号化：cryptoJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/enc-base64.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/cipher-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/sha256.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/sha1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/aes.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/hmac.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/pbkdf2.min.js"></script>

<!-- cryptico -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cryptico/0.0.1343522940/cryptico.min.js" integrity="sha512-C7GGRhFRn7F7hsLH1oCH2kX9ls61kx33wAgTZ6xJDwGvvgULcIZpwKqxG1+Kj/KOD2jWPxjNQYHi4BopPJPxVA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<!-- mermaid -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.2.4/dist/mermaid.min.js"></script>
<!-- QRコード検出/生成 -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- =====================================================
  自作ライブラリ
===================================================== -->
<script type="text/javascript" data-embed='{"from":{"filename":"../../component/Auth.html","selector":"script.core"},"to":"js"}'></script>
<script type="text/javascript" data-embed='{"from":{"filename":"../../component/Array.tabulize.html","selector":"script.core"},"to":"js"}'></script>
<script type="text/javascript" data-embed='../../component/BulletinBoard/core.js'></script>
<script type="text/javascript" data-embed='../../component/BurgerMenu/core.js'></script>
<script type="text/javascript" data-embed='{"from":{"filename":"../../component/createElement.html","selector":"script.core"},"to":"js"}'></script>
<script type="text/javascript" data-embed='{"from":{"filename":"../../component/createPassword.html","selector":"script.core"},"to":"js"}'></script>
<script type="text/javascript" data-embed='{"from":{"filename":"../../component/cryptoAES.html","selector":"script.core"},"to":"js"}'></script>
<script type="text/javascript" data-embed='{"from":{"filename":"../../component/Date.toLocale.html","selector":"script.core"},"to":"js"}'></script>
<script type="text/javascript" data-embed='{"from":{"filename":"../../component/mergeDeeply.html","selector":"script.core"},"to":"js"}'></script>
<script type="text/javascript" data-embed='../../component/scanQR/core.js'></script>
<script type="text/javascript" data-embed='../../component/setupInstance/core.js'></script>
<script type="text/javascript" data-embed='../../component/Reception/core.js'></script>
<style type="text/css" data-embed='{"from":{"filename":"../../component/TimeTable.html","selector":"style.core"},"to":"css"}'></style>
<script type="text/javascript" data-embed='{"from":{"filename":"../../component/TimeTable.html","selector":"script.core"},"to":"js"}'></script>
<script type="text/javascript" data-embed='{"from":{"filename":"../../component/webScanner.html","selector":"script.core"},"to":"js"}'></script>
<script type="text/javascript" data-embed='{"from":{"filename":"../../component/whichType.html","selector":"script.core"},"to":"js"}'></script>

<script type="text/javascript" data-embed="camp2023.drawPassport.js"></script>

<script type="text/javascript" class="main">
window.addEventListener('DOMContentLoaded',async () => {
  const v = {whois:'DOMContentLoaded',opt:{},debug:true,
    // 認証局
    gwURL:'https://script.google.com/macros/s/AKfycbwSvy450w3Bu3GhbBlNFGS5bJAHWi91_gEC42tTtWScAkJUjdZ35SncfXi2slktGH9h/exec',
    // 資料集
    docURL:'https://script.google.com/macros/s/AKfycbxtxS_u1BVahosczLxtt9yFS8Lh97lXEj4t7xmzCp4v1qgDft4RaSZUrbv-cMR0k03I/exec',
    docSheet: 'https://tinyurl.com/2ahyly3l',
    searchParams: new URLSearchParams(window.location.search),
  };
  try {

    console.log(v.whois+' start.');

    v.step = '1'; // 認証
    v.ls = localStorage.getItem('conf');
    // クエリ文字列のデバッグモード指定を確認
    if( v.searchParams.has('debug') ){
      v.debug = v.searchParams.get('debug').toLowerCase() === 'true';
    }
    if( v.debug && v.ls !== null ){
      v.step = '1.1';
      // デバッグ用：リリース時はlocalStorage.setItemと併せて削除
      v.opt = JSON.parse(v.ls);
      v.config = new Auth(v.gwURL,v.opt);
    } else {
      v.step = '1.2';
      // クエリ文字列で受付番号が与えられた場合、受付番号欄にセット
      if( v.searchParams.has('id') ){
        v.opt.entryNo = {value:v.searchParams.get('id')};
      }
      v.config = new Auth(v.gwURL,v.opt);
      if( v.config instanceof Error ) throw v.config;
      await v.config.build();
      localStorage.setItem('conf',JSON.stringify(v.config));
    }
    console.log(v.whois+'.'+v.step+':',v.config);

    v.step = '1.3'; // MarkDownで記述された部分をHTML化して表示
    document.querySelectorAll('div.markdown').forEach(x => {
      x.innerHTML = marked(x.innerHTML);
    });

    v.step = '1.4'; // PlantUMLで記述された部分をHTML化して表示
    document.querySelectorAll('div.PlantUML').forEach(x => {
      let src = x.querySelector('div').innerHTML;
      x.querySelector('img').src = "http://www.plantuml.com/plantuml/svg/"
        + plantumlEncoder.encode(src);
    });

    v.step = '1.5'; // Mermaidで記述された部分をHTML化して表示
    mermaid.initialize({startOnLoad: true});

    v.step = '2'; // メニューを定義
    v.menu = new BurgerMenu({
      authority: v.config.info.authority,
      home: 'c1005',  // パスポート画面をホームに設定(暫定)
    });
    if( v.menu instanceof Error ) throw v.menu;
    console.log(v.whois+'.'+v.step+':',v);

    v.step = 3; // 掲示板の表示
    v.board = new BulletinBoard({
      auth: v.config, // 認証局他のAuthインスタンス
      parent: {selector:'[data-BurgerMenu="label:\'掲示板\'"]'},
    });
    if( v.board instanceof Error ) throw v.board;
    v.rv = await v.board.delivery();
    if( v.rv instanceof Error ) throw v.rv;
  
    v.step = '6'; // パスポートの内容描画
    drawPassport('div[data-BurgerMenu="label:\'パスポート\'"]',v.config);


    /*
    v.step = '7'; // Google Spreadからデータを取得してタイムテーブル表示
    v.res = await fetch(v.docURL);
    v.res = await v.res.json();
    v.TimeTable = new TimeTable(
      'div.TimeTable',
      v.res,
      {datatype:'sheet',dataSheet:v.docSheet}
    );
    if( v.TimeTable instanceof Error ) throw v.TimeTable;

    v.step = '8'; // 受付画面を準備
    v.reception = new Reception({
      auth: v.config, // 認証局他のAuthインスタンス
      area:{selector:'[name="受付"] .page'},  // 受付画面表示エリアのCSSセレクタ
      boot:{selector:'[name="受付"]'}, // スキャナ起動のトリガーとなる要素のCSSセレクタ
      loading: {selector:'div[name="loading"]'},  // ローディング画面のCSSセレクタ
    });

    v.step = '10'; // 最終処理：権限により表示画面制御
    // 最終段階以前で不要な要素を削除すると「要素が見つからない」エラーが発生
    // ⇒ 最終段階で実行する
    v.authority = Number(v.config.info.authority)
    if( (v.authority & 3) === 0 ){
      v.step = '9.1'; // 1(参加者)、2(スタッフ)、3(管理者)いずれでもない
      alert('参加資格を確認してください');
      document.querySelectorAll('body > div').forEach(x => x.remove());
      return;
    } else {
      if( (v.authority & 2) === 0 ){
        v.step = '9.2'; // スタッフではない ⇒ スタッフ画面を削除
        document.querySelectorAll('div[name="スタッフ"]')
        .forEach(x => x.remove());
        // タブの数を減らす
        document.querySelector('.BurgerMenu[name="main"] .tabs')
        .style.gridTemplateColumns = 'repeat(4, 1fr)';
      }
      // ローディング画面解除
      document.querySelector('div[name="loading"]').style.display = 'none';
    } 
    */
    // ローディング画面解除
    document.querySelector('div[name="loading"]').style.display = 'none';

    console.log(v.whois+' normal end.');

  } catch(e){
    const msg = v.whois+' abnormal end(step.'+v.step+').\n'+e.message;
    console.error(msg,e.stack,v);
    alert(msg);
  }
});
</script>
</html>