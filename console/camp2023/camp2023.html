<!DOCTYPE html><html xml:lang="ja" lang="ja"><head>
  <title>校庭キャンプ2023</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <!-- UML: PlantUML
    参考：JavaScriptを用いてPlantUMLを呼び出す
    https://168iroha.net/blog/topic/?id=202206081036&sorting=post_date
  -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/plantuml-encoder@1.4.0/dist/plantuml-encoder.min.js"></script>

  <!-- MarkDownテキストをHTML化するCDN -->
  <script src="https://taisukef.github.io/marked_md/marked.min.js"></script>

  <!-- 共通鍵暗号化：cryptoJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/core.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/enc-base64.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/cipher-core.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/sha256.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/sha1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/aes.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/hmac.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/pbkdf2.min.js"></script>

  <!-- cryptico -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cryptico/0.0.1343522940/cryptico.min.js" integrity="sha512-C7GGRhFRn7F7hsLH1oCH2kX9ls61kx33wAgTZ6xJDwGvvgULcIZpwKqxG1+Kj/KOD2jWPxjNQYHi4BopPJPxVA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.2.4/dist/mermaid.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" integrity="sha512-CNgIRecGo7nphbeZ04Sc13ka07paqdeTu0WR1IM4kNcpmBAUSHSQX0FslNhTDadL4O5SAGapGt4FodqL8My0mA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


    <!-- link rel="stylesheet" type="text/css" href="../../component/szLib.css" -->
  <style type="text/css">html {
  font-size: 24pt;
  font:helvetica,arial,freesans,clean,sans-serif;
  line-height: 1.5rem;
  color: black;
  box-sizing: border-box;
}

* {
  margin: 0;
  padding: 0;
  font-size: 1rem;
}
.right, .num {
  text-align: right;
}
/*
  ヘッダ関係
*/
h1,h2,h3,h4,h5,h6 {
  border: 0;
}
h1 {
  font-size: 170%;
  border-top: 4px solid #aaa;
  padding-top: 0.5em;
  margin-top: 1.5em;
}
h2, h3 {
  margin: 1em 0;
}
h2 {
  font-size: 150%;
  margin-top: 1.5em;
  border-bottom: 1px solid #ddd;
  padding-bottom: 0.5em;
}
/*
  テーブル関係
*/
th {
  padding: 0.3em;
  background-color: #888;
  color: white;
}
td {
  padding: 0.3em;
  border-bottom: solid 1px #aaa;
  border-right: solid 1px #aaa;
}
/*
  リスト関係
*/
ul, ol {
  margin: 1em 0 1em 2em;
}
li {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}
/*
  ソース表示
*/
code {
  background-color: #f8f8ff;
  color: #444;
  padding: 0 0.2em;
  border: 1px solid #dedede;
}

pre {
  border: solid 5px #999;
}</style>

  <style type="text/css">
    body > div:not(.TabMenu), div.TabMenu > div {
      padding: 1rem;
    }
    .img {
      width: 80%;
      overflow: scroll;
    }
    .PlantUML {
      overflow-x: auto;
    }
  </style>
</head>
<body class="TabMenu" name="main">

  <div name="パスポート"><div></div></div>

  <div class="TabMenu" name="お知らせ">
    <div name="掲示板">
      <button onclick="redraw()">更新</button>
      ※ 自動更新されません。また更新は3分程度の間隔をあけてください
      <div name="board"></div>
    </div>
    <div name="注意事項" class="markdown">1. 【削除予定】去年はあったが今年は削除するつもりの項目
   - 受付で体温測定を行います。37.5℃以上の発熱がある場合、参加をお断りさせていただきます。
   - 飲食時以外はマスクをご着用ください。
   - 帰宅時は必ず保護者または成年の代理がお迎えください。

1. 応募時の注意
   - 【追加】イベント当日の申込は応募者数の多寡によらず承りかねます
   - 【追加】応募者多数の場合、申込締切時点の応募者を対象に抽選となります(締切以後の応募は抽選の対象外)
   - 【追加】テントの持ち込みは応募時にご連絡ください(抽選時点で持込無しで応募された方が当選後に持込に変更を希望しても、原則として承れません)
   - 【追加】抽選の結果、テント持込希望でも「テント持込無しなら当選」という結果になる場合があります。予めご了承ください

1. 参加者の加除、申込のキャンセル
   - 参加メンバの追加・削除・変更等、登録内容に修正があれば、参加登録内容の確認メールに記載された「回答を編集」から修正してください。
   - 参加をキャンセルする場合、以下のように対応お願いします
     1. 参加登録内容の確認メールに記載された「回答を編集」を選択
     1. 備考欄の内容を「キャンセル」に修正
     1. 登録されているメールアドレスからskt.oyaji@gmail.comへメールを送付
        - 題名：校庭キャンプ2023キャンセル
        - 本文：保護者氏名のみ記載

1. 参加当日
   - 台風等で中止せざるを得ない場合があります。その場合の対応は、本サイト等でご案内させていただきます。
   - 在学生の参加にはなるべく、未就学児の参加には必ず、<del>保護者</del>引率者が同伴ください。
   - 遊具は持ち込みいただけますが、ご使用の際は他の参加者のご迷惑とならないよう、保護者の方でご注意ください。
   - ごみ箱の用意はありません。食べ残し他のごみはお持ち帰りの上、各家庭で処理願います。
   - 参加者が多いため駐輪場は確保できません。荷物運搬を含め、自転車での来校はご遠慮ください。
   - 保護者の方は名札をご用意ください。
   - 参加費はお釣りの無いようにご用意ください。

1. キャンプ
   - テントの貸出はありません。テント・テーブル・タープ等を使用したい場合、申込時に事前申告の上、当日ご持参ください。
   - 火気を使用するキャンプ用品はご利用いただけません(例：グリル、コンロ、ガソリンを使用するランタン等)

1. 食事
   - 食事はカレールーのみ提供されます。ごはんや副菜、皿・スプーン・コップ等の食器は提供されませんので、各自ご持参ください。
   - 食品アレルギーのある方への個別対応は困難なので、申し訳ありませんが参加者側でカレールーまたは代替品をご持参いただけますようお願いします。
   - 食後の食器はそのまま持ち帰り、洗浄は各家庭でお願いします。
   - 校舎内の飲食は禁止されています。おやつの持ち込みはご遠慮ください。
   - コロナ対応等で当日校内での飲食ができなくなる可能性があります。対応は都度ご案内しますが、予めご了承ください。

1. <del>ゲーム、イベント</del>校内探検
   - 校内探検の際の懐中電灯はグループ毎に1つ運営で貸与します。明るくなり過ぎないよう、参加者各自の持参・使用はご遠慮ください。

1. その他
   - 本件に関する問合せは skt.oyaji@gmail.com にお願いします。</div>
    <div name="持ち物" class="markdown">1. キャンプ
  - テント・テーブル・タープ等のキャンプ用品(任意)
  - 敷物

1. 食事
  - ご飯・パン等の主食、おかず
  - 飲み物
  - 皿、スプーン、箸、コップ等の食器
  - ナプキン、ウェットティッシュ等
  - 持ち帰り用ゴミ袋

1. <del>ゲーム・イベント</del>校内探検

1. その他
  - 参加費(お釣りの無いように)
  - 保護者用名札
  - マスク
  - 水筒</div>
  </div>

  <!--div name="passport"><h1>パスポート</h1></div-->

  <div name="案内図"><div class="img"><svg id="exportSVG" visibility="visible" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" data-info="draw.ninja" data-name="223" viewBox="0 0 600 600" width="600" height="600"><defs id="defsExport"><filter id="filter0"><feGaussianBlur stdDeviation="0"></feGaussianBlur></filter><pattern id="patternImage" patternUnits="userSpaceOnUse" x="0" y="0" width="1" height="1" data-x="0" data-y="0" data-width="1" data-height="1" data-multx="1" data-multy="1" patternTransform="matrix(1,0,0,1,0,0)" data-transs="0" data-transf="0" data-source="patternImage" data-draw="1" fill="#B3B3B3" fill-opacity="1"></pattern><pattern id="pattern0" patternUnits="userSpaceOnUse" x="0" y="0" width="10" height="10" data-x="0" data-y="0" data-width="10" data-height="10" data-multx="1" data-multy="1" stroke="none" patternTransform="matrix(1,0,0,1,0,0)" data-transs="0" data-transf="0" data-source="Pattern 0" data-draw="1" fill="#B3B3B3" fill-opacity="1"><path transform="matrix(1,0,0,1,0,0)" d="M0 0 L5 0 L5 5 L0 5 L0 0 Z"></path></pattern><pattern id="pattern1" patternUnits="userSpaceOnUse" x="0" y="0" width="10" height="10" data-x="0" data-y="0" data-width="10" data-height="10" data-multx="1" data-multy="1" stroke="none" patternTransform="matrix(1,0,0,1,0,0)" data-transs="0" data-transf="0" data-source="Pattern 1" data-draw="1" fill="#B3B3B3" fill-opacity="1"><path transform="matrix(1,0,0,1,0,0)" d="M0 5 L5 0 L10 5 L5 10 L0 5 Z"></path></pattern><pattern id="pattern2" patternUnits="userSpaceOnUse" x="0" y="0" width="10" height="10" data-x="0" data-y="0" data-width="10" data-height="10" data-multx="1" data-multy="1" stroke="none" patternTransform="matrix(1,0,0,1,0,0)" data-transs="0" data-transf="0" data-source="Pattern 2" data-draw="1" fill="#B3B3B3" fill-opacity="1"><path transform="matrix(1,0,0,1,0,0)" d="M0 9 L5 1 L10 9 L0 9 Z"></path></pattern><pattern id="pattern3" patternUnits="userSpaceOnUse" x="0" y="0" width="10" height="10" data-x="0" data-y="0" data-width="10" data-height="10" data-multx="1" data-multy="1" stroke="none" patternTransform="matrix(1,0,0,1,0,0)" data-transs="0" data-transf="0" data-source="Pattern 3" data-draw="1" fill="#B3B3B3" fill-opacity="1"><path transform="matrix(1,0,0,1,0,0)" d="M0 5 C0 2.25 2.25 0 5 0 C7.75 0 10 2.25 10 5 C10 7.75 7.75 10 5 10 C2.25 10 0 7.75 0 5 Z"></path></pattern><pattern id="pattern4" patternUnits="userSpaceOnUse" x="0" y="0" width="10" height="10" data-x="0" data-y="0" data-width="10" data-height="10" data-multx="1" data-multy="1" stroke="none" patternTransform="matrix(1,0,0,1,0,0)" data-transs="0" data-transf="0" data-source="Pattern 4" data-draw="1" fill="#B3B3B3" fill-opacity="1"><path transform="matrix(1,0,0,1,0,0)" d="M0 5 L4 4 L5 0 L6 4 L10 5 L6 6 L5 10 L4 6 L0 5 Z"></path></pattern><pattern id="pattern5" patternUnits="userSpaceOnUse" x="0" y="0" width="10" height="10" data-x="0" data-y="0" data-width="10" data-height="10" data-multx="1" data-multy="1" stroke="none" patternTransform="matrix(1,0,0,1,0,0)" data-transs="0" data-transf="0" data-source="Pattern 5" data-draw="1" fill="#B3B3B3" fill-opacity="1"><path transform="matrix(1,0,0,1,0,0)" d="M5 10 C-5 2.75 3 -1.75 5 1 C7 -1.75 15 2.75 5 10 Z"></path></pattern><pattern id="pattern6" patternUnits="userSpaceOnUse" x="0" y="0" width="10" height="10" data-x="0" data-y="0" data-width="10" data-height="10" data-multx="1" data-multy="1" stroke="none" patternTransform="matrix(1,0,0,1,0,0)" data-transs="0" data-transf="0" data-source="Pattern 6" data-draw="1" fill="#B3B3B3" fill-opacity="1"><path transform="matrix(1,0,0,1,0,0)" d="M3 0 L7 0 L7 10 L3 10 L3 0 Z"></path></pattern><pattern id="pattern7" patternUnits="userSpaceOnUse" x="0" y="0" width="10" height="10" data-x="0" data-y="0" data-width="10" data-height="10" data-multx="1" data-multy="1" stroke="none" patternTransform="matrix(1,0,0,1,0,0)" data-transs="0" data-transf="0" data-source="Pattern 7" data-draw="1" fill="#B3B3B3" fill-opacity="1"><path transform="matrix(1,0,0,1,0,0)" d="M10 3 L10 7 L0 7 L0 3 L10 3 Z"></path></pattern><pattern id="pattern8" patternUnits="userSpaceOnUse" x="0" y="0" width="10" height="10" data-x="0" data-y="0" data-width="10" data-height="10" data-multx="1" data-multy="1" stroke="none" patternTransform="matrix(1,0,0,1,0,0)" data-transs="0" data-transf="0" data-source="Pattern 8" data-draw="1" fill="#B3B3B3" fill-opacity="1"><path transform="matrix(1,0,0,1,0,0)" d="M0 10 L3 3 L10 0 L7 7 L0 10 Z"></path></pattern><pattern id="pattern9" patternUnits="userSpaceOnUse" x="0" y="0" width="10" height="10" data-x="0" data-y="0" data-width="10" data-height="10" data-multx="1" data-multy="1" stroke="none" patternTransform="matrix(1,0,0,1,0,0)" data-transs="0" data-transf="0" data-source="Pattern 9" data-draw="1" fill="#B3B3B3" fill-opacity="1"><path transform="matrix(1,0,0,1,0,0)" d="M0 4 L10 4 L10 6 L0 6 L0 4 Z M4 10 L4 0 L6 0 L6 10 L4 10 Z"></path></pattern><linearGradient id="linearSystem" gradientUnits="objectBoundingBox" x1="0%" y1="50%" x2="100%" y2="50%" spreadMethod="pad"><stop offset="50%" stop-color="#D0D0D0" stop-opacity="1"></stop><stop offset="100%" stop-color="transparent" stop-opacity="1"></stop></linearGradient><linearGradient id="linearSystem1" gradientUnits="objectBoundingBox" x1="0%" y1="50%" x2="100%" y2="50%" spreadMethod="pad"><stop offset="30%" stop-color="#D0D0D0" stop-opacity="1"></stop><stop offset="100%" stop-color="transparent" stop-opacity="1"></stop></linearGradient><linearGradient id="linearSystem2" gradientUnits="objectBoundingBox" x1="0%" y1="50%" x2="50%" y2="50%" spreadMethod="repeat"><stop offset="30%" stop-color="#D0D0D0" stop-opacity="1"></stop><stop offset="100%" stop-color="transparent" stop-opacity="1"></stop></linearGradient><linearGradient id="linearSystem3" gradientUnits="objectBoundingBox" x1="0%" y1="50%" x2="50%" y2="50%" spreadMethod="reflect"><stop offset="30%" stop-color="#D0D0D0" stop-opacity="1"></stop><stop offset="100%" stop-color="transparent" stop-opacity="1"></stop></linearGradient><radialGradient id="radialSystem" gradientUnits="objectBoundingBox" r="0.5" cx="0.5" fx="0.5" cy="0.5" fy="0.5" spreadMethod="pad"><stop offset="50%" stop-color="#D0D0D0" stop-opacity="1"></stop><stop offset="100%" stop-color="transparent" stop-opacity="1"></stop></radialGradient><pattern id="patternSystem" patternUnits="userSpaceOnUse" x="0" y="0" width="6" height="8"><path stroke="#D0D0D0" stroke-width="5" fill="none" d="M0 0 L0 10"></path></pattern><linearGradient id="linear0" gradientUnits="objectBoundingBox" x1="0%" y1="50%" x2="100%" y2="50%" spreadMethod="pad"><stop offset="0%" stop-color="#FF8000" stop-opacity="1"></stop><stop offset="100%" stop-color="#FFFF00" stop-opacity="1"></stop></linearGradient><linearGradient id="linear1" gradientUnits="objectBoundingBox" x1="0%" y1="50%" x2="100%" y2="50%" spreadMethod="pad"><stop offset="0%" stop-color="#FFFF00" stop-opacity="1"></stop><stop offset="100%" stop-color="#FF8000" stop-opacity="1"></stop></linearGradient><linearGradient id="linearImport" gradientUnits="objectBoundingBox" x1="0%" y1="50%" x2="100%" y2="50%" spreadMethod="pad"><stop offset="0%" stop-color="#FFFFFF" stop-opacity="0.1"></stop><stop offset="100%" stop-color="#000000" stop-opacity="0.1"></stop></linearGradient><radialGradient id="radial0" gradientUnits="objectBoundingBox" r="0.5" cx="0.5" fx="0.5" cy="0.5" fy="0.5" spreadMethod="pad"><stop offset="0%" stop-color="#FF8000" stop-opacity="1"></stop><stop offset="100%" stop-color="#FFFF00" stop-opacity="1"></stop></radialGradient><radialGradient id="radial1" gradientUnits="objectBoundingBox" r="0.5" cx="0.5" fx="0.5" cy="0.5" fy="0.5" spreadMethod="pad"><stop offset="0%" stop-color="#FFFF00" stop-opacity="1"></stop><stop offset="100%" stop-color="#FF8000" stop-opacity="1"></stop></radialGradient><radialGradient id="radialImport" gradientUnits="objectBoundingBox" r="0.5" cx="0.5" fx="0.5" cy="0.5" fy="0.5" spreadMethod="pad"><stop offset="0%" stop-color="#FFFFFF" stop-opacity="0.1"></stop><stop offset="100%" stop-color="#000000" stop-opacity="0.1"></stop></radialGradient><pattern id="pattern10" patternUnits="userSpaceOnUse" x="110" y="110" width="1520" height="1598" data-x="110" data-y="110" data-width="1520" data-height="1598" data-multx="1" data-multy="1" patternTransform="matrix(0.554,0,0,0.554,-190.855,29.145)" data-transs="0" data-transf="translate(-130,0) matrix(0.554,0,0,0.554,-60.855,29.145)" data-source="Image 0" data-draw="1" fill="#B3B3B3" fill-opacity="1"></pattern><pattern id="patternPreview" patternUnits="userSpaceOnUse" x="0" y="0" width="10" height="10" data-x="0" data-y="0" data-width="10" data-height="10" data-multx="1" data-multy="1" stroke="none" patternTransform="matrix(1,0,0,1,0,0)" data-transs="0" data-transf="0" data-source="Pattern 0" data-draw="1" fill="#B3B3B3" fill-opacity="1"><path transform="matrix(1,0,0,1,0,0)" d="M0 0 L5 0 L5 5 L0 5 L0 0 Z"></path></pattern></defs><rect id="pageExport" x="0" y="0" width="600" height="600" fill="none" fill-opacity="0" stroke="none" stroke-width="0"></rect><g id="objectsExport" visibility="visible"><path id="path24" visibility="visible" stroke="#000000" stroke-width="2" stroke-opacity="1" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="none" marker-start="none" marker-end="none" fill="none" fill-rule="evenodd" fill-opacity="1" data-name="curve" data-title="敷地外周" deg="0" data-sw="2" data-grad="0" data-group="0" data-edit="1" filter="none" d="M549.317 16.167 L93.317 15.167 L84.317 22.167 L71.317 132.167 L77.417 132.467 L75.317 199.967 L65.717 200.367 L39.653 494.513 L203.649 471.83 L220.979 588.504 L561.317 522.167 L567.657 509.323 L553.987 385.5 L558.99 25.495 L550.017 15.463 " data-centerx="303.655" data-centery="301.836"></path><path id="path25" visibility="visible" stroke="#000000" stroke-width="2" stroke-opacity="1" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="none" marker-start="none" marker-end="none" fill="none" fill-rule="evenodd" fill-opacity="1" data-name="curve" data-title="校舎＋体育館" deg="0" data-sw="2" data-grad="0" data-group="0" data-edit="1" filter="none" d="M138.317 27.5 L131.65 159.5 L410.317 162.167 L409.15 378.167 L123.841 434.838 L129.845 477.311 L207.458 467.021 L221.749 563.878 L228.886 570.167 L256.031 565.024 L258.315 573.029 L385.461 550.453 L384.028 542.738 L408.795 538.264 L411.317 547.084 L539.177 522.169 L543.65 516.831 L544.648 384.169 L534.641 383.495 L534.991 231.84 L544.647 231.838 L547.984 28.174 L138.317 27.5 Z " data-centerx="335.913" data-centery="300.264"></path><path id="path26" visibility="visible" stroke="#000000" stroke-width="2" stroke-opacity="1" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="none" marker-start="none" marker-end="none" fill="none" fill-rule="evenodd" fill-opacity="1" data-name="curve" data-title="正門横フェンス" deg="0" data-sw="2" data-grad="0" data-group="0" data-edit="1" filter="none" d="M134.317 199.167 L64.067 230.417 " data-centerx="99.192" data-centery="214.792"></path><path id="path27" visibility="visible" stroke="none" stroke-width="2" stroke-opacity="1" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="none" marker-start="none" marker-end="none" fill="#b0f4d0" fill-rule="evenodd" fill-opacity="0.5" data-name="curve" data-title="朝礼台横芝生" deg="0" data-sw="2" data-grad="0" data-group="0" data-edit="1" filter="none" d="M137.567 171.667 L140.317 202.167 L347.817 202.417 L381.317 173.167 L137.567 171.667 Z " data-centerx="259.442" data-centery="187.042"></path><path id="path28" visibility="visible" stroke="#000000" stroke-width="1" stroke-opacity="1" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="none" marker-start="none" marker-end="none" fill="#FFFFFF" fill-rule="evenodd" fill-opacity="1" data-name="curve" data-title="朝礼台" deg="0" data-sw="1" data-grad="0" data-group="0" data-edit="1" filter="none" d="M235.317 172.667 L259.567 172.667 L259.567 183.417 L235.317 183.417 L235.317 172.667 Z " data-centerx="247.442" data-centery="178.042"></path><path id="path29" visibility="visible" stroke="none" stroke-width="2" stroke-opacity="1" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="none" marker-start="none" marker-end="none" fill="#804040" fill-rule="evenodd" fill-opacity="1" data-name="curve" data-title="菜園右" deg="0" data-sw="2" data-grad="0" data-group="0" data-edit="1" filter="none" d="M112.817 59.667 L126.417 59.417 L125.567 148.417 L112.717 148.517 L112.817 59.667 Z " data-centerx="119.567" data-centery="103.967"></path><path id="path30" visibility="visible" stroke="none" stroke-width="2" stroke-opacity="1" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="none" marker-start="none" marker-end="none" fill="#804040" fill-rule="evenodd" fill-opacity="1" data-name="curve" data-title="菜園左" deg="0" data-sw="2" data-grad="0" data-group="0" data-edit="1" filter="none" d="M107.267 59.917 L94.317 60.167 L94.317 148.667 L106.567 148.667 L107.267 59.917 Z " data-centerx="100.792" data-centery="104.292"></path><path id="path31" visibility="visible" stroke="none" stroke-width="2" stroke-opacity="1" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="none" marker-start="none" marker-end="none" fill="#0080FF" fill-rule="evenodd" fill-opacity="1" data-name="curve" data-title="池" deg="0" data-sw="2" data-grad="0" data-group="0" data-edit="1" filter="none" d="M122.567 58.467 L122.817 45.667 L110.567 45.667 L109.817 54.417 L113.817 54.417 L114.617 58.467 L122.567 58.467 Z " data-centerx="116.317" data-centery="52.067"></path><g id="group32" visibility="visible" stroke="#000000" stroke-width="2" stroke-opacity="1" stroke-dasharray="none" fill="none" fill-opacity="1" data-name="group" data-title="ランニングコースライン" deg="0" data-edit="1" data-centerx="238.942" data-centery="290.667" data-group="0"><path id="path10" visibility="visible" stroke="#999999" stroke-width="2" stroke-opacity="1" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="none" marker-start="none" marker-end="none" fill="none" fill-rule="evenodd" fill-opacity="1" data-name="curve" data-title="curve" deg="0" data-sw="2" data-grad="0" data-group="group32" data-edit="1" filter="none" d="M157.317 236.917 L320.067 236.917 L320.067 344.417 L157.317 344.417 L157.317 236.917 Z " data-centerx="-558.625" data-centery="76.5"></path><path id="path11" visibility="visible" stroke="#999999" stroke-width="2" stroke-opacity="1" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="none" marker-start="none" marker-end="none" fill="none" fill-rule="evenodd" fill-opacity="1" data-name="curve" data-title="curve" deg="0" data-sw="2" data-grad="0" data-group="group32" data-edit="1" filter="none" d="M118.817 290.417 C118.817 260.992 136.423 236.917 157.942 236.917 C179.461 236.917 197.067 260.992 197.067 290.417 C197.067 319.842 179.461 343.917 157.942 343.917 C136.423 343.917 118.817 319.842 118.817 290.417 Z " data-centerx="-639.37" data-centery="76.25"></path><path id="path12" visibility="visible" stroke="#999999" stroke-width="2" stroke-opacity="1" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="none" marker-start="none" marker-end="none" fill="none" fill-rule="evenodd" fill-opacity="1" data-name="curve" data-title="curve" deg="0" data-sw="2" data-grad="0" data-group="group32" data-edit="1" filter="none" d="M277.317 290.667 C277.317 261.242 295.711 237.167 318.192 237.167 C340.674 237.167 359.067 261.242 359.067 290.667 C359.067 320.092 340.674 344.167 318.192 344.167 C295.711 344.167 277.317 320.092 277.317 290.667 Z " data-centerx="-479.125" data-centery="76.5"></path></g><g id="group33" visibility="visible" stroke="#000000" stroke-width="2" stroke-opacity="1" stroke-dasharray="none" fill="none" fill-opacity="1" data-name="group" data-title="正門" deg="0" data-edit="1" data-centerx="74.793" data-centery="167.042" data-group="0"><path id="path14" visibility="visible" stroke="#FFFFFF" stroke-width="3" stroke-opacity="1" stroke-linecap="square" stroke-linejoin="round" stroke-dasharray="none" marker-start="none" marker-end="none" fill="none" fill-rule="evenodd" fill-opacity="1" data-name="curve" data-title="curve" deg="359" data-sw="3" data-grad="0" data-group="group33" data-edit="1" filter="none" d="M76.511 162.122 L76.109 184.532 " data-centerx="-540.94" data-centery="125.16"></path><path id="path15" visibility="visible" stroke="#000000" stroke-width="2" stroke-opacity="1" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="none" marker-start="none" marker-end="none" fill="none" fill-rule="evenodd" fill-opacity="1" data-name="curve" data-title="curve" deg="0" data-sw="2" data-grad="0" data-group="group33" data-edit="1" filter="none" d="M77.65 176.927 L77.45 185.207 L77.65 176.927 " data-centerx="-539.7" data-centery="132.9"></path><path id="path16" visibility="visible" stroke="#000000" stroke-width="2" stroke-opacity="1" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="none" marker-start="none" marker-end="none" fill="none" fill-rule="evenodd" fill-opacity="1" data-name="curve" data-title="curve" deg="0" data-sw="2" data-grad="0" data-group="group33" data-edit="1" filter="none" d="M76.41 169.567 L76.21 177.847 L76.41 169.567 " data-centerx="-540.94" data-centery="125.54"></path><path id="path17" visibility="visible" stroke="#000000" stroke-width="2" stroke-opacity="1" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="none" marker-start="none" marker-end="none" fill="none" fill-rule="evenodd" fill-opacity="1" data-name="curve" data-title="curve" deg="0" data-sw="2" data-grad="0" data-group="group33" data-edit="1" filter="none" d="M75.21 161.567 L75.01 169.847 L75.21 161.567 " data-centerx="-542.14" data-centery="117.54"></path><path id="path18" visibility="visible" stroke="#000000" stroke-width="1" stroke-opacity="1" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="none" marker-start="none" marker-end="none" fill="none" fill-rule="evenodd" fill-opacity="1" data-name="curve" data-title="curve" deg="0" data-sw="1" data-grad="0" data-group="group33" data-edit="1" filter="none" d="M76.69 147.977 L70.03 149.635 C70.722 153.018 73.065 154.366 76.066 154.136 " data-centerx="-543.89" data-centery="102.902"></path><path id="path19" visibility="visible" stroke="#000000" stroke-width="2" stroke-opacity="1" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="none" marker-start="none" marker-end="none" fill="none" fill-rule="evenodd" fill-opacity="1" data-name="curve" data-title="curve" deg="346" data-sw="2" data-grad="0" data-group="group33" data-edit="1" filter="none" d="M73.854 186.979 L78.646 187.105 " data-centerx="-541" data-centery="138.875"></path><path id="path20" visibility="visible" stroke="#000000" stroke-width="2" stroke-opacity="1" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="none" marker-start="none" marker-end="none" fill="none" fill-rule="evenodd" fill-opacity="1" data-name="curve" data-title="curve" deg="346" data-sw="2" data-grad="0" data-group="group33" data-edit="1" filter="none" d="M74.604 146.979 L79.396 147.105 " data-centerx="-540.25" data-centery="98.875"></path><path id="path21" visibility="visible" stroke="none" stroke-width="2" stroke-opacity="1" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="none" marker-start="none" marker-end="none" fill="#000000" fill-rule="evenodd" fill-opacity="1" data-name="curve" data-title="curve" deg="1" data-sw="2" data-grad="0" data-group="group33" data-edit="1" filter="none" d="M73.798 154.613 L79.556 154.714 L79.452 160.721 L73.694 160.62 L73.798 154.613 Z " data-centerx="-540.625" data-centery="109.5"></path></g><path id="path34" visibility="visible" stroke="#FF0000" stroke-width="2" stroke-opacity="1" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="none" marker-start="none" marker-end="none" fill="none" fill-rule="evenodd" fill-opacity="1" data-name="curve" data-title="受付枠" deg="0" data-sw="2" data-grad="0" data-group="0" data-edit="1" filter="none" d="M84 165 L127 165 L127 198 L84 198 L84 165 Z " data-centerx="105.5" data-centery="181.5"></path><g id="group35" visibility="visible" stroke="#000000" stroke-width="2" stroke-opacity="1" stroke-dasharray="none" fill="none" fill-opacity="1" data-name="group" data-title="受付文字" deg="0" data-edit="1" data-centerx="105" data-centery="181"><text id="text36" visibility="visible" font-family="Verdana" font-size="18" font-weight="normal" font-style="normal" transform="matrix(1,0,0,1,155,-182)" stroke="none" stroke-width="2" stroke-opacity="1" stroke-dasharray="none" fill="#FF0000" fill-opacity="1" data-name="text" data-title="text" deg="0" data-sw="2" data-group="group35" data-trans="translate(-660,-160) matrix(1,0,0,1,815,-22)" data-edit="1" filter="none" x="-68" y="370" data-centerx="-710" data-centery="203">受付</text></g><path id="path40" visibility="visible" stroke="#FF0000" stroke-width="2" stroke-opacity="1" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="none" marker-start="none" marker-end="none" fill="none" fill-rule="evenodd" fill-opacity="1" data-name="curve" data-title="curve" deg="0" data-sw="2" data-grad="0" data-group="0" data-edit="1" filter="none" d="M142 166 L143 235 L330 235 L331 382 L399 367 L400 168 L142 166 " data-centerx="271" data-centery="274"></path><path id="path41" visibility="visible" stroke="#FF0000" stroke-width="2" stroke-opacity="1" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="none" marker-start="none" marker-end="none" fill="none" fill-rule="evenodd" fill-opacity="1" data-name="curve" data-title="curve" deg="0" data-sw="2" data-grad="0" data-group="0" data-edit="1" filter="none" d="M131 247 L319 246 L320 383 L131 418 L131 247 Z " data-centerx="225.5" data-centery="332"></path><g id="group48" visibility="visible" stroke="#FF0000" stroke-width="2" stroke-opacity="1" stroke-dasharray="none" fill="none" fill-opacity="1" data-name="group" data-title="group" deg="0" data-edit="1" data-centerx="380.5" data-centery="294.5"><path id="path42" visibility="visible" stroke="#FF0000" stroke-width="2" stroke-opacity="1" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="none" marker-start="none" marker-end="none" fill="none" fill-rule="evenodd" fill-opacity="1" data-name="curve" data-title="curve" deg="0" data-sw="2" data-grad="0" data-group="group48" data-edit="1" filter="none" d="M366 269 L395 269 L395 320 L366 320 L366 269 Z " data-centerx="-730.5" data-centery="211.5"></path><g id="group47" visibility="visible" stroke="#FF0000" stroke-width="2" stroke-opacity="1" stroke-dasharray="none" fill="none" fill-opacity="1" data-name="group" data-title="group" deg="0" data-edit="1" data-centerx="-730.5" data-centery="210.5"><g id="group43" visibility="visible" stroke="#FF0000" stroke-width="2" stroke-opacity="1" stroke-dasharray="none" fill="none" fill-opacity="1" data-name="group" data-title="text" deg="0" data-edit="1" data-centerx="-726.5" data-centery="64" data-group="group48"><text id="text44" visibility="visible" font-family="Verdana" font-size="18" font-weight="normal" font-style="normal" transform="matrix(1,0,0,1,446.5,59)" stroke="none" stroke-width="2" stroke-opacity="1" stroke-dasharray="none" fill="#FF0000" fill-opacity="1" data-name="text" data-title="text" deg="0" data-sw="2" data-group="group48" data-trans="translate(-660,-160) matrix(1,0,0,1,1106.5,219)" data-edit="1" filter="none" x="-75" y="231" data-centerx="-726" data-centery="64">本</text></g><g id="group45" visibility="visible" stroke="#FF0000" stroke-width="2" stroke-opacity="1" stroke-dasharray="none" fill="none" fill-opacity="1" data-name="group" data-title="text" deg="0" data-edit="1" data-centerx="-726.5" data-centery="85" data-group="group48"><text id="text46" visibility="visible" font-family="Verdana" font-size="18" font-weight="normal" font-style="normal" transform="matrix(1,0,0,1,446.5,80)" stroke="none" stroke-width="2" stroke-opacity="1" stroke-dasharray="none" fill="#FF0000" fill-opacity="1" data-name="text" data-title="text" deg="0" data-sw="2" data-group="group48" data-trans="translate(-660,-160) matrix(1,0,0,1,1106.5,240)" data-edit="1" filter="none" x="-75" y="231" data-centerx="-716" data-centery="74">部</text></g></g></g><g id="group49" visibility="visible" stroke="#FF0000" stroke-width="2" stroke-opacity="1" stroke-dasharray="none" fill="none" fill-opacity="1" data-name="group" data-title="テント文字" deg="0" data-edit="1" data-centerx="231" data-centery="327"><text id="text50" visibility="visible" font-family="Verdana" font-size="18" font-weight="normal" font-style="normal" transform="matrix(1,0,0,1,-502,-35)" stroke="none" stroke-width="2" stroke-opacity="1" stroke-dasharray="none" fill="#FF0000" fill-opacity="1" data-name="text" data-title="text" deg="0" data-sw="2" data-group="group49" data-trans="translate(-660,-160) matrix(1,0,0,1,158,125)" data-edit="1" filter="none" x="679" y="369" data-centerx="73" data-centery="202">テントエリア</text></g><g id="group51" visibility="visible" stroke="#FF0000" stroke-width="2" stroke-opacity="1" stroke-dasharray="none" fill="none" fill-opacity="1" data-name="group" data-title="通路文字" deg="0" data-edit="1" data-centerx="249" data-centery="216"><text id="text52" visibility="visible" font-family="Verdana" font-size="18" font-weight="normal" font-style="normal" transform="matrix(1,0,0,1,-502,-146)" stroke="none" stroke-width="2" stroke-opacity="1" stroke-dasharray="none" fill="#FF0000" fill-opacity="1" data-name="text" data-title="text" deg="0" data-sw="2" data-group="group51" data-trans="translate(-660,-160) matrix(1,0,0,1,158,14)" data-edit="1" filter="none" x="679" y="369" data-centerx="249" data-centery="216">通路・食事エリア</text></g></g><g id="settings" visibility="hidden" data-dn0="primalDraw" data-dn1="#FAFAFA" data-dn2="#D2D2D2" data-dn3="18" data-dn4="#FF0000" data-dn5="none" data-dn6="1" data-dn7="1" data-dn8="2" data-dn9="round" data-dn10="round" data-dn11="none" data-dn12="none" data-dn13="none" data-dn14="evenodd" data-dn15="10" data-dn16="1" data-dn17="600" data-dn18="600" data-dn19="10" data-dn20="0" data-dn21="1" data-dn22="1" data-dn23="53" data-dn24="path24,path25,path26,path27,path28,path29,path30,path31,group32,group33,path34,group35,path40,path41,group48,group49,group51" data-dn25="2" data-dn26="url(#linear0)" data-dn27="url(#linear1)" data-dn28="url(#radial0)" data-dn29="url(#radial1)" data-dn30="#FF8000" data-dn31="#FFFF00" data-dn32="#000000" data-dn33="1" data-dn34="1" data-dn35="11" data-dn36="" data-dn37="0" data-dn38="103"></g></svg></div></div>

  <div class="TimeTable" name="予定表">
    <!--
    <ul>
      <li>図中の「▼」「▶️」をクリックすると下位項目が開閉されます</li>
      <li>作業項目名をクリックすると詳細が表の下に表示されます</li>
    </ul>
      詳細は別ページ？　別ペイン？
      表示範囲絞り込み
      所要物一覧
    -->
  </div>

  <!--
    遊び場保険、スケジュールに追加
  -->
  <!-- div class="TabMenu" name="スタッフ">
    <div name="日程表">
      <div class="PlantUML"  data-embed="schedule.pu"><img /></div>
      <div class="markdown" name="schedule2"></div>
    </div>

    <div name="scanner"><h1>QRコード受付</h1></div>

    <div name="校内探検">
      <img width="600px" data-embed='{"from":{"filename":"expedition.txt"},"to":"png"}' />
      <div class="markdown" data-embed="肝試し配置.md"></div>
    </div>

    <div name="参加者数集計">
      <h1>工事中</h1>
      <p>以下はMermaid出力テスト画面(完成時のイメージとは関係ありません)</p>
      <div name="test" class="mermaid">
        sequenceDiagram
          太郎->>花子: おはよう
          花子->>太郎: こんにちは！！
      </div>
    </div>

    <div class="TabMenu" name="論議メモ">
      <div class="markdown" name="6/10定例会" data-embed="20230610.md"></div>
      <div class="markdown" name="7/08定例会" data-embed="20230708.md"></div>
    </div>

    <div class="markdown" name="関連サイト" data-embed="RelatedSites.md"></div>

    <div class="TabMenu" name="参考資料">
      <div class="markdown" name="申込フォーム作成手順" data-embed="makeForm.md"></div>
    </div>
    
  </div -->


<!-- 自作ライブラリ -->
<script type="text/javascript">/* コアScript */
/**
 * @typedef {Object} AuthProp - AuthOpt以外のAuthクラスプロパティ
 * @prop {number} constructorStart - constructor開始時刻(UNIX時間)
 * @prop {string} parentSelector - 親画面のCSSセレクタ
 * @prop {HTMLElement} parentWindow - 親画面のHTML要素
 * @prop {HTMLElement} AuthWindow - Auth関係画面のwrapper
 * @prop {HTMLElement} loading - ローディング画面のHTML要素
 */

/**
 * @typedef {Object} AuthOpt
 * @prop {string} [entryNo] - 受付番号(ID)
 * @prop {string} [passWord] - パスワード
 * @prop {string} [header=''] - 受付番号入力画面に表示するheaderのinnerHTML
 * @prop {string} [entryNoMessage='受付番号を入力してください'] - 受付番号入力画面に表示するメッセージ
 * @prop {string} [entryNoButton='送信'] - 受付番号入力画面のボタンのラベル
 * @prop {RegExp} [entryNoRegExp=/^[0-9]{1,4}$/] - 受付番号チェック用正規表現
 */

/**
 * @classdesc 入力されたID/PWと登録情報を突合し、IDに紐づく各種情報を返す
 *
 * - パスコード(passCode) : 受付番号入力後受信したメールに記載された番号
 * - パスワード(passWord) : 鍵ペア生成の際、秘密鍵の基となる文字列
 * 
 */
class Auth {
  /**
   * @constructor
   * @param {string} gatewayUrl - 認証局APIのURL
   * @param {AuthOpt} [opt={}] - 生成時オプション
   * @returns {void} なし
   * 
   * ## 処理概要
   * 
   * ```mermaid
   * sequenceDiagram
   *   autonumber
   *   actor mailer as メーラ
   *   actor browser as ブラウザ
   *   participant gateway as 認証局
   *   participant master as 管理局
   *   participant httpd as httpd
   * 
   *   %% 受付番号入力
   *   mailer ->> httpd : 事前に送信された案内メールのリンクをクリック
   *   httpd ->> browser : ページファイル(index.html)
   *   activate browser
   *   Note right of browser: constructor()
   *   Note right of browser: getEntryNo()
   * 
   *   browser ->> gateway : 受付番号、CP(平文)
   *   activate gateway
   *   Note right of gateway : auth1A()
   * 
   *   gateway ->> master : 受付番号、CP(GS/MP)
   *   activate master
   *   Note right of master : auth1B()
   *   master ->> mailer : パスコード
   *   activate mailer
   * 
   *   master ->> gateway : 申請登録結果
   *   deactivate master
   * 
   *   gateway ->> browser : 申請登録結果
   *   deactivate gateway
   *   browser ->> browser : GP格納、パスコード入力画面表示
   *   deactivate browser
   * 
   * 
   *   %% パスコード入力
   *   mailer ->> browser : パスコード入力
   *   deactivate mailer
   *   activate browser
   *   Note right of browser : getPassCode()
   *   browser ->> gateway : 受付番号、パスコード(CS/GP)
   *   activate gateway
   *   Note right of gateway : auth2A
   *   gateway ->> master : 受付番号、パスコード、CP(GS/MP)
   *   activate master
   *   Note right of master : auth2B
   *   master ->> gateway : 利用者情報
   *   deactivate master
   *   gateway ->> browser : 利用者情報,CK
   *   deactivate gateway
   *   browser ->> browser : 初期画面表示
   *   deactivate browser
   * 
   * ```
   * 
   * - 文中の記号は以下の通り
   *   - CK:共通鍵(Common Key)
   *   - CP:利用者公開鍵(Client Public key)、CS:利用者秘密鍵(Client Secret key)
   *   - GP:認証局公開鍵(Gateway Public key)、GS:認証局秘密鍵(Gateway Secret key)
   *   - FP:配信局公開鍵(Front Public key)、FS:配信局秘密鍵(Front Secret key)
   *   - MP:管理局公開鍵(Master Public key)、MS:管理局秘密鍵(Master Secret key)
   *   - (xS/yP) = XX局秘密鍵で署名、YY局公開鍵で暗号化した、XX->YY宛の通信<br>
   *     例：(GS/MP) ⇒ GS(認証局秘密鍵)で署名、MP(管理局公開鍵)で暗号化
   * - (02) constructor() : DOMContentLoaded時、以下の処理を実行
   *   1. 利用者の秘密鍵(以下CSkey)・公開鍵(以下CPkey)を生成
   *   1. getEntryNo()を呼び出し
   * - (02) getEntryNo() : 受付番号入力
   *   1. 受付番号入力画面を表示(z-indexを最大にして他の画面を触らせない)
   *   1. 入力後待機画面表示、レスポンスがあったらgetPassCode()を呼び出し
   * - (03) auth1A() : 認証申請の受付
   *   1. 受付番号とCPをauth1Bに送信
   *   1. auth1Bの申請結果を受けたらブラウザに結果を送信<br>
   *      申請OKの場合はGPも併せて送信
   * - (04) auth1B() : 認証申請の登録
   *   1. 受付番号とCPをシートに書き込み
   *   1. 正当性を検証
   *      - パスコードが一致
   *      - パスコード発行日時から1時間以内
   *      - 3回連続失敗後1時間以上経過
   *   1. 正当だった場合はパスコードを生成、シートに書き込み
   *   1. 申請者にパスコードを通知(05)
   *   1. 申請登録の結果をauth1Aに返す
   * - (09) getPassCode() : パスコード入力
   *   1. パスコード入力画面を表示
   *   1. パスコードが入力されたらauth2Aに送信
   *   1. auth2Aからレスポンスがあったらthisに保存、初期画面を表示
   * - (10) auth2A
   *   1. 受付番号・パスコード・CPkeyを管理局に送信
   *   1. 利用者情報をauth2Bから受けたらFPを追加して利用者に返す
   * - (12) auth2B
   *   1. 送信された受付番号・パスコード・CPkeyが有効か、シートの申請登録と突合
   *   1. OKなら利用者情報をauth2Aに返す
   */
  constructor(gatewayUrl,opt={}){
    const v = {rv:null};
    console.log('Auth.constructor start.');
    try {
      this.constructorStart = Date.now();

      // 1.オプション未定義項目の既定値をプロパティにセット
      this.#setProperties(this,null,opt);
      console.log('this:',this);
      console.log(Date.now()-this.constructorStart);

      // 2.必須項目をプロパティに保存
      this.gateway.url = gatewayUrl;  // 認証局のURL
      console.log(Date.now()-this.constructorStart);

      // 3.各種画面を用意する
      //   ※鍵ペア生成で時間がかかるので、先に待機画面を表示
      this.#setWindows();
      // 初期画面として待機画面を表示
      this.#changeScreen('loading');
      console.log(Date.now()-this.constructorStart);

      // 4.秘密鍵・公開鍵を作成し、プロパティに格納する
      this.#setupKeys();
      console.log(Date.now()-this.constructorStart);

      // 5.非同期の初期化処理を呼出
      this.#changeScreen('entryNo');
      //this.build();

      //console.log('v.rv='+JSON.stringify(v.rv));
      console.log('Auth.constructor end.');
      return v.rv;
    } catch(e){
      console.error('Auth.constructor abnormal end.',e);
      // ブラウザで実行する場合はアラート表示
      //if( typeof window !== 'undefined' ) alert(e.stack);
      throw e; //以降の処理を全て停止
    }
  }

  /** 既定値を設定する
   * @param {AuthOpt} opt - 生成時オプションとして渡された値
   * @returns {void}
   */
  #setProperties(dest,def,opt){
    const v = {rv:true,def:{
      parentSelector: "body", // {string} - 親要素のCSSセレクタ
      RSA:{  // 自局のRSAキー関係情報
        bits: 1024,     // {number} - RSAキー長
        passWord: null, // {string} - パスワード
        pwLength: 32,   // {number} - 自動生成する場合のパスワード文字数
        sKey: null,     // {RSAKey} - 秘密鍵
        pKey: null,     // {string} - 公開鍵
      },
      commonKey: null,  // 共通鍵
      info: null, // 管理局から取得する参加者情報
      gateway:{ // 認証局関連情報
        url: null,  // {string} - APIのURL
        pKey: null, // {string} - 公開鍵
      },
      front: {  // 配信局関連情報
        url: null,  // {string} - APIのURL
        pKey: null, // {string} - 公開鍵
      },
      AuthWindow: {
        element: null, // {HTMLElement} - 受付番号入力画面の要素。setWindowsで設定。
        zIndex: 2147483646,  // z-indexの最大値-1
      },
      entryNo:{ // 受付番号関係
        element: null, // {HTMLElement} - 受付番号入力画面の要素。setWindowsで設定。
        value: '',  // {string} - 受付番号
        header:'',    // {string} - 受付番号入力画面に表示するheaderのinnerHTML
        msg1:'受付番号を入力してください', // {string} - 入力欄の前に表示するメッセージ
        button:'送信',  // {string} - 受付番号入力画面のボタンのラベル
        msg2:'',      // {string} - 入力欄の後に表示するメッセージ
        rex:/^[0-9]{1,4}$/, // {RegExp} - 受付番号チェック用正規表現
      },
      loading: {
        element: null,
        zIndex: 2147483647,  // z-indexの最大値
      },
      passCode:{
        element: null, // {HTMLElement} - パスコード入力画面の要素。setWindowsで設定。
        //value: null,  // {string} - パスコード
        header:'',    // {string} - パスコード入力画面に表示するheaderのinnerHTML
        msg1:'確認のメールを送信しました。記載されているパスコード(数字6桁)を入力してください。<br>'
        + '※まれに迷惑メールと判定される場合があります。メールが来ない場合、そちらもご確認ください。',
                      // {string} - 入力欄の前に表示するメッセージ
        button:'送信',  // {string} - パスコード入力画面のボタンのラベル
        msg2: '※パスコードの有効期限は1時間です',
        rex:/^[0-9]{6}$/, // {RegExp} - パスコードチェック用正規表現
      },
    }};
    console.log('Auth.#setProperties start.');
    try {
      if( def !== null ){ // 2回目以降の呼出(再起呼出)
        // 再起呼出の場合、呼出元から渡された定義Objを使用
        v.def = def;
      }

      for( let key in v.def ){
        if( whichType(v.def[key]) !== 'Object' ){
          dest[key] = opt[key] || v.def[key]; // 配列はマージしない
        } else {
          if( !dest.hasOwnProperty(key) ) dest[key] = {};
          this.#setProperties(dest[key],v.def[key],opt[key]||{});
        }
      }

      if( def === null ){ // 初回呼出(非再帰)
        // 親画面のHTML要素を保存
        this.parentWindow = document.querySelector(this.parentSelector);
      }

      //console.log('this='+JSON.stringify(this));
      console.log('Auth.#setProperties end.');
      return v.rv;
    } catch(e){
      console.error('Auth.#setProperties abnormal end.',e);
      //if( typeof window !== 'undefined' ) alert(e.stack);
      v.rv.stack = e.stack; return v.rv;
    }
  }

  /** 秘密鍵・公開鍵を作成し、プロパティに格納する
   * @param {void}
   * @returns {void}
   */
  #setupKeys(){
    const v = {rv:null};
    console.log('Auth.#setupKeys start.');
    try {
      // パスワード未指定なら作成
      if( this.RSA.passWord === null ){
        this.RSA.passWord = createPassword(this.RSA.pwLength);
      }

      // 鍵ペアの生成
      this.RSA.sKey = cryptico.generateRSAKey(this.RSA.passWord, this.RSA.bits);
      this.RSA.pKey = cryptico.publicKeyString(this.RSA.sKey);
      //console.log(this.RSA);

      // 秘密鍵の保存
      //Fs.writeFileSync('./private.json', JSON.stringify(key.toJSON()));

      //console.log('v.rv='+JSON.stringify(v.rv));
      console.log('Auth.#setupKeys end.');
      return v.rv;
    } catch(e){
      console.error('Auth.#setupKeys abnormal end.',e);
      // ブラウザで実行する場合はアラート表示
      if( typeof window !== 'undefined' ) alert(e.stack); 
      //throw e; //以降の処理を全て停止する場合
      v.rv.stack = e.stack; return v.rv; // 処理継続する場合
    }
  }

  /** Auth関係画面をセットする
   *
   */
  #setWindows(){
    const v = {rv:null};
    console.log('Auth.#setWindows start.');
    try {
      // Auth関係画面のwrapper
      this.AuthWindow.element = createElement({
        attr:{name:"AuthWindow"},
        style:{
          // CSSで全画面オーバーレイを実装する方法＆コード例
          // https://pisuke-code.com/css-fullscreen-overlay/
          display: "block",
          position: "absolute",
          left: 0, top: 0,
          width: "100%", height:"100%",
          background:"#fff",
          zIndex:this.AuthWindow.zIndex,
        },
      });

      // 受付番号入力画面
      this.entryNo.element = createElement({
        children:[
          {html:this.entryNo.header}, // タイトル
          {tag:'p',html:this.entryNo.msg1},  // 入力欄前メッセージ
          { // inputBox
            tag:'input',
            attr:{type:'text',name:'entryNo',value:this.entryNo.value},
            event:{'input':(event)=>{
              // 入力値チェック
              const m = event.target.value.match(this.entryNo.rex);
              console.log('m',m);
              const b = document.querySelector('div[name="AuthWindow"] input[name="entryNoButton"]');
              if( m ){
                b.removeAttribute('disabled');
              } else {
                b.setAttribute('disabled',true);
              }
            }},
          },
          { // 送信ボタン
            tag:'input',
            attr:{
              type:'button',
              name:'entryNoButton',
              value:this.entryNo.button,
            },
            logical:{
              disabled: this.entryNo.value.match(this.entryNo.rex) ? false : true,
            },
            event:{'click':()=>this.getEntryNo()},
          },
          {tag:'p',html:this.entryNo.msg2},  // 入力欄後メッセージ
        ],
      });

      // ローディング画面
      // ※ 受付番号・パスコード入力を隠蔽するため
      //   loading.zIndex > AuthWindow.zIndex とする。
      this.loading = {element:createElement({
        style:{
          position: "absolute",
          left: 0, top: 0,
          width: "100%", height:"100%",
          background:"#fff",
          zIndex:this.loading.zIndex,
        },
        children:[
          {
            style:{
              display:"flex",
              width:"100%",
              height:"100%",
              background:"#fff",
              justifyContent:"center",
              alignItems:"center",
            },
            children:[
              {
                attr:{class:'loading5'},
                style:{ // 点の軌道/大きさ/色
                  //"--dot-size":"4rem",
                  //"--m0:3.2rem",
                  "--R":0,
                  "--G":0,
                  "--B":0,
                },
                text:'loading...'
              },
            ],
          }
        ],
      })};

      // パスコード入力画面
      this.passCode.element = createElement({
        children:[
          {html:this.passCode.header}, // タイトル
          {tag:'p',html:this.passCode.msg1},  // 入力欄前メッセージ
          { // inputBox
            tag:'input',
            attr:{type:'text',name:'passCode',value:''},
            event:{'input':(event)=>{
              // 入力値チェック
              const m = event.target.value.match(this.passCode.rex);
              console.log('m',m);
              const b = document.querySelector('div[name="AuthWindow"] input[name="passCodeButton"]');
              if( m ){
                b.removeAttribute('disabled');
              } else {
                b.setAttribute('disabled',true);
              }
            }},
          },
          { // 送信ボタン
            tag:'input',
            attr:{
              type:'button',
              name:'passCodeButton',
              value:this.passCode.button,disabled:true
            },
            event:{'click':()=>this.getPassCode()},
          },
          {tag:'p',html:this.passCode.msg2},  // 入力欄後メッセージ
        ],
      });

      // 画面をセット
      this.parentWindow.appendChild(this.AuthWindow.element);
      this.AuthWindow.element.appendChild(this.entryNo.element);
      this.AuthWindow.element.appendChild(this.loading.element);
      this.AuthWindow.element.appendChild(this.passCode.element);

      //console.log('v.rv='+JSON.stringify(v.rv));
      console.log('Auth.#setWindows end.');
      return v.rv;
    } catch(e){
      console.error('Auth.#setWindows abnormal end.',e);
      // ブラウザで実行する場合はアラート表示
      //if( typeof window !== 'undefined' ) alert(e.stack);
      v.rv.stack = e.stack; return v.rv; // 処理継続する場合
    }

  }

  /** Auth関係画面の切り替え
   * @param {string} screenId - 画面ID。open/close->AuthWindowの開閉、他は指定ウィンドウの表示
   * @returns {void}
   */
  #changeScreen(screenId){
    const v = {rv:true};
    console.log('Auth.#changeScreen start. screenId='+screenId);
    try {

      if( screenId === 'close' ){
        this.AuthWindow.element.style.display = 'none';
      } else {
        this.AuthWindow.element.style.display = '';
        ['entryNo','loading','passCode'].forEach(x => {
          this[x].element.style.display = x === screenId ? '' : 'none';
        });
      }

      // 前回のパスコードをクリア
      //this.passCode.element.querySelector('input').value = '';

      console.log('Auth.#changeScreen end.');
      return v.rv;
    } catch(e){
      console.error('Auth.#changeScreen abnormal end.',e);
      // ブラウザで実行する場合はアラート表示
      //if( typeof window !== 'undefined' ) alert(e.stack);
      //throw e; //以降の処理を全て停止する場合
      v.rv.stack = e.stack; return v.rv; // 処理継続する場合
    }

  }

  /** entryNo(ID)を認証局に送信
   * @param {void}
   * @returns {void}
   */
  async getEntryNo(){
    const v = {rv:null,data:{cp:this.RSA.pKey}};
    console.log('Auth.getEntryNo start.');
    try {

      v.step = '1'; // 入力フォームから値を取得
      this.#changeScreen('loading');
      this.entryNo.value = this.entryNo.element.querySelector('input').value;
      v.arg = { // auth1Aに渡す引数
        entryNo: this.entryNo.value,
        publicKey: this.RSA.pKey,
      }
      console.log('arg',v.arg);

      v.step = '2'; // fetch
      v.rv = await this.#fetchFromClient('auth1A',v.arg,0);
      //if( v.rv instanceof Error ) throw v.rv;
      if( v.rv.isErr ){
        this.#changeScreen('entryNo');
      } else {
        this.gateway.pKey = v.rv.result;
        console.log('this.gateway.pKey='
          + JSON.stringify(this.gateway.pKey));
        this.#changeScreen('passCode');
      }

      console.log('Auth.getEntryNo end.');
      return v.rv;
    } catch(e){
      console.error('Auth.getEntryNo abnormal end.',e);
      return e;
      // ブラウザで実行する場合はアラート表示
      //if( typeof window !== 'undefined' ) alert(e.stack);
      //throw e; //以降の処理を全て停止する場合
      //v.rv.stack = e.stack; return v.rv; // 処理継続する場合
    }
  }

  /** メールから入力したpassCodeを認証局に送信
   * @param {void}
   * @returns {void}
   */
  async getPassCode(){
    const v = {rv:null,data:{cp:this.RSA.pKey}};
    console.log('Auth.getPassCode start.');
    try {

      // 入力フォームから値を取得
      this.#changeScreen('loading');
      v.arg = { // auth1Bに渡す引数
        entryNo: this.entryNo.value,
        passCode: this.passCode.element.querySelector('input').value,
      }
      console.log('arg',v.arg);
      v.rv = await this.#fetchFromClient('auth2A',v.arg,3);
      if( v.rv instanceof Error ) throw v.rv;
      if( v.rv.isErr ){
        console.log(v.rv);
        if( v.rv.result ){
          this.#changeScreen('entryNo');
        } else {
          this.#changeScreen('passCode');
        }
      } else {
        // 申請者情報と共通鍵を格納
        this.commonKey = v.rv.result.common;
        this.info = v.rv.result.info;
        console.log('commonKey='+this.commonKey,'info',this.info);
        // パスコード入力画面を閉じる
        this.#changeScreen('close');
      }

      console.log('Auth.getPassCode end.');
      return v.rv;
    } catch(e){
      console.error('Auth.getPassCode abnormal end.',e);
      return e;
      // ブラウザで実行する場合はアラート表示
      //if( typeof window !== 'undefined' ) alert(e.stack);
      //throw e; //以降の処理を全て停止する場合
      //v.rv.stack = e.stack; return v.rv; // 処理継続する場合
    }
  }

  /** GASのAPI(doPost)を呼び出す
   * @param {string} to - 呼び先(gateway or front)
   * @param {string} func - 呼び先関数名(auth1A等)
   * @param {Object} data - 呼び先関数に渡すデータオブジェクト
   * @returns {Object} 呼び先からの戻り値
   * 
   * - JS: [Async/await](https://ja.javascript.info/async-await)
   * - MDN: [フェッチが成功したかの確認](https://developer.mozilla.org/ja/docs/Web/API/Fetch_API/Using_Fetch#%E3%83%95%E3%82%A7%E3%83%83%E3%83%81%E3%81%8C%E6%88%90%E5%8A%9F%E3%81%97%E3%81%9F%E3%81%8B%E3%81%AE%E7%A2%BA%E8%AA%8D)
   * - MDN: [fetch()](https://developer.mozilla.org/ja/docs/Web/API/fetch)
   * - MDN: [Response Object](https://developer.mozilla.org/ja/docs/Web/API/Response)
   * - Qiita: [Fetch APIでネットワークエラーも含めてエラーハンドリングする](https://qiita.com/IzumiSy/items/031df1df4f4541e536b4)
   */
  async #fetchFromClient(fc,arg,md=0){
    const v = {rv:null,data:{cp:this.RSA.pKey}};
    console.log('Auth.#fetchFromClient start.');
    try {

      v.step = '1'; // 送信するトークンを生成
      v.token = {
        fm: this.entryNo.value,
        to: 'gateway',
        md: md,
        ts: Date.now(),
        dt: {
          fc: fc,
          arg: arg,
        }
      };
      console.log('v.token',v.token);

      v.step = '2'; // 暗号化・署名
      if( md === 1 ){ // 共通鍵で暗号化
        v.token.dt = encryptAES(
          JSON.stringify(v.token.dt),this.commonKey);
      } else if( md === 2 || md === 3 ){
        v.plaintext = JSON.stringify(v.token.dt);
        v.encode = encodeURI(v.plaintext);
        v.encrypt = md === 2  // 2:署名無し暗号化、3:署名付き暗号化
        ? cryptico.encrypt(v.encode,this.gateway.pKey)
        : cryptico.encrypt(v.encode,this.gateway.pKey,this.RSA.sKey);
        console.log('encrypt',v.encrypt);
        if( v.encrypt.status !== 'success' )
          throw new Error(JSON.stringify(v.encrypt));
        v.token.dt = v.encrypt.cipher;
      }
      console.log('v.token',v.token);

      v.step = '3'; // fetch
      v.fetch = await fetch(this.gateway.url,{
        "method": "POST",
        "body": JSON.stringify(v.token),
        "Accept": "application/json",
        "Content-Type": "application/json",
      });
      v.rv = await v.fetch.json();
      console.log(v.rv);
      if( v.rv instanceof Error ) throw v.rv;
      if( v.rv.isErr ){
        console.error(
          'Auth.#fetchFromClient abnormal end.'
          + '\n' + v.rv.message
          + '\n' + v.rv.stack
        );
        alert(v.rv.message);
      }

      console.log('Auth.#fetchFromClient normal end.');
      return v.rv;
    } catch(e){
      console.error('Auth.#fetchFromClient abnormal end.',e);
      return e;
      // ブラウザで実行する場合はアラート表示
      //if( typeof window !== 'undefined' ) alert(e.stack);
      //throw e; //以降の処理を全て停止する場合
      //v.rv.stack = e.stack; return v.rv; // 処理継続する場合
    }
  }
}

</script>
<script type="text/javascript">
/**
 * Array型の変数に2次元配列からHTMLの表を作成してtable要素として返すメソッドを追加する。
 * 
 * 使用前`Array.prototype.tabulize = Array.tabulize;`実行のこと。
 * 
 * @param {Object} [opt]
 * @param {string} opt.dateFormat {string} - 配列内のDateを表示する日時形式指定文字列(yMdhms.n)
 * @returns {HTMLTableObject}
 */

function Array_tabulize(opt){
 console.log('tabulize start.');
  const v = {
    table: document.createElement('table'),
    thead: document.createElement('thead'),
    tbody: document.createElement('tbody'),
    createElement: (tag,text='',opt={}) => {
      let rv = document.createElement(tag);
      rv.innerHTML = text;
      for( let x in opt ){
        rv.setAttribute(x,opt[x]);
      }
      return rv;
    },
  };
  console.log('tabulize end.');

  v.tr = v.createElement('tr');
  console.log(this[0]);
  for( v.i=0 ; v.i<this[0].length ; v.i++ ){
    v.tr.appendChild(v.createElement('th',this[0][v.i]));
  }
  v.thead.appendChild(v.tr);

  for( v.r=1 ; v.r<this.length ; v.r++ ){
    v.tr = v.createElement('tr');
    console.log(this[v.r]);
    for( v.c=0 ; v.c<this[v.r].length ; v.c++ ){
      v.raw = this[v.r][v.c];
      v.opt = {};
      switch( whichType(v.raw) ){
        case 'BigInt':
        case 'Number':
          v.text = Number(v.raw).toLocaleString();
          v.opt.style = 'text-align:right';
          break;
        case 'Date':
          v.text = v.raw.toLocale(opt.dateFormat);
        default:
          v.text = String(v.raw);
      }
      v.tr.appendChild(v.createElement('td',v.text,v.opt));
    }
    v.tbody.appendChild(v.tr);
  }

  v.table.appendChild(v.thead);
  v.table.appendChild(v.tbody);
  console.log(v.table)
  return v.table;
}
Array.prototype.tabulize = Array_tabulize;
</script>
<script type="text/javascript">/* コアスクリプト */
/**
 * @typedef {Object} createElementDef
 * @prop {string} tag='div' - タグ名
 * @prop {Object.<string,string>} [attr] - タグに設定する属性。ex.attr:{name:'hoge'}
 * @prop {Object.<string,boolean>} [logical] - 論理属性(ex.disabled)。trueなら追加
 * @prop {Object.<string,string>} [style] - 〃スタイル。ex.style:{display:'none'}
 * @prop {Object.<string,string>} [event] - 〃イベント。ex.event:{onclick:()=>{〜}}
 * @prop {string} [text] - タグ内にセットする文字列
 * @prop {string} [html] - タグ内にセットするhtml文字列
 * @prop {createElementDef[]} [children] - 子要素の配列
 */

/**
 * HTMLの要素を生成
 * @param {createElementDef|string} arg - 生成する要素の定義
 * @returns {HTMLElement} 生成された要素
 */
function createElement(arg={}){
  const v = {rv:null,arg:{}};
  //console.log('createElement start.');

  // 既定値の設定
  v.arg = mergeDeeply(
    {tag: 'div',attr: {},style:{},event:{},text: '',html:'',children:[]},
    (typeof arg === 'string' ? {tag:arg} : arg));
  //console.log(v.arg);

  v.rv = document.createElement(v.arg.tag);
  for( v.i in v.arg.attr ){ // 属性の設定
    v.rv.setAttribute(v.i,v.x = v.arg.attr[v.i]);
  }
  for( v.i in v.arg.logical ){  // 論理属性の設定
    if( v.arg.logical[v.i] ){
      v.rv.setAttribute(v.i,true);
    }
  }
  for( v.i in v.arg.style ){ // スタイルの設定
    if( v.i.match(/^\-\-/) ){ // CSS変数の場合
      v.rv.style.setProperty(v.i,v.arg.style[v.i]);
    } else {
      v.rv.style[v.i] = v.arg.style[v.i];
    }
    //console.log(v.i,v.arg.style[v.i],v.rv.style);
  }
  for( v.i in v.arg.event ){ // イベントの設定
    v.rv.addEventListener(v.i,v.arg.event[v.i],false);
    //console.log(v.i,v.arg.event[v.i],v.rv);
  }
  if( v.arg.html.length > 0 ){
    v.rv.innerHTML = v.arg.html;
  } else {
    v.rv.innerText = v.arg.text;  // 内部文字列
  }
  for( v.i=0 ; v.i<v.arg.children.length ; v.i++ ){
    // 子要素の追加
    v.rv.appendChild(createElement(v.arg.children[v.i]));
  }
  //console.log('createElement end.',v.rv);
  return v.rv;
}
</script>
<script type="text/javascript">/* コアスクリプト */
/** createPassword: パスワード文字列の生成
 * @desc シングル/ダブルクォーテーションはJavaScript上文字列として扱う際にエスケープが必要になるので除外
 * @param {number} [len=16] - パスワードの文字長
 * @param {boolean} [opt.lower=true] - 小文字を使用するならtrue 
 * @param {boolean} [opt.upper=true] - 大文字を使用するならtrue 
 * @param {boolean} [opt.symbol=true] - 記号を使用するならtrue 
 * @param {boolean} [opt.numeric=true] - 数字を使用するならtrue 
 * @returns {string} 生成されたパスワード文字列
 */
 function createPassword(len=16,opt={lower:true,upper:true,symbol:true,numeric:true}){
  const v = {
    whois: 'createPassword',
    lower: 'abcdefghijklmnopqrstuvwxyz',
    upper: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
    symbol: '!#$%&()=~|@[];:+-*<>?_>.,', // クォーテーションは除外
    numeric: '0123456789',
    base: '',
    rv: '',
  }
  try {
    Object.keys(opt).forEach(x => {
      if( opt[x] ) v.base += v[x];
    });
    for( v.i=0 ; v.i<len ; v.i++ ){
      v.rv += v.base.charAt(Math.floor(Math.random() * v.base.length));
    }
  } catch(e) {
    console.error(v.whois+' abnormal end.\n'+e.stack+'\n'+JSON.stringify(v));
    v.rv = e;
  } finally {
    return v.rv;
  }
}
</script>
<script type="text/javascript">/* コアScript */
/**
 * @typedef {Object} encryptAES
 * @prop {string} salt - ソルト
 * @prop {string} iv - 初期ベクトル
 * @prop {string} encrypted - 暗号化された文字列
 */

/** 共通鍵(AES)による暗号化処理
 * @param {string} text - 暗号化対象の文字列
 * @param {string} pass - パスワード
 * @returns {encryptAES}
 * 
 * - [JavaScript AES暗号・復号](https://chigusa-web.com/blog/js-aes/)
 */
function encryptAES(text, pass) {
  // ソルト
  const salt = CryptoJS.lib.WordArray.random(128 / 8);

  // 初期ベクトル
  const iv = CryptoJS.lib.WordArray.random(128 / 8);

  // AESキーの生成(128bit、5万回)
  const key = CryptoJS.PBKDF2(pass, salt, {
    keySize: 128 / 32,
    iterations: 50000,
    hasher: CryptoJS.algo.SHA256,
  });

  // AESキーで暗号化
  const encrypted = CryptoJS.AES.encrypt(text, key, {
    iv: iv,
  });

  return {
    salt: salt,
    iv: iv,
    encrypted: encrypted,
  };
}

/** 共通鍵(AES)による復号化処理
 * @param {encryptAES} encryptedData - 暗号化の際の出力結果
 * @param {string} pass - パスワード
 * @returns {string} 復号された文字列
 */
function decryptAES(encryptedData, pass) {
  // AESキーの生成(128bit、5万回)
  const key = CryptoJS.PBKDF2(pass, encryptedData.salt, {
    keySize: 128 / 32,
    iterations: 50000,
    hasher: CryptoJS.algo.SHA256,
  });

  // AESキーで復号
  const decrypted = CryptoJS.AES.decrypt(encryptedData.encrypted, key, {
    iv: encryptedData.iv,
  });

  return decrypted.toString(CryptoJS.enc.Utf8);
}
</script>
<script type="text/javascript">
/** 日時を指定形式の文字列にして返す"toLocale()"メソッドをDate型に追加する。
 * @param {string} [format='yyyy/MM/dd'] - 日時を指定する文字列。年:y,月:M,日:d,時:h,分:m,秒:s,ミリ秒:n
 * @returns {string} 指定形式に変換された文字列。無効な日付なら長さ0の文字列
 * 
 * @example
 * ```
 * "1965/9/5"[yy/MM/dd hh:mm:ss.nnn] ⇒ "65/09/05 00:00:00.000"
 * "1965/9/5"[yyyy-MM-dd] ⇒ "1965-09-05"
 * "1965/9/5"[hh:mm] ⇒ "00:00"
 * "1977-03-04"[yy/MM/dd hh:mm:ss.nnn] ⇒ "77/03/04 09:00:00.000"
 * "1977-03-04"[yyyy-MM-dd] ⇒ "1977-03-04"
 * "1977-03-04"[hh:mm] ⇒ "09:00"
 * 1688189258262[yy/MM/dd hh:mm:ss.nnn] ⇒ "23/07/01 14:27:38.262"
 * 1688189258262[yyyy-MM-dd] ⇒ "2023-07-01"
 * 1688189258262[hh:mm] ⇒ "14:27"
 * "Sat Jul 01 2023 14:16:30 GMT+0900"[yy/MM/dd hh:mm:ss.nnn] ⇒ "23/07/01 14:16:30.000"
 * "Sat Jul 01 2023 14:16:30 GMT+0900"[yyyy-MM-dd] ⇒ "2023-07-01"
 * "Sat Jul 01 2023 14:16:30 GMT+0900"[hh:mm] ⇒ "14:16"
 * "12:34"[yy/MM/dd hh:mm:ss.nnn] ⇒ ""
 * "12:34"[yyyy-MM-dd] ⇒ ""
 * "12:34"[hh:mm] ⇒ ""
 * ```
 */

function Date_toLocale(format='yyyy/MM/dd'){
  //console.log('===== Date.toLocale start.');
  const v = {rv:format};
  try {

    // 無効な日付なら空文字列を返して終了
    if( isNaN(this.getTime()) ) return '';

    v.l = { // 地方時ベース
      y: this.getFullYear(),
      M: this.getMonth()+1,
      d: this.getDate(),
      h: this.getHours(),
      m: this.getMinutes(),
      s: this.getSeconds(),
      n: this.getMilliseconds()
    };

    //v.rv = typeof format === 'undefined' ? 'yyyy/MM/dd' : format;
    for( v.x in v.l ){
      v.m = v.rv.match(new RegExp(v.x+'+'));
      if( v.m ){
        v.str = v.m[0].length > 1
          ? ('000'+v.l[v.x]).slice(-v.m[0].length)
          : String(v.l[v.x]);
        v.rv = v.rv.replace(v.m[0],v.str);
      }
    }

    //console.log('v.rv='+JSON.stringify(v.rv));
    //console.log('===== Date.toLocale end.');
    return v.rv;
  } catch(e){
    // ブラウザで実行する場合はアラート表示
    if( typeof window !== 'undefined' ) alert(e.stack); 
    //throw e; //以降の処理を全て停止
    v.rv.stack = e.stack; return v.rv; // 処理継続
  }
}
Date.prototype.toLocale = Date_toLocale;
</script>
<script type="text/javascript">
/**
 * @desc オブジェクトのプロパティを再帰的にマージ
 * - Qiita [JavaScriptでオブジェクトをマージ（結合）する方法、JSONのマージをする方法](https://qiita.com/riversun/items/60307d58f9b2f461082a)
 * 
 * @param {Object} target - 結合対象のオブジェクト1
 * @param {Object} source - 結合対象のオブジェクト2。同名のプロパティはこちらで上書き
 * @param {Object} opts - オプション
 * @param {boolean} [opts.concatArray=false] - プロパティの値が配列だった場合、結合するならtrue
 * @returns {Object} 結合されたオブジェクト
 */

function mergeDeeply(target, source, opts) {
  const isObject = obj => obj && typeof obj === 'object' && !Array.isArray(obj);
  const isConcatArray = opts && opts.concatArray;
  let result = Object.assign({}, target);
  if (isObject(target) && isObject(source)) {
    for (const [sourceKey, sourceValue] of Object.entries(source)) {
      const targetValue = target[sourceKey];
      if (isConcatArray && Array.isArray(sourceValue) && Array.isArray(targetValue)) {
        result[sourceKey] = targetValue.concat(...sourceValue);
      }
      else if (isObject(sourceValue) && target.hasOwnProperty(sourceKey)) {
        result[sourceKey] = mergeDeeply(targetValue, sourceValue, opts);
      }
      else {
        Object.assign(result, {[sourceKey]: sourceValue});
      }
    }
  }
  return result;
}
</script>
<script type="text/javascript">/* コアスクリプト */
/**
 * @classdesc タブ切り替えのHTMLページを作成する
 */

/**
 * @typedef {Object} TabMenuMembers
 * @prop {TabMenuArg} option - オプション
 * @prop {string} wrapperSelector - 全体の親要素を特定するCSSセレクタ文字列
 * @prop {HTMLElement} wrapper - 全体の親要素
 * @prop {HTMLElement} tabs - タブ表示領域の要素
 * @prop {Object.<string,HTMLElement>} tab - タブ領域内の個々のタブ
 * @prop {string[]} pageList - ページ名のリスト
 * @prop {Object.<string,HTMLElement>} page - タブに対応した個々のページ
 * @prop {number} tabNum - タブ表示領域に表示するタブの数
 */

class TabMenu {

  /**
   * @constructor
   * @param {string} [opt={}] - オプション。内容はthis.option参照
   * @returns {void}
   */
  constructor(opt={}){
    console.log('TabMenu.constructor start.');
    const v = {};
    this.option = mergeDeeply({
      name: null, // {string} 対象となるページ全体のname属性。nullなら単一で特定不要と解釈
      initial: null,  // {string} 初期表示ページの名前
      direction: 'x', // {string} タブを並べる方向。x:横並び, y:縦並び
      style: {  // {Object} CSSスタイル定義
        tabs: {
          selector: ".TabMenu .tabs",
          css: {
            width: "100%",
            height: "100%",
            margin: "0px 0px 1rem 0px",
            padding: "0px",
            boxSizing: "border-box",
            display: "grid",
            fontSize: "1rem",
          },
        },
        tab: {
          selector: ".TabMenu .tabs div",
          css: {
            paddingLeft: "1rem",
            borderBottom: "solid 4px #ccc",
          },
        },
        act: {
          //selector: ".TabMenu .tabs div.act",
          css: {
            paddingLeft: "1rem",
            borderBottom: "solid 4px #000",
          },
        }
      },
    },opt);
    //console.log(this.option);

    // 全体の親要素をthis.wrapper、タブ表示領域をthis.tabsに保存
    this.wrapperSelector = '.TabMenu'
      +( this.option.name === null ? '' : '[name="' + this.option.name + '"]');
    this.wrapper = document.querySelector(this.wrapperSelector);

    // タブ表示領域を生成
    this.tabs = document.createElement('div');
    this.tabs.classList.add('tabs');
    this.wrapper.querySelectorAll(this.wrapperSelector+' > div[name]').forEach(x => {
      v.item = document.createElement('div');
      v.name = x.getAttribute('name');
      v.item.setAttribute('name',v.name);
      v.item.innerText = v.name;
      this.tabs.appendChild(v.item);
    });
    this.wrapper.prepend(this.tabs);
    //console.log(this.wrapper);

    // スタイルの適用
    for( v.x of ['tabs','tab'] ){ // actは不要
      this.wrapper.querySelectorAll(this.option.style[v.x].selector).forEach(element => {
        for( v.y in this.option.style[v.x].css ){
          element.style[v.y] = this.option.style[v.x].css[v.y];
        }
      });
    }

    // ページ名のリストを作成
    this.pageList = [];
    this.tabs.querySelectorAll('[name]')
    .forEach(x => this.pageList.push(x.getAttribute('name')));
    //console.log(this.pageList);

    // 各タブ・ページの要素をthis.tab/pageに保存
    this.tab = {};
    this.page = {};
    this.tabNum = 0;
    this.pageList.forEach(x => {
      this.tab[x] = this.wrapper.querySelector('.tabs [name="'+x+'"]');
      // ページは「TabMenuクラス直下のDIV」に限定
      this.page[x] = this.wrapper.querySelector('.TabMenu > div[name="'+x+'"]');
      //console.log(x,this.tab[x],this.page[x]);
      this.tab[x].addEventListener('click',()=>this.changePage(x));
      this.tabNum++;
    });
    // タブの数をタブ領域に設定
    this.tabs.style.gridTemplateColumns = 'repeat('+this.tabNum+',1fr)';

    // 特に指定がない場合、初期ページは最初の要素とする
    if( this.option.initial === null ) this.option.initial = this.pageList[0];
    this.changePage(this.option.initial); // 初期ページ
    console.log('TabMenu.constructor end.');
  }

  changePage(page){
    console.log('TabMenu.changePage start. page='+page);
    this.pageList.forEach(x => {
      if( x === page ){
        for( let y in this.option.style.act.css ){
          this.tab[x].style[y] = this.option.style.act.css[y];
        }
        this.page[x].style.display = '';
      } else {
        for( let y in this.option.style.tab.css ){
          this.tab[x].style[y] = this.option.style.tab.css[y];
        }
        this.page[x].style.display = 'none';
      }
    })
    console.log('TabMenu.changePage end.');
  }
}
</script>
<style type="text/css">/* コアCSS */
.right {text-align: right;}
.image, .TimeTable {
  max-width: 100%;
}
.TimeTable, .TimeTable div {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  display: grid;
  --color: #ccc;
  --boldLine : solid 2px var(--color);
  --thinLine : dotted 1px var(--color);
}
.TimeTable span {
  padding-left: 0.3rem;
  white-space: nowrap;
}
/*.TimeTable .controller {}*/
.TimeTable .main {
  grid-template-rows: 2rem 1fr;
  grid-template-columns: 1fr;
  overflow: auto;
}
.TimeTable .main .header {
  grid-row: 1/2;
  grid-column: 1/2;
  grid-template-columns: repeat(3, 1fr);
  border: var(--boldLine);
}
.TimeTable .main .header div:nth-child(2n) {
  background-color: var(--color);
}
.TimeTable .main .timeline {
  grid-row: 2/3;
  grid-column: 1/2;
  grid-template-columns: repeat(12, 1fr);
  border-bottom: var(--boldLine);
}
.TimeTable .main .timeline div {
  min-width: 1rem;
  min-height: 1rem;
}
.TimeTable .main .timeline div:nth-child(2n+1) {
  border-left: var(--boldLine);
}
.TimeTable .main .timeline div:nth-child(2n) {
  border-left: var(--thinLine);
}
.TimeTable .main .timeline div:last-child {
  border-right: var(--boldLine);
}
.TimeTable .main .tasks {
  grid-row: 2/3;
  grid-column: 1/2;
  z-index: 1;
}
.TimeTable .main .tasks > div {
  max-height: 1.6rem;
  grid-column: 1/37;
  margin-bottom: 0.5rem;
}
.TimeTable .main .tasks > div:first-child {
  margin-top: 0.5rem;
}
.TimeTable .main .tasks .bar {
  grid-template-columns: repeat(36, 1fr);
}
.TimeTable .main .tasks .bar [name="1.1"]{
  grid-column: 4/12;
  background-color: var(--color);
}
.TimeTable .main .tasks .bar [name="1.2"]{
  grid-column: 15/20;
  background-color: var(--color);
}

.TimeTable .detail {
  margin-top: 1rem;
  display: none;
}
.TimeTable .detail div {
  padding: 0.5rem;
}
.TimeTable .detail > div {
  grid-template-columns: 5rem 1fr;
}
.TimeTable .detail .button {
  height: 3rem;
  margin-bottom: 1rem;
  display: flex;
}
.TimeTable .detail .button button {
  margin-left: 2rem;
  height: 2rem;
}
/*
  テーブル関係
*/
.TimeTable th {
  padding: 0.3em;
  background-color: #888;
  color: white;
}
.TimeTable td {
  padding: 0.3em;
  border-bottom: solid 1px #aaa;
  border-right: solid 1px #aaa;
}
</style>
<script type="text/javascript">/* コアスクリプト */
/**
 * @typedef {Object} opt
 * @prop {string} datatype - データのタイプ。sheet:シートデータ
 */

/**
 * @classdesc HTMLにタイムテーブルを描画する
 */

class TimeTable {
  
  /**
   * @constructor
   * @param {string} selector - タイムテーブルを描画する要素のCSSセレクタ
   * @param {Object} data - タイムテーブル用のデータ
   * @param {Object} opt - オプションを指定するオブジェクト
   * @returns {void}
   * 
   * @desc 既定値の設定、タスクデータ他のデータ加工を行い、タイムテーブルを描画する
   * 
   * <details><summary>入力シートイメージ</summary>
   * 
   * - start/endが赤字：マイルストーン(非導出項目、要手動設定)
   * - 背景色群青：セクション・タスク共通の必須項目
   * - 薄青：同任意項目
   * - 濃緑：タスクのみの必須項目
   * - 薄緑：同任意項目
   * - 赤：算式が設定された項目
   * 
   * <h3>TimeTable</h3>
   * <table calss="tt"><tr>
   * <th style="background:#ff0000;color:white">id</th>
   * <th style="background:#0000ff;color:white;">pId</th>
   * <th style="background:#0000ff;color:white;">name</th>
   * <th style="background:#cfe2f3;">summary</th>
   * <th style="background:#cfe2f3;">pending</th>
   * <th style="background:#cfe2f3;">note</th>
   * <th style="background:#38761d;color:white;">start</th>
   * <th style="background:#d9ead3;">lasts</th>
   * <th style="background:#38761d;color:white;">end</th>
   * <th style="background:#d9ead3;">location</th>
   * <th style="background:#d9ead3;">ideal</th>
   * <th style="background:#d9ead3;">fixed</th>
   * <th style="background:#d9ead3;">output</th>
   * <th style="background:#d9ead3;">style</th>
   * </tr><tr>
   * <td>2</td><td>0</td><td>イベント(大線表)</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
   * </tr><tr>
   * <td>3</td><td>2</td><td>受付</td><td></td><td></td><td></td><td style="color:#f00;">9/30 13:30</td><td>30</td><td>9/30 14:00</td><td>正門</td><td></td><td></td><td></td><td></td>
   * </tr><tr>
   * <td>4</td><td>2</td><td>テント設営</td><td></td><td></td><td>子供達は体育館で遊ぶ</td><td>9/30 14:00</td><td></td><td>9/30 17:00</td><td>校庭</td><td></td><td></td><td></td><td></td>
   * </tr><tr>
   * <td>5</td><td>2</td><td>夕食</td><td></td><td></td><td></td><td style="color:#f00;">9/30 17:00</td><td>90</td><td>9/30 18:30</td><td>テントor喫食コーナ</td><td></td><td></td><td></td><td></td>
   * </tr><tr>
   * <td>6</td><td>2</td><td>肝試し</td><td></td><td></td><td></td><td>9/30 18:30</td><td>120</td><td>9/30 20:30</td><td>校内</td><td></td><td></td><td></td><td></td>
   * </tr><tr>
   * <td>7</td><td>2</td><td>宿泊</td><td></td><td></td><td></td><td>9/30 20:30</td><td></td><td style="color:#f00;">10/01 07:30</td><td>テントor体育館</td><td></td><td></td><td></td><td></td>
   * </tr><tr>
   * <td>8</td><td>2</td><td>朝食</td><td>素麺提供</td><td></td><td></td><td>10/01 07:30</td><td>30</td><td>10/01 08:00</td><td>テントor体育館</td><td></td><td></td><td></td><td></td>
   * </tr><tr>
   * <td>9</td><td>2</td><td>テント撤去</td><td></td><td></td><td></td><td>10/01 08:00</td><td>60</td><td>10/01 09:00</td><td>校庭</td><td></td><td></td><td></td><td></td>
   * </tr></table>
   * 
   * <h3>resources</h3>
   * <table><tr>
   * <th style="background:#0000ff;color:white;">tId</th>
   * <th style="background:#ff0000;color:white;">tName</th>
   * <th style="background:#ff0000;color:white;">id</th>
   * <th style="background:#0000ff;color:white;">name</th>
   * <th style="background:#cfe2f3;">quantity</th>
   * <th style="background:#cfe2f3;">unit</th>
   * <th style="background:#cfe2f3;">procure</th>
   * <th style="background:#cfe2f3;">budget</th>
   * <th style="background:#cfe2f3;">note</th>
   * </tr>
   * <tr><td>17</td><td>参加者受付</td><td>2</td><td>参加者名簿</td><td>3</td><td>冊</td><td>嶋津作成</td><td>0</td><td></td></tr>
   * <tr><td>17</td><td>参加者受付</td><td>3</td><td>文鎮</td><td>3</td><td>個</td><td></td><td></td><td></td></tr>
   * <tr><td>17</td><td>参加者受付</td><td>4</td><td>貯金箱</td><td>1</td><td>個</td><td></td><td></td><td></td></tr>
   * <tr><td>17</td><td>参加者受付</td><td>5</td><td>トレイ</td><td>3</td><td>個</td><td></td><td></td><td></td></tr>
   * <tr><td>17</td><td>参加者受付</td><td>6</td><td>ガムテープ</td><td>2</td><td>個</td><td></td><td></td><td>テントの有無で色を変える</td></tr>
   * <tr><td>17</td><td>参加者受付</td><td>7</td><td>おやじの会入会申込書</td><td>20</td><td>枚</td><td></td><td></td><td></td></tr>
   * </table>
   * </details>
   * 
   */

  constructor(selector,data,opt){
    this.rootElement = document.querySelector(selector);
    this.rootElement.innerHTML = `
      <div class="controller"></div>
      <div class="main">
        <div class="header"></div>
        <div class="timeline"></div>
        <div class="tasks"></div>
      </div>
      <div class="detail">
        <div class="button">
          <button name="close">閉じる</button>
          <button name="edit">編集</button>
        </div>
        <table>
          <thead>
            <tr><th>項目</th><th>値</th><th>備考</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    `;
    // オプションの既定値設定
    this.opt = mergeDeeply({
      datatype: null, // dataが加工済ならnull
      unit: 5,
      design: {
        default: {
          color: "#000",
          backgroundColor: "rgba(196,196,196,0.6)",
          border: "solid 1px #aaa",
        },
        critical: {
          color: "#fff",
          backgroundColor: "rgba(255,96,96,0.6)",
          border: "solid 1px #f00",
        },
      },
      detailDateFormat: 'M/dd hh:mm', // 詳細画面に表示する日時の形式
      dataSheet: null,  // 元データを格納したGoogle SpreadのURL
    },opt);
    console.log(this.opt);

    // シート形式のデータだった場合、加工してthis.tasksにセット
    this.tasks = this.opt.datatype === null ? data : this.#process(data);
    console.log(this.tasks);

    // map(id->タスク)の作成
    this.map = {};
    this.#makeMap(this.tasks);

    // タイムテーブルを描画
    this.draw();
  }

  /** div.tasks領域にタスク(単体)を追加する
   * (本関数はdrawから呼ばれるプライベート関数)
   */
  #appendTask(task,pId=''){ // ガントチャートの作成
    const v = {
      tasksElement: this.rootElement.querySelector('.main .tasks'),
    };
    /*
    // taskのIDを採番、マップに追加
    task.id = pId + (seq+1) + '.';
    this.data.map[task.id] = task;
    */

    if( 'children' in task ){
      // childrenが存在⇒セクション(ラベル)行
      v.labelElement = this.createElement({class:'label'});
      //v.labelSpan = this.createElement({tag:'span',text:task.name});
      //v.labelSpan.onclick = () => this.showDetail(task.id);
      v.labelSpan = this.createElement('span');
      v.labelSpan.innerText = '▼'+task.name;
      v.labelSpan.onclick = () => this.toggleChildren(task.id,v.labelSpan);
      v.labelElement.appendChild(v.labelSpan);
      v.tasksElement.appendChild(v.labelElement);
      for( let i=0 ; i<task.children.length ; i++ ){
        this.#appendTask(task.children[i],task.id);
      }
    } else {
      // childrenが不存在⇒タスク行
      v.barElement = this.createElement({class:'bar pId'+pId});
      v.barElement.style.gridTemplateColumns
        = 'repeat('+(this.numHour*12)+', 1fr)';
      // barSpan: 棒状の部分
      v.barSpan = this.createElement(
        {tag:'span',name:task.id,text:task.name});
      v.barStart = ((new Date(task.start).getTime())
        - this.startHour) / (this.opt.unit*60000) + 1;
      v.barEnd = ((new Date(task.end).getTime())
        - this.startHour) / (this.opt.unit*60000) + 1;
      this.applyStyle({
        element: v.barSpan,
        apply: task.style,
        addition: {gridColumn:v.barStart + '/' + v.barEnd},
      });
      v.barSpan.onclick = () => this.showDetail(task.id);
      v.barElement.appendChild(v.barSpan);
      v.tasksElement.appendChild(v.barElement);
    }
  }

  /** 要素にスタイルを設定する
   * @param {Object} arg
   * @param {string} arg.apply - 適用するスタイル名
   * @param {Object.<string, string>} arg.addition - 追加適用する属性名：属性値
   * @returns {void}
   */
  applyStyle(arg){
    // apply,additionの既定値設定
    if( arg.apply.length === 0 ) arg.apply = 'default';
    const v = Object.assign({apply:'default',addition:{}},arg);
    // 適用するスタイルのオブジェクトを作成
    v.style = Object.assign(this.opt.design[v.apply],v.addition);
    for( let a in v.style ){
      arg.element.style[a] = v.style[a];
    }
  }

  /** DIV要素を生成、属性を指定する
   * @param {string} tag='div' - タグ名
   * @param {string} [text] - 生成された要素のinnerHTML
   * @param {Object.<string, string>} xxx - 生成された要素に設定するスタイルシート属性名：属性値
   */
  createElement(arg='div'){
    const v = {tag:'div',opt:arg};
    if( typeof arg === 'string' ){
      v.tag = arg;
      v.opt = {};
    } else {
      if( 'tag' in arg ){
        v.tag = arg.tag;
      } 
    }
    let rv = document.createElement(v.tag);
    for( let x in v.opt ){
      switch(x) {
        case 'tag': break;
        case 'text': rv.innerHTML = arg.text; break;
        default: rv.setAttribute(x,arg[x]);
      }
    }
    return rv;
  }

  /** タイムテーブルを(再)描画する */
  draw(){
    console.log("draw start.");

    const v = {};
    this.minTime = Infinity; // task.startの最小値。UNIX時刻
    this.maxTime = -Infinity;
    this.startHour = Infinity; // minTime以下の正時となるUNIX時刻。表示領域の左端
    this.endHour = -Infinity;  // maxTime以上の正時となるUNIX時刻。表示領域の右端
    this.numHour = 0;          // startHour〜endHourまでの時間数    console.log(this.data);

    // 描画範囲を計算
    this.timeRange(this.tasks);  // minTime, v.maxTimeの取得
    this.startHour = Math.floor(this.minTime / 3600000) * 3600000;
    this.endHour = Math.ceil(this.maxTime / 3600000) * 3600000;

    // 1.controllerの要素を作成

    // 2.mainの要素を作成

    // 2.1.main.headerの要素を作成
    v.headerElement = this.rootElement.querySelector('.main .header');
    v.headerElement.innerHTML = '';
    for( v.i=this.startHour ; v.i<=this.endHour ; v.i+=3600000 ){
      v.o = this.createElement();
      v.o.innerText = new Date(v.i).getHours() + ':00';
      v.headerElement.appendChild(v.o);
      this.numHour++;
    }
    v.headerElement.style.gridTemplateColumns = 'repeat('+this.numHour+', 1fr)';

    // 2.2.main.timelineの要素を作成
    v.timelineElement = this.rootElement.querySelector('.main .timeline');
    v.timelineElement.innerHTML = '';
    v.timelineElement.innerHTML = '<div></div>'.repeat(this.numHour*4);
    v.timelineElement.style.gridTemplateColumns = 'repeat('+(this.numHour*4)+', 1fr)';

    // 2.2.main.tasksの要素を作成
    v.tasksElement = this.rootElement.querySelector('.main .tasks');
    v.tasksElement.innerHTML = '';
    for( let i=0 ; i<this.tasks.length ; i++ ){
      this.#appendTask(this.tasks[i],'');
    }

    // 3.detailの要素を作成


    console.log("draw end.");
  }

  /** タスクID->タスク取得用のthis.mapを作成 */
  #makeMap(tasks){
    console.log('makeMap start.');
    const v = {};
    for( v.i=0 ; v.i<tasks.length ; v.i++ ){
      this.map[tasks[v.i].id] = tasks[v.i];
      if( 'children' in tasks[v.i] ){
        this.#makeMap(tasks[v.i].children );
      }
    }
    console.log('makeMap end.');
  }

  #process(raw){
    const v = {sheet:[{children:[]}],idmap:{0:0}};
    console.log('process start.');

    this.tasks = [];
    // 01.configシート
    this.opt.sheetDef = {};
    v.header = raw.config[0]; // ヘッダ行
    for( v.i=1 ; v.i<raw.config.length ; v.i++ ){
      v.l = raw.config[v.i];
      if( String(v.l[0]).length > 0 ){ // 空白行スキップ
        v.o = {};
        for( v.j=1 ; v.j<v.l.length ; v.j++ ){
          v.o[v.header[v.j]] = v.l[v.j];
        }
        if( !(v.l[0] in this.opt.sheetDef) ){
          // シートのオブジェクトが未定義なら追加
          this.opt.sheetDef[v.l[0]] = {};
        }
        this.opt.sheetDef[v.l[0]][v.l[1]] = v.o;
      }
    }
    console.log(this.opt.sheetDef);

    // 02.TimeTableシート
    v.header = raw.TimeTable[0]; // ヘッダ行
    v.idmapIndex = 0; // v.idmapの添字
    console.log(v.header)
    // 02.1. v.sheetにリニアに追加する
    for( v.i=1 ; v.i<raw.TimeTable.length ; v.i++ ){
      v.l = raw.TimeTable[v.i];
      // 有効な行データをオブジェクト化する
      if( Number(v.l[0]) > 0 ){ // 空白行スキップ
        v.o = {resources:[]}; // 必要資機材のみTimeTableシート上にないので足しておく
        for( v.j=0 ; v.j<v.l.length ; v.j++ ){
          v.colType = this.opt.sheetDef.TimeTable[v.header[v.j]].type.toLowerCase();
          switch( v.colType ){
            case 'Date':
              v.o[v.header[v.j]] = new Date(v.l[v.j]).getTime();
              break;
            default:
              v.o[v.header[v.j]] = v.l[v.j];
          }
        }
        // 戻り値用のデータをセット
        v.idmapIndex++;
        v.idmap[v.o.id] = v.idmapIndex;
        v.sheet.push(v.o);
      }
    }
    console.log(v.sheet);
    console.log(v.idmap);

    // 02.2.親子関係を設定
    for( v.i=1 ; v.i<v.sheet.length ; v.i++ ){ // 0はrootなので飛ばす
      //console.log('v.sheet[v.i]=',v.sheet[v.i])
      //console.log('v.sheet[v.i].pId='+v.sheet[v.i].pId);
      //console.log('v.idmap[v.sheet[v.i].pId]='+v.idmap[v.sheet[v.i].pId]);
      //console.log('v.sheet['+v.idmap[v.sheet[v.i].pId]+']=',v.sheet[v.idmap[v.sheet[v.i].pId]]);
      v.parent = v.sheet[v.idmap[v.sheet[v.i].pId]];
      if( !('children' in v.parent) ) v.parent.children = [];
      v.parent.children.push(v.sheet[v.i]);
      console.log('v.sheet['+v.i+']=',v.sheet[v.i],'\nv.parent=',v.parent);
    }
    console.log(v.sheet);

    // [03] resourcesシート
    v.header = raw.resources[0];  // ヘッダ行
    for( v.i=1 ; v.i<raw.resources.length ; v.i++ ){
      v.o = {};
      for( v.j=0 ; v.j<v.header.length ; v.j++ ){
        v.o[v.header[v.j]] = raw.resources[v.i][v.j];
      }
      console.log('v.o=',v.o);
      console.log('v.idmap[v.o.tId]=',v.idmap[v.o.tId]);
      console.log('v.sheet[v.idmap[v.o.tId]]=',v.sheet[v.idmap[v.o.tId]]);
      v.parent = v.sheet[v.idmap[v.o.tId]];
      if( !('resources' in v.parent) ) v.parent.resources = [];
      v.parent.resources.push(v.o);
    }

    console.log('process end.');
    return v.sheet[0].children;
  }

  /** ダイアログに詳細情報を表示
   * @prop {string} id - 表示するタスクのID
   */
  showDetail(id){
    console.log('showDetail start. id='+id);
    const v = {
      task:this.map[id],  // 表示するタスクのオブジェクト
      detail: this.rootElement.querySelector('.detail'),  // 詳細領域の要素
      /** 非表示項目を排除しながら表示順に項目をソート
       * - [オブジェクトをdateでソートする例](https://keizokuma.com/js-array-object-sort/)
       * @param {Object} columnDef - 欄名:{column,label,type,memo,must,display,note}をメンバとするオブジェクト
       */
      listColumns: (columnDef) => { // 
        const list = [];
        Object.keys(columnDef).forEach(x => {
          if( columnDef[x].display > 0 ) list.push(columnDef[x]);
        });
        list.sort((a,b) => a.display < b.display ? -1 : 1);
        return list;
      },
    };

    // 前回の表示結果をクリア
    v.detail.querySelector('tbody').innerHTML = '';

    // 非表示項目を排除しながら表示順に項目をソート
    v.list = v.listColumns(this.opt.sheetDef.TimeTable);
    console.log(v.list);

    // 表示順にタスクの項目をtbodyに追加
    for( v.i=0 ; v.i<v.list.length ; v.i++ ){
      v.tr = this.createElement('tr');

      // 項目ラベル欄
      v.o = {tag:'td',text:v.list[v.i].label};
      v.tr.appendChild(this.createElement(v.o));
      // 値・備考欄
      v.value =  v.task[v.list[v.i].column] || '';
      if( v.list[v.i].type !== 'Resource'){
        // Resource(表内表)以外
        switch( v.list[v.i].type ){
          case 'Number':  // number : toLocaleして右寄せ
            v.o.class = 'right';
            v.o.text = v.value.toLocaleString();
            break;
          case 'Date':  // 表示形式を整形
            console.log(new Date(v.value));
            v.o.text = new Date(v.value).toLocale(this.opt.detailDateFormat);
            break;
          default:
            v.o.text = String(v.value);
        }
        v.tr.appendChild(this.createElement(v.o));
        // 備考欄
        v.o.text = v.task[v.list[v.i].memo] || '';
        v.tr.appendChild(this.createElement(v.o));
      } else {
        // Resource
        v.rList = v.listColumns(this.opt.sheetDef.resources);
        console.log(v.rList)
        v.rData = [v.rList.map(x => x.label)];
        for( v.r=0 ; v.r<v.task.resources.length ; v.r++ ){
          v.a = [];
          v.l = v.task.resources[v.r];
          console.log(v.l);
          for( v.c=0 ; v.c<v.rList.length ; v.c++ ){
            v.a.push(v.rList[v.c].type === 'Date'
            ? new Date(v.l[v.rList[v.c].column])
            : v.l[v.rList[v.c].column]);
          }
          v.rData.push(v.a);
        }
        console.log(v.rData);
        v.td = this.createElement({tag:'td',colspan:"2"});
        v.td.appendChild(v.rData.tabulize({dateFormat:this.opt.detailDateFormat}));
        v.tr.appendChild(v.td);
      }
      console.log(v.tr);

      v.detail.querySelector('tbody').appendChild(v.tr);
    }
    
    // 詳細画面の「閉じる」ボタン動作設定
    v.detail.querySelector('button[name="close"]').onclick
    = () => v.detail.style.display = 'none';
    // 「編集」ボタン動作設定
    if( this.opt.dataSheet !== null ){
      v.detail.querySelector('button[name="edit"]').onclick
      = () => window.open(this.opt.dataSheet,'_blank');
    }

    // 詳細画面表示
    v.detail.style.display = 'block';
    console.log('showDetail end.');

  }

  /** v.minTime, v.maxTimeの取得 */
  timeRange(tasks){
    const v = {};
    for( let task of tasks ){
      if( 'children' in task ){
        this.timeRange(task.children);
      } else {
        v.st = new Date(task.start).getTime();
        v.ed = new Date(task.end).getTime();
        if( this.minTime > v.st ) this.minTime = v.st;
        if( this.maxTime < v.ed ) this.maxTime = v.ed;
      }
    }
  }

  /** セクション名クリックで配下のタスクの表示/非表示切り替え */
  toggleChildren(id,label){
    this.rootElement.querySelectorAll('.pId'+id).forEach(x => 
      x.style.display = x.style.display === 'none' ? '' : 'none');
    // ラベルの前の三角を交換
    let m = label.innerText.match(/^([▶️|▼])(.+)$/);
    console.log(m)
    label.innerText = (( m[1] === '▼' ) ? '▶️' : '▼') + m[2];
  }

}
</script>
<script type="text/javascript">
/** 
 * 変数の型を判定し、型名を文字列で返す。なお引数"is"が指定された場合、判定対象が"is"と等しいかの真偽値を返す。
 * 
 * @param {any} arg - 判定対象の変数
 * @param {string} [is] - 想定される型(型名の大文字小文字は意識不要)
 * @returns {string|boolean} - 型の名前。is指定有りなら判定対象が想定型かの真偽値
 * 
 * @example
 * ```
 * let a = 10;
 * whichType(a);  // 'Number'
 * whichType(a,'string'); // false
 * ```
 * 
 * <b>確認済戻り値一覧</b>
 * 
 * オブジェクトは型名が返るので、限定列挙は困難。以下は確認済みの戻り値のみ記載。
 * 
 * | 型名 | 戻り値 | 備考 |
 * | :-- | :-- | :-- |
 * | 文字列 | String |  |
 * | 数値 | Number |  |
 * | NaN | NaN |  |
 * | 長整数 | BigInt |  |
 * | 論理値 | Boolean |  |
 * | シンボル | Symbol |  |
 * | undefined | Undefined | 先頭大文字 |
 * | Null | Null |  |
 * | オブジェクト | Object |  |
 * | 配列 | Array |  |
 * | 関数 | Function |  |
 * | アロー関数 | Arrow |  |
 * | エラー | Error | RangeError等も'Error' |
 * | Date型 | Date |  |
 * | Promise型 | Promise |  |
 *  
 * - Qiita [JavaScriptの型などの判定いろいろ](https://qiita.com/amamamaou/items/ef0b797156b324bb4ef3)
 * 
 */

function whichType(arg,is){
  let rv = String(Object.prototype.toString.call(arg).slice(8,-1));
  switch(rv){
    case 'Number': if(Number.isNaN(arg)) rv = 'NaN'; break;
    case 'Function': if(!('prototype' in arg)) rv = 'Arrow'; break;
  }
  if( typeof is === 'string' ){
    return rv.toLowerCase() === is.toLowerCase();
  } else {
    return rv;
  }
}
</script>

<script type="text/javascript" class="main">
function redraw(){
  const url = {
    GAS:'https://script.google.com/macros/s/AKfycbxtxS_u1BVahosczLxtt9yFS8Lh97lXEj4t7xmzCp4v1qgDft4RaSZUrbv-cMR0k03I/exec',
    sheet: 'https://tinyurl.com/2ahyly3l',
  };

  fetch(url.GAS)
  .then(response => response.json()).then(r => {
    const v = {};

    // Google Spreadからデータを取得してタイムテーブル表示
    v.TimeTable = new TimeTable('div.TimeTable',r,{datatype:'sheet',dataSheet:url.sheet});

    // 掲示板の表示
    console.log(r.notice);
    v.notice = {
      raw: r.notice,
      element: document.querySelector('.TabMenu > [name="掲示板"] [name="board"]'),
      disp:[],
    }
    // rowデータをdipsとしてコピー
    v.notice.disp.push(['日時','メッセージ']); // ヘッダを変更
    for( v.i=1 ; v.i<v.notice.raw.length ; v.i++ ){
      v.r = v.notice.raw[v.i];
      if( v.r[0].length > 0 ){
        if( v.r[0] === '—' ){ // 時刻を表示しないメッセージ
          v.notice.disp.push(v.r);
        } else {  // 時刻の表示形式を変更
          v.notice.disp.push([new Date(v.r[0]).toLocale('M/dd hh:mm'),v.r[1]]);
        }
      }
    }
    v.notice.element.innerHTML = '';  // ボード領域をクリア
    v.notice.element.appendChild(v.notice.disp.tabulize());
    console.log(v);
  });

  // MarkDownで記述された部分をHTML化して表示
  document.querySelectorAll('div.markdown').forEach(x => {
    x.innerHTML = marked(x.innerHTML);
  });

  // PlantUMLで記述された部分をHTML化して表示
  document.querySelectorAll('div.PlantUML').forEach(x => {
    let src = x.querySelector('div').innerHTML;
    x.querySelector('img').src = "http://www.plantuml.com/plantuml/svg/"
      + plantumlEncoder.encode(src);
  });

  // Mermaidで記述された部分をHTML化して表示
  mermaid.initialize({startOnLoad: true});

  // パスポートの内容描画
  let entryNo = new URLSearchParams(window.location.search).get('id');
  console.log("entryNo="+entryNo);
  const passportDiv = document.querySelector('div[name="パスポート"] div');
  if( entryNo === null ){
    passportDiv.appendChild(createElement({tag:'p',text:'受付番号の情報がありません'}));
  } else {
    entryNo = ('000'+entryNo).slice(-4);
    console.log("entryNo="+entryNo);
    passportDiv.appendChild(createElement({
      tag:'p',
      text:'No.'+entryNo,
      style: {margin:"1rem 0",fontSize:"2rem"}
    }));
    qrcodeDiv = document.createElement('div');
    const qr = new QRCode(qrcodeDiv,{
      text: entryNo,
      width: 400,
      height: 400,
      colorDark: "#000",
      colorLight: "#fff",
      correctLevel : QRCode.CorrectLevel.H,
    });
    passportDiv.appendChild(qrcodeDiv);
  }
}

let config = null;
async function setupConfig(){
  try {
    console.log('setupConfig start.');
    config = new Auth('https://script.google.com/macros/s/AKfycbwSvy450w3Bu3GhbBlNFGS5bJAHWi91_gEC42tTtWScAkJUjdZ35SncfXi2slktGH9h/exec');
    console.log('setupConfig normal end.',config);
  } catch(e){
    console.error('setupConfig abnormal end.',e);
  }
}

// ブラウザ上で実行する場合の処理
window.addEventListener('DOMContentLoaded',() => {
  const v = {};
  // メニューを定義
  document.querySelectorAll('.TabMenu[name]').forEach(x => {
    v.menuName = x.getAttribute('name');
    v.arg = {name:v.menuName};
    console.log(v.menuName,v.arg);
    v[v.menuName] = new TabMenu(v.arg);
  });

  // 認証、結果をconfigに格納
  setupConfig();

  // 画面を描画
  redraw();
});
</script>
</body></html>