# authClient/Server

## 開発時メモ

### 20250103

#### 「ゲスト」の扱いを変更

1. ゲストと未ログイン状態のメンバの見極めが困難。
1. スタッフが一般公開ページを閲覧する場合もログインが必要になることは避けたい

- 「ユーザ種別」概念を導入
  - ゲスト: ログイン不要、一般公開のみ
  - メンバ: 要ログイン、種別によりauthServerで付与するauthorityを決定<br>
    ex. 当日参加、スタッフ、コアスタッフ
  - 管理者: 要ログイン、全ての処理を実行可

- 「ユーザ種別」概念導入に伴い、従来ゲストかメンバか判断した後に行っていた要求処理を前工程に移動
  - 考え方を「ゲストorメンバそのぞれの範囲内で処理」から「とにかく処理して範囲外の要求は要求者の状態により分岐」に変更
  - エラー発生時の処理
    - ユーザ種別付与外の要求でエラー ⇒ 「管理者に連絡して権限を付与して貰ってください」
    - ユーザ種別付与内の要求でエラー ⇒ 未ログイン状態なので、パスコード通知メール発行

- authServerにquery実行結果確認(権限不足のチェック)を追加

- ゲストにもuserId, CPkey付与

#### 複数端末でのアカウント共有

父母が両方参加した場合、同一アカウントに対して同じ権限を持たせることはできない
- 端末が別 ⇒ クライアント側鍵ペアが別
- emailが別になる可能性

とりあえず無視。片方をゲストとして運用して貰う。

#### 変更点のまとめ

- Auth
  - シーケンス図修正
- SpreadDb
  - opml -> readme作成
  - フローチャートを起こす
  - エラー発生時のメッセージをエラーコードに変更
  - isErrはquery毎になっていることを確認
- authClient
  - 冒頭でuserId,鍵ペア生成
- authServer
  - 要求(query)処理を前工程に移動
  - 権限外エラー(No Authority)チェックを追加
  - optにユーザ種別ごとのauthority追加
  - ユーザ管理シートからauthority削除、userType(default:'guest')追加
