<!DOCTYPE html><html xml:lang="ja" lang="ja" class="BasePage"><head>
<title>RasterImage</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script src="https://cdn.jsdelivr.net/gh/fengyuanchen/compressorjs/dist/compressor.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-XMVd28F1oH/O71fzwBnV7HucLxVwtxf26XV8P4wPk26EDxuGZ91N8bsOttmnomcCD3CS5ZMRL50H0GgOHvegtg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/heic2any/0.0.1/index.min.js" integrity="sha512-qosaXUCrlY9MGGVtPtsP5MBN+W+R25MfvvvK0oioo9GaAHR7DgpqwVv2NlSOctIX9wcIKsSjhgrSpst1iwmjtA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="text/javascript">
class BasePage {
  constructor(def={},opt={}){
    const v = {whois:'BasePage.constructor',rv:null,step:0,
      def:{parent:'body',wrapper:null,screenList:{},
        css: [`
          html {
            font-size: 24pt;
            font:helvetica,arial,freesans,clean,sans-serif;
            line-height: 1.5rem;
            color: black;
            box-sizing: border-box;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
          }
          body {
            width: 100%;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            -webkit-text-size-adjust: none;
            -moz-text-size-adjust: none;
            text-size-adjust: none;
          }
          .right, .num {
            text-align: right;
          }
          .hide {
            display: none;
          }`,`
          th, .th {
            padding: 0.3em;
            background-color: #888;
            color: white;
          }
          td, .td {
            padding: 0.3em;
            border-bottom: solid 1px #aaa;
            border-right: solid 1px #aaa;
          }`, `
          .LoadingIcon {
            position: absolute;
            left: 0; top: 0;
            width: 100%; height:100%;
            background: #fff;
            z-index: 2147483647;
            display: grid;
            place-items: center;
          }`,`
          .loading5 {
            --dot-size: 4rem;
            --R: 0;
            --G: 0;
            --B: 0;
            --back: rgba(var(--R),var(--G),var(--B),1);
            --pale: rgba(var(--R),var(--G),var(--B),0.2);
            --middle: rgba(var(--R),var(--G),var(--B),0.5);
            --dark: rgba(var(--R),var(--G),var(--B),0.7);
            --m0: calc(var(--dot-size) * 0.8);
            --m1: calc(var(--m0) * -2.6);
            --m2: calc(var(--m0) * -1.8);
            --m3: calc(var(--m0) * 1.75);
            --m4: calc(var(--m0) * 1.8);
            --m5: calc(var(--m0) * 2.5);

            margin: 100px auto;
            font-size: 25px;
            width: var(--dot-size);
            height: var(--dot-size);
            border-radius: 50%;
            position: relative;
            text-indent: -9999em;
            -webkit-animation: load5 1.1s infinite ease;
            animation: load5 1.1s infinite ease;
            -webkit-transform: translateZ(0);
            -ms-transform: translateZ(0);
            transform: translateZ(0);
          }
          @-webkit-keyframes load5 {
            0%,
            100% {box-shadow:
              0em var(--m1) 0em 0em var(--back),
              var(--m4) var(--m2) 0 0em var(--pale),
              var(--m5) 0em 0 0em var(--pale),
              var(--m3) var(--m3) 0 0em var(--pale),
              0em var(--m5) 0 0em var(--pale),
              var(--m2) var(--m4) 0 0em var(--pale),
              var(--m1) 0em 0 0em var(--middle),
              var(--m2) var(--m2) 0 0em var(--dark);
            }
            12.5% {
              box-shadow: 0em var(--m1) 0em 0em var(--dark), var(--m4) var(--m2) 0 0em var(--back), var(--m5) 0em 0 0em var(--pale), var(--m3) var(--m3) 0 0em var(--pale), 0em var(--m5) 0 0em var(--pale), var(--m2) var(--m4) 0 0em var(--pale), var(--m1) 0em 0 0em var(--pale), var(--m2) var(--m2) 0 0em var(--middle);
            }
            25% {
              box-shadow: 0em var(--m1) 0em 0em var(--middle), var(--m4) var(--m2) 0 0em var(--dark), var(--m5) 0em 0 0em var(--back), var(--m3) var(--m3) 0 0em var(--pale), 0em var(--m5) 0 0em var(--pale), var(--m2) var(--m4) 0 0em var(--pale), var(--m1) 0em 0 0em var(--pale), var(--m2) var(--m2) 0 0em var(--pale);
            }
            37.5% {
              box-shadow: 0em var(--m1) 0em 0em var(--pale), var(--m4) var(--m2) 0 0em var(--middle), var(--m5) 0em 0 0em var(--dark), var(--m3) var(--m3) 0 0em var(--back), 0em var(--m5) 0 0em var(--pale), var(--m2) var(--m4) 0 0em var(--pale), var(--m1) 0em 0 0em var(--pale), var(--m2) var(--m2) 0 0em var(--pale);
            }
            50% {
              box-shadow: 0em var(--m1) 0em 0em var(--pale), var(--m4) var(--m2) 0 0em var(--pale), var(--m5) 0em 0 0em var(--middle), var(--m3) var(--m3) 0 0em var(--dark), 0em var(--m5) 0 0em var(--back), var(--m2) var(--m4) 0 0em var(--pale), var(--m1) 0em 0 0em var(--pale), var(--m2) var(--m2) 0 0em var(--pale);
            }
            62.5% {
              box-shadow: 0em var(--m1) 0em 0em var(--pale), var(--m4) var(--m2) 0 0em var(--pale), var(--m5) 0em 0 0em var(--pale), var(--m3) var(--m3) 0 0em var(--middle), 0em var(--m5) 0 0em var(--dark), var(--m2) var(--m4) 0 0em var(--back), var(--m1) 0em 0 0em var(--pale), var(--m2) var(--m2) 0 0em var(--pale);
            }
            75% {
              box-shadow: 0em var(--m1) 0em 0em var(--pale), var(--m4) var(--m2) 0 0em var(--pale), var(--m5) 0em 0 0em var(--pale), var(--m3) var(--m3) 0 0em var(--pale), 0em var(--m5) 0 0em var(--middle), var(--m2) var(--m4) 0 0em var(--dark), var(--m1) 0em 0 0em var(--back), var(--m2) var(--m2) 0 0em var(--pale);
            }
            87.5% {
              box-shadow: 0em var(--m1) 0em 0em var(--pale), var(--m4) var(--m2) 0 0em var(--pale), var(--m5) 0em 0 0em var(--pale), var(--m3) var(--m3) 0 0em var(--pale), 0em var(--m5) 0 0em var(--pale), var(--m2) var(--m4) 0 0em var(--middle), var(--m1) 0em 0 0em var(--dark), var(--m2) var(--m2) 0 0em var(--back);
            }
          }
          @keyframes load5 {
            0%,
            100% {
              box-shadow: 0em var(--m1) 0em 0em var(--back), var(--m4) var(--m2) 0 0em var(--pale), var(--m5) 0em 0 0em var(--pale), var(--m3) var(--m3) 0 0em var(--pale), 0em var(--m5) 0 0em var(--pale), var(--m2) var(--m4) 0 0em var(--pale), var(--m1) 0em 0 0em var(--middle), var(--m2) var(--m2) 0 0em var(--dark);
            }
            12.5% {
              box-shadow: 0em var(--m1) 0em 0em var(--dark), var(--m4) var(--m2) 0 0em var(--back), var(--m5) 0em 0 0em var(--pale), var(--m3) var(--m3) 0 0em var(--pale), 0em var(--m5) 0 0em var(--pale), var(--m2) var(--m4) 0 0em var(--pale), var(--m1) 0em 0 0em var(--pale), var(--m2) var(--m2) 0 0em var(--middle);
            }
            25% {
              box-shadow: 0em var(--m1) 0em 0em var(--middle), var(--m4) var(--m2) 0 0em var(--dark), var(--m5) 0em 0 0em var(--back), var(--m3) var(--m3) 0 0em var(--pale), 0em var(--m5) 0 0em var(--pale), var(--m2) var(--m4) 0 0em var(--pale), var(--m1) 0em 0 0em var(--pale), var(--m2) var(--m2) 0 0em var(--pale);
            }
            37.5% {
              box-shadow: 0em var(--m1) 0em 0em var(--pale), var(--m4) var(--m2) 0 0em var(--middle), var(--m5) 0em 0 0em var(--dark), var(--m3) var(--m3) 0 0em var(--back), 0em var(--m5) 0 0em var(--pale), var(--m2) var(--m4) 0 0em var(--pale), var(--m1) 0em 0 0em var(--pale), var(--m2) var(--m2) 0 0em var(--pale);
            }
            50% {
              box-shadow: 0em var(--m1) 0em 0em var(--pale), var(--m4) var(--m2) 0 0em var(--pale), var(--m5) 0em 0 0em var(--middle), var(--m3) var(--m3) 0 0em var(--dark), 0em var(--m5) 0 0em var(--back), var(--m2) var(--m4) 0 0em var(--pale), var(--m1) 0em 0 0em var(--pale), var(--m2) var(--m2) 0 0em var(--pale);
            }
            62.5% {
              box-shadow: 0em var(--m1) 0em 0em var(--pale), var(--m4) var(--m2) 0 0em var(--pale), var(--m5) 0em 0 0em var(--pale), var(--m3) var(--m3) 0 0em var(--middle), 0em var(--m5) 0 0em var(--dark), var(--m2) var(--m4) 0 0em var(--back), var(--m1) 0em 0 0em var(--pale), var(--m2) var(--m2) 0 0em var(--pale);
            }
            75% {
              box-shadow: 0em var(--m1) 0em 0em var(--pale), var(--m4) var(--m2) 0 0em var(--pale), var(--m5) 0em 0 0em var(--pale), var(--m3) var(--m3) 0 0em var(--pale), 0em var(--m5) 0 0em var(--middle), var(--m2) var(--m4) 0 0em var(--dark), var(--m1) 0em 0 0em var(--back), var(--m2) var(--m2) 0 0em var(--pale);
            }
            87.5% {
              box-shadow: 0em var(--m1) 0em 0em var(--pale), var(--m4) var(--m2) 0 0em var(--pale), var(--m5) 0em 0 0em var(--pale), var(--m3) var(--m3) 0 0em var(--pale), 0em var(--m5) 0 0em var(--pale), var(--m2) var(--m4) 0 0em var(--middle), var(--m1) 0em 0 0em var(--dark), var(--m2) var(--m2) 0 0em var(--back);
            }

          }`,
        ],
        html: [
          {attr:{class:'BasePage'},children:[
            {attr:{class:'LoadingIcon'},name:'loading',children:[
              {attr:{class:'loading5'},text:'loading...'}
            ]},
          ]},
        ],
      },
    };
    console.log(v.whois+' start.',def,opt);
    try {
      v.step = 1.1;
      this.deepcopy(this,v.def);
      console.log("%s step.%s\n",v.whois,v.step,this.css);

      v.step = 1.2;




      this.className = 'BasePage';
      v.rv = this.setStyleSheet();
      if( v.rv instanceof Error ) throw v.rv;
      this.css = [];

      v.step = 1.3;
      if( document.querySelector('body > div.BasePage') === null ){
        this.createElement(this.html,document.querySelector('body'));
      }
      this.html = [];

      v.step = 2.1;
      this.className = this.constructor.name;
      v.step = 2.2;
      ['css','html'].forEach(x => {
        if( def.hasOwnProperty(x) ){
          if( !this.isArr(def[x]) ){
            def[x] = [def[x]];
          }
        } else {
          def[x] = [];
        }
      });
      v.step = 2.3;
      this.deepcopy(this,def);
      console.log("%s step.%s\n",v.whois,v.step,this.css);
      v.step = 2.4;
      this.deepcopy(this,opt);
      console.log("%s step.%s\n",v.whois,v.step,this.screenList);

      v.step = 3;
      if( typeof this.parent === 'string' ){
        this.parentSelector = this.parent;
        this.parent = document.querySelector(this.parentSelector);
      } else {
        this.parentSelector = '';
      }

      v.step = 4;
      if( this.wrapper === null ){
        this.wrapper = this.createElement(
          {attr:{name:'wrapper',class:this.className}},
        this.parent);
      }
      this.wrapperSelector
      = (this.parentSelector === null ? '' : this.parentSelector + ' > ')
      + 'div.' + this.className + '[name="wrapper"]';

      v.step = 5;
      v.rv = this.setStyleSheet();
      if( v.rv instanceof Error ) throw v.rv;

      v.step = 6;
      if( this.html !== null ){
        if( typeof this.html === 'string' ){
          this.wrapper.innerHTML = this.html;
        } else {
          this.createElement(this.html,this.wrapper);
        }
      }

      v.step = 7;
      v.rv = this.changeScreen();
      if( v.rv instanceof Error ) throw v.rv;

      v.step = 8;
      console.log(v.whois+' normal end.\n',v.rv);

    } catch(e){
      console.error(v.whois+' abnormal end(step.'+v.step+').',e,v);
      return e;
    }
  }
  deepcopy = (dest,opt) => {
    const v = {whois:'BasePage.deepcopy',rv:null,step:0};
    console.log(v.whois+' start.');
    try {

      Object.keys(opt).forEach(x => {
        v.step = 1;
        if( !dest.hasOwnProperty(x) ){
          v.step = 2;
          dest[x] = opt[x];
        } else {
          if( this.isObj(dest[x]) && this.isObj(opt[x]) ){
            v.step = 3;
            v.rv = this.deepcopy(dest[x],opt[x]);
            if( v.rv instanceof Error ) throw v.rv;
          } else if( this.isArr(dest[x]) && this.isArr(opt[x]) ){
            v.step = 4;


            dest[x] = [...new Set([...dest[x],...opt[x]])];

          } else {
            v.step = 5;
            dest[x] = opt[x];
          }
        }
      });

      v.step = 6;
      console.log(v.whois+' normal end. result=%s',v.rv);
      return v.rv;

    } catch(e){
      console.error(v.whois+' abnormal end(step.'+v.step+').',e,v);
      return e;
    }
  }
  changeScreen = (screenName=this.home) => {
    const v = {whois:'BasePage.changeScreen',rv:null,step:0};
    console.log(v.whois+' start.',screenName);
    try {

      v.step = 1;
      for( v.x in this.screenList ){
        this[v.x].style.display = v.x === screenName ? '' : 'none';
      }

      v.step = 2;
      console.log(v.whois+' normal end.\n',v.rv);
      return v.rv;

    } catch(e){
      console.error(v.whois+' abnormal end(step.'+v.step+').',e,v);
      return e;
    }
  }
  createElement = (arg,parent=null) => {
    const v = {whois:'BasePage.createElement',rv:[],step:0};
    console.log(v.whois+' start.',arg);
    try {
      v.step = 1.1;
      v.isArr = this.isArr(arg);
      if( !v.isArr ) arg = [arg];
      v.step = 1.2;
      if( parent !== null ){
        v.parent = typeof parent === 'string' ? document.querySelector(parent) : parent;
      }


      for( v.i = 0 ; v.i<arg.length ; v.i++ ){
        v.step = 2;
        v.def = {tag: 'div',attr: {},style:{},event:{},text: '',html:'',children:[],name:''};
        Object.assign(v.def,(typeof arg[v.i] === 'string' ? {tag:arg} : arg[v.i]))

        v.step = 3;
        v.obj = document.createElement(v.def.tag);

        v.step = 4;
        for( v.j in v.def.attr ){
          v.obj.setAttribute(v.j,v.x = v.def.attr[v.j]);
        }

        v.step = 5;
        for( v.j in v.def.logical ){
          if( v.def.logical[v.j] ){
            v.obj.setAttribute(v.j,v.def.logical[v.j]);
          }
        }

        v.step = 6;
        for( v.j in v.def.style ){
          if( v.j.match(/^\-\-/) ){
            v.obj.style.setProperty(v.j,v.def.style[v.j]);
          } else {
            v.obj.style[v.j] = v.def.style[v.j];
          }
        }

        v.step = 7;
        for( v.j in v.def.event ){
          v.obj.addEventListener(v.j,v.def.event[v.j],false);
        }

        v.step = 8;
        if( v.def.html.length > 0 ){
          v.obj.innerHTML = v.def.html;
        } else {
          v.obj.innerText = v.def.text;
        }

        v.step = 9;
        for( v.j=0 ; v.j<v.def.children.length ; v.j++ ){
          v.obj.appendChild(this.createElement(v.def.children[v.j]));
        }

        v.step = 10;
        v.rv.push(v.obj);

        v.step = 11;
        if( parent !== null ){
          v.parent.appendChild(v.obj);
        }

        v.step = 12;
        if( v.def.name.length > 0 ){
          this[v.def.name] = v.obj;
          this.screenList[v.def.name] = v.obj;
        }
      }

      v.step = 12;
      v.rv = v.isArr ? v.rv : v.rv[0];
      console.log(v.whois+' normal end.\n',v.rv);
      return v.rv;

    } catch(e){
      console.error(v.whois+' abnormal end(step.'+v.step+').',e,v);
      return e;
    }
  }
  isArr = obj => obj && String(Object.prototype.toString.call(obj).slice(8,-1)) === 'Array';
  isObj = obj => obj && String(Object.prototype.toString.call(obj).slice(8,-1)) === 'Object';
  sleep = (sec) =>
    {return new Promise(resolve => setTimeout(resolve,sec))};
  setStyleSheet = () => {
    const v = {whois:this.className+'.setStyleSheet',rv:null,step:0,cssDefs:''};
    console.log(v.whois+' start.',this.css);
    try {

      v.step = 1;
      if( this.css.length === 0 ){
        console.log(v.whois+' normal end.(empty CSS)\n');
        return v.rv;
      }

      v.step = 2;
      if( document.head.querySelector('style[name="'+this.className+'"]') !== null ){
        console.log(v.whois+' normal end.(already exist)\n');
        return v.rv;
      }

      v.step = 3;
      v.css = this.css.join('').replaceAll(/\n/g,' ').replaceAll(/\s+/g,' ');
      console.log(this.css.join('').match(/[^\{\}]+?\{.+?\}/g));
      v.css.match(/[^\{\}]+?\{.+?\}/g).forEach(l => {
        v.step = 4;
        v.m = l.match(/\s*([^\{\}]+?)\s*\{(.+?)\}/);
        v.selector = v.m[1].trim();
        if( v.selector.indexOf(this.className) < 0
         && v.selector.slice(0,1) !== '@'
         && v.selector.match(/[0-9\.%]+/) === null ){
          v.step = 5;
          v.selector = ' .' + this.className + ' ' + v.selector;
        }
        v.step = 6;
        v.cssDefs += v.selector + ' {' + v.m[2] + '} ';
      });

      v.step = 7;
      if( v.cssDefs.length > 0 ){
        v.step = 8;
        v.cssDefs = v.cssDefs.replaceAll(/\n/g,' ').replaceAll(/\s+/g,' ');
        v.step = 9;
        this.createElement({
          tag:'style',
          attr:{type:'text/css',name:this.className},
          text:v.cssDefs
        },document.head);
      }

      v.step = 10;
      console.log(v.whois+' normal end.\n',v.rv);
      return v.rv;

    } catch(e){
      console.error(v.whois+' abnormal end(step.'+v.step+').',e,v);
      return e;
    }
  }
}</script>
<script type="text/javascript">
class RasterImage extends BasePage {
  constructor(opt){
    const v = {whois:'RasterImage.constructor',rv:null,step:0,def:{
      parent: 'body',
      func: 'bulk',


      files: [],
      thumbnail: 200,
      css: [
        `.bulk .dropArea {
          margin: 1rem;
          padding: 2rem;
          border: solid 5px #ccc;
          text-align:center;
        }
        .bulk table {
          margin: 1rem;
        }`,
        `.preview {
          margin: 1rem;
        }
        .preview .image {
          display: 'inline-block',
        }
        .preview .info {
          font-size: 0.6rem;
        }`,
        `.tooltip {
          position: absolute;
          z-index: 10;
          visibility: hidden;
          background-color: rgba(255,255,255,0.8);
          font-size: 0.7rem;
          padding: 0.5rem;
          line-height: 1rem;
        }`,


      ],
      html: [
        {tag:'div',attr:{class:'tooltip'}},

        {name:'bulk',attr:{class:'bulk'},children:[
          {attr:{class:'dropArea'},text:'画像ファイルをドロップ(複数可)',event:{
            drop:(e)=>{
              e.stopPropagation();
              e.preventDefault();
              this.bulkCompress(e.dataTransfer.files);        
            },
            dragover:(e)=>e.preventDefault(),
          }},
          {attr:{class:'specification'},children:[
            {tag:'table',children:[
              {tag:'tr',attr:{name:'mimeType'},children:[
                {tag:'th',text:'画像形式'},
                {tag:'td',children:[
                  {tag:'select',children:[
                    {tag:'option',attr:{value:'image/webp'},text:'webp'},
                    {tag:'option',attr:{value:'image/png'},text:'png'},
                    {tag:'option',attr:{value:'image/jpeg'},text:'jpeg'},
                    {tag:'option',attr:{value:'image/gif'},text:'gif'},
                  ]}
                ]},
                {tag:'td',text:''}
              ]},
              {tag:'tr',attr:{name:'standard'},children:[
                {tag:'th',text:'画像サイズ'},
                {tag:'td',children:[
                  {tag:'select',children:[
                    {tag:'option',attr:{value:'-1'},text:'原寸'},
                    {tag:'option',attr:{value:'7680'},text:'8K(7680)'},
                    {tag:'option',attr:{value:'3840'},text:'4K(3840)'},
                    {tag:'option',attr:{value:'1920'},text:'FullHD(1920)'},
                    {tag:'option',attr:{value:'1280'},text:'HDTV(1280)'},
                    {tag:'option',attr:{value:'1024'},text:'XGA(1024)'},
                    {tag:'option',attr:{value:'800'},text:'SVGA(800)'},
                    {tag:'option',attr:{value:'640'},logical:{selected:true},text:'VGA(640)'},
                    {tag:'option',attr:{value:'320'},text:'QuarterVGA(320)'},
                    {tag:'option',attr:{value:'-2'},text:'custom'},
                  ],event:{
                    change:(e)=>{
                      console.log(e.target.value);
                      let max = this.bulk.querySelector('[name="maxSize"]');
                      let maxi = max.querySelector('input');
                      let min = this.bulk.querySelector('[name="minSize"]');
                      let mini = min.querySelector('input');
                      if( e.target.value == -2 ){
                        max.classList.remove('hide');
                        min.classList.remove('hide');
                        maxi.defaultValue = 640;
                        mini.defaultValue = 320;
                      } else {
                        max.classList.add('hide');
                        min.classList.add('hide');
                        if( e.target.value == -1 ){
                          maxi.defaultValue = 999999;
                          mini.defaultValue = 0;
                        } else {
                          maxi.defaultValue = e.target.value;
                        }
                      }
                    }
                  }}
                ]},
                {tag:'td',text:'原画縦横比を保持するので規格名は目安'}
              ]},
              {tag:'tr',attr:{name:'maxSize',class:'hide'},children:[
                {tag:'th',text:'最大高/幅'},
                {tag:'td',children:[
                  {tag:'input',attr:{type:'number',value:640},style:{width:'50px'}}
                ]},
                {tag:'td',text:'無指定の場合は"-1"を入力'}
              ]},
              {tag:'tr',attr:{name:'minSize',class:'hide'},children:[
                {tag:'th',text:'最小高/幅'},
                {tag:'td',children:[
                  {tag:'input',attr:{type:'number',value:320},style:{width:'50px'}}
                ]},
                {tag:'td',text:'無指定の場合は"-1"を入力'}
              ]},
              {tag:'tr',attr:{name:'checkOrientation'},children:[
                {tag:'th',text:'画像の向き'},
                {tag:'td',children:[
                  {tag:'select',children:[
                    {tag:'option',attr:{value:true},text:'補正する'},
                    {tag:'option',attr:{value:false},text:'補正しない'},
                  ]}
                ]},
                {tag:'td',text:'Exif Orientationに基づく。Jpegのみ有効'}
              ]},
              {tag:'tr',attr:{name:'retainExif'},children:[
                {tag:'th',text:'Exif情報'},
                {tag:'td',children:[
                  {tag:'select',children:[
                    {tag:'option',attr:{value:false},text:'保持しない'},
                    {tag:'option',attr:{value:true},text:'保持する'},
                  ]}
                ]},
                {tag:'td',text:'圧縮後もExifを保持するかの指定'}
              ]},
              {tag:'tr',attr:{name:'quality'},children:[
                {tag:'th',text:'品質'},
                {tag:'td',children:[
                  {tag:'input',attr:{type:'number',value:0.8},style:{width:'50px'}}
                ]},
                {tag:'td',html:'0(圧縮大)〜1(無圧縮)の小数。推奨値は最低0.6。<br/>既定値はjpeg:0.92,webp:0.80。'}
              ]},
            ]}
          ]},
        ]},
        {name:'preview',attr:{class:'preview'},children:[
          {attr:{name:'ctrl'},children:[
            {tag:'button',text:'download zip file'}
          ]},
          {attr:{name:'image'}},
        ]},


      ],
    }};
    console.log(v.whois+' start.',opt);
    try {
      super(v.def,opt);



      this.preview.querySelector('button').addEventListener('click',this.download);

      v.step = 1;
      this.changeScreen(this.func);
      console.log(v.whois+' normal end.\n',v.rv);

    } catch(e){
      console.error(v.whois+' abnormal end(step.'+v.step+').',e,v);
      return e;
    }
  }
  bulkCompress = async (files) => {
    const v = {whois:this.className+'.bulkCompress',rv:null,step:0};
    console.log(v.whois+' start.',files);
    try {


      v.step = 1;
      this.changeScreen('loading');
      this.zip = new JSZip();



      v.step = 2;
      v.o = this.bulk.querySelector('.specification');
      v.opt = {
        mimeType: v.o.querySelector('[name="mimeType"] select').value,
        checkOrientation: v.o.querySelector('[name="checkOrientation"] select').value,
        retainExif: v.o.querySelector('[name="retainExif"] select').value,
        quality: v.o.querySelector('[name="quality"] input').value,
      }
      v.max = v.o.querySelector('[name="maxSize"] input').value;
      v.opt.maxHeight = v.opt.maxWidth = (v.max == -1 ? Infinity : v.max);
      v.min = v.o.querySelector('[name="minSize"] input').value;
      v.opt.minHeight = v.opt.minWidth = (v.min == -1 ? 0 : v.min);
      v.opt.error = (e) => {
        alert("'"+''+"'は非対応の画像形式です",e);
        console.error('l.244',e);
        return e;
      };

      for( v.i=0 ; v.i<files.length ; v.i++ ){



        v.step = 3.1;
        v.file = {origin:files[v.i]};

        v.step = 3.2;
        if (v.file.origin.type === 'image/heif' || v.file.origin.type === 'image/heic') {
          v.name = v.file.origin.name;
          v.file.origin = await heic2any({
            blob: v.file.origin,
            toType: 'image/jpeg',
          });
          v.file.origin.name = v.name;
          console.log('%s step.%s',v.whois,v.step,v.file.origin);
        }

        v.step = 3.3;
        v.file.compress = await this.compress(v.file.origin,v.opt).catch(e=>{
          return e;
        });
        if( v.file.compress instanceof Error ){
          v.step = 3.4;
          this.createElement({style:{
            display: 'inline-block',
            'vertical-align':'top',
            margin:'1rem',
            width: (this.thumbnail - 30) + 'px',
            height: (this.thumbnail * 0.75 - 30) + 'px',
            border: 'solid 5px #ccc',
            padding: '10px',
          },html:'Error: '+v.file.origin.name+'<br>'+'※画像形式非対応'}
          ,this.preview.querySelector('[name="image"]'));
          console.error(v.file.compress);
          continue;
        }
        v.step = 3.5;
        v.file.compress.ratio = v.file.compress.size / v.file.origin.size;
        v.step = 3.6;
        v.size = await this.imagesize(v.file.origin);
        v.file.origin.width = v.size.width;
        v.file.origin.height = v.size.height;
        v.size = await this.imagesize(v.file.compress);
        v.file.compress.width = v.size.width;
        v.file.compress.height = v.size.height;
        v.step = 3.7;
        this.files.push(v.file);


        v.step = 4;
        this.zip.file(v.file.compress.name,v.file.compress,{binary:true});


        v.step = 5;
        console.log("%s step.%s",v.whois,v.step,v.file);
        this.createElement({
          style:{display:'inline-block','vertical-align':'top'},
          children:[{
            tag:'img',
            attr:{src:URL.createObjectURL(v.file.compress)},
            style:{
              margin: '1rem',
              'max-width':this.thumbnail + 'px',
              'max-height':this.thumbnail + 'px',
            },
          },
          {style:{margin:'1rem'},children:[
            {tag:'p',attr:{class:'info'},text:v.file.origin.name},
            {tag:'table',attr:{class:'info'},children:[
              {tag:'tr',children:[
                {tag:'th'},{tag:'th',text:'before'},{tag:'th',text:'after'}
              ]},
              {tag:'tr',children:[
                {tag:'th',text:'width'},
                {tag:'td',attr:{class:'num'},text:v.file.origin.width},
                {tag:'td',attr:{class:'num'},text:v.file.compress.width},
              ]},
              {tag:'tr',children:[
                {tag:'th',text:'height'},
                {tag:'td',attr:{class:'num'},text:v.file.origin.height},
                {tag:'td',attr:{class:'num'},text:v.file.compress.height},
              ]},
              {tag:'tr',children:[
                {tag:'th',text:'size'},
                {tag:'td',attr:{class:'num'},text:v.file.origin.size.toLocaleString()},
                {tag:'td',attr:{class:'num'},html:v.file.compress.size.toLocaleString()
                  + '<br/>' + Math.round(v.file.compress.ratio*10000)/100 + '%'
                },
              ]},
            ]},
          ]}
        ]},this.preview.querySelector('[name="image"]'));

      }


      v.step = 6;
      this.changeScreen('preview');
      v.rv = this.files;
      console.log(v.whois+' normal end.\n',this.files);
      return v.rv;

    } catch(e){
      console.error(v.whois+' abnormal end(step.'+v.step+').',e,v);
      return e;
    }
  }
  compress = (file,opt) => {
    return new Promise((resolve,reject) => {
      opt.success = resolve;
      opt.error = reject;
      new Compressor(file,opt);
    });
  }
  download = async () => {
    const v = {whois:this.className+'.download',rv:null,step:0};
    console.log(v.whois+' start.');
    try {

      v.step = 1;
      v.blob = await this.zip.generateAsync({type:'blob'});

      v.step = 2;
      const url = URL.createObjectURL(v.blob);
      const a = document.createElement("a");
      document.body.appendChild(a);
      a.download = 'RasterImage.zip';
      a.href = url;
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      v.step = 3;
      console.log(v.whois+' normal end.\\n',v.rv);
      return v.rv;

    } catch(e){
      console.error(v.whois+' abnormal end(step.'+v.step+').',e,v);
      return e;
    }
  }
  imagesize = async (file) => {
    return new Promise((resolve, reject) => {
      const img = new Image();

      img.onload = () => {
        const size = {
          width: img.naturalWidth,
          height: img.naturalHeight,
        };

        URL.revokeObjectURL(img.src);
        resolve(size);
      };

      img.onerror = (error) => {
        reject(error);
      };

      img.src = URL.createObjectURL(file);
    });
  }
}</script>
</head><body>
<div id="RasterImage"></div>
<script type="text/javascript">
window.addEventListener('DOMContentLoaded',async () => {
  const v = {whois:'DOMContentLoaded',rv:null,step:0};
  console.log(v.whois+' start.');
  try {

    v.step = 1; // インスタンス生成
    v.RasterImage = new RasterImage({parent:'#RasterImage'});

    v.step = 2; // 終了処理
    console.log(v.whois+' normal end.\n',v.rv);
    return v.rv;

  } catch(e){
    console.error(v.whois+' abnormal end(step.'+v.step+').',e,v);
  }
});
</script>
</body>
</html>