<!DOCTYPE html><html xml:lang="ja" lang="ja"><head>
<title>[proto] edit/select dialog</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="stylesheet" href="../szLib.css" />
<!-- style type="text/css">
.Reception[name="edit"] {
  padding: 1rem;
}
.Reception[name="edit"] [name="table"] {
  display: grid;
  grid-template-columns: 2fr 10fr 8fr 6fr;
  grid-gap: 0.2rem;
}
.Reception ruby rt {
  font-size: 0.6rem;
}
</style -->
</head><body>

<!-- div class="Reception" name="edit">
  <div name="table">
    <div class="th">No</div><div class="th">氏名</div><div class="th">所属</div><div class="th">参加費</div>
  </div>
  <div name="details"></div>
</div -->

<script src="../createElement.js"></script>
<script src="../mergeDeeply.js"></script>
<script type="text/javascript">
const conf = {  // thisに相当
  edit:{  // setPropertiesでセット
    element:null,
    css: [
      {sel:'dialog.Reception',prop:{
        'margin':'auto',
        'padding': '1rem',
      }},
      {sel:'.Reception [name="table"]',prop:{
        'display': 'grid',
        'grid-template-columns': '2fr 10fr 8fr 6fr',
        'grid-gap': '0.2rem',
      }},
      {sel:'.Reception ruby rt',prop:{
        'font-size': '0.6rem',
      }},
    ],
  },
  mami:JSON.parse('{"タイムスタンプ":"2023-08-01T09:05:16.616Z","メールアドレス":"nakaone.kunihiro@gmail.com","申込者氏名":"高井　麻巳子","申込者カナ":"タカイ　マミコ","申込者の参加":"不参加","宿泊、テント":"宿泊する(テントなし)","引取者氏名":"申込者が参加して帰宅時の付添もするのでお迎えは不要","参加者01氏名":"高井　真美","参加者01カナ":"タカイ　マミ","参加者01所属":"卒業生","参加者02氏名":"高井　雄介","参加者02カナ":"タカイ　ユウスケ","参加者02所属":"未就学児","参加者03氏名":"","参加者03カナ":"","参加者03所属":"","参加者04氏名":"","参加者04カナ":"","参加者04所属":"","参加者05カナ":"","参加者05氏名":"","参加者05所属":"","緊急連絡先":"","ボランティア募集":"","備考":"","キャンセル":"","":"","name":"","entryStr":"","authority":"2","cancel":"","entryNo":"16","publicKey":"Wn2Ka6MGMwuMbsDhX+xXgLc7AWt8UR3JYmdyg206vFDz3MmS/cJ7mqmKbEwVRRLPIUuEDJ5UM5i+wGvH1H+kFXkPBG2FPsWtotKuUzIM7bYVX/FLDF1z4sdis09OKysWu6jFbu8dToGsvXQMoUbLxqfVLWHb1skoiTFPbtGbSgU=","editURL":"https://docs.google.com/forms/d/e/1FAIpQLScEzS8-uNgeM40rZvGl60uZewwHZhyPeQJAicS_LjMEYrMqfQ/viewform?edit2=2_ABaOnudN4rJMPqj2nj7P1M4FCr2sFz0i9TTUF4iPzK_wxu9CW0kFOuP10yNGKlJnQLwgNIo","passCode":"730259","genPassCode":"2023-08-09T07:21:55.827Z","NG1":"","NG2":"","certificate":"2023-08-09T07:22:20.520Z","fee00":"","fee01":"","fee02":"","fee03":"","fee04":"","fee05":""}'),
}

const setWindows = () => {
  const v = {whois:'Reception.#setWindows',rv:null,step:'0'};
  console.log(v.whois+' start.');
  try {

    v.step = 1; // dialog用のCSS定義を追加(getPassCodeと共通)
    v.style = createElement('style');
    document.head.appendChild(v.style);
    for( v.i=0 ; v.i<conf.edit.css.length ; v.i++ ){
      v.x = conf.edit.css[v.i];
      for( v.y in v.x.prop ){
        v.prop = v.x.sel+' { '+v.y+' : '+v.x.prop[v.y]+'; }\n';
        console.log(v.prop);
        v.style.sheet.insertRule(v.prop,
          v.style.sheet.cssRules.length,
        );
      }
    }

    // 編集用ダイアログを定義
    conf.edit.element = createElement({
      tag:'dialog',
      attr:{class:'Reception',name:'edit'},
      html: `<div name="table">
        <div class="th">No</div>
        <div class="th">氏名</div>
        <div class="th">所属</div>
        <div class="th">参加費</div>
      </div>
      <div name="details"></div>
      <input type="button" value="送信" />`,
    });
    document.querySelector('body').prepend(conf.edit.element);
    conf.edit.table = conf.edit.element.querySelector('[name="table"]');

    console.log(v.whois+' normal end.',v.rv);
    return v.rv;

  } catch(e){
    console.error(v.whois+' abnormal end(step.'+v.step+')\n',e,v);
    return e;
  }
}

const edit = (data) => {
  const v = {whois:'Reception.edit',rv:null,step:'0'};
  console.log(v.whois+' start.\n'+JSON.stringify(data));
  try {

    v.step = 1; // データクレンジング
    data['申込者所属'] = '申込者';  // 未定義なので追加しておく
    for( v.i=0 ; v.i<6 ; v.i++ ){
      if( data['fee0'+v.i].length === 0 ){
        data['fee0'+v.i] = (data['参加者0'+v.i+'所属'] === '未就学児') ? '無し' : '未収';
      }
    }

    v.step = 2; // 参加者一覧の表示
    for( v.i=0 ; v.i<6 ; v.i++ ){
      v.step = 2.1; // 項目名の接頭辞
      v.pre = v.i === 0 ? '申込者' : ('参加者0' + v.i);

      v.step = 2.2; // 申込者が不参加、または氏名・所属とも未登録の参加者は表示しない
      if( v.i === 0 && data['申込者の参加'] === '不参加'
      || data[v.pre+'氏名'].length === 0 && data[v.pre+'所属'].length === 0 ){
        continue;
      }

      v.step = 2.3; // No
      conf.edit.table.appendChild(createElement({attr:{class:'td'},text: ('0'+v.i)}));

      v.step = 2.4; // 氏名＋カナ
      conf.edit.table.appendChild(createElement({attr:{class:'td'},children:[{
        tag: 'ruby',
        html: data[v.pre+'氏名'], 
        children: [{
          tag: 'rt',
          text: data[v.pre+'カナ']
        }]
      }]}));

      v.step = 2.5; // 所属
      conf.edit.table.appendChild(createElement({attr:{class:'td'},text: data[v.pre+'所属']}));

      v.step = 2.6; // 参加費
      v.options = [];
      ['無し','未収','既収'].forEach(x => {
        v.options.push({
          tag:'option',
          value:x,
          text:x,
          logical:{selected:(data['fee0'+v.i] === x)},
        });
      });
      conf.edit.table.appendChild(createElement({attr:{class:'td'},children:[{
        tag: 'select',
        attr: {name:'fee0'+v.i},
        children:v.options,
      }]}));
      //conf.edit.table.appendChild(createElement({attr:{class:'td'},text: data['fee0'+v.i]}));
    }

    v.step = 3; // 編集用ダイアログの表示
    conf.edit.element.showModal();

    console.log(v.whois+' normal end.',v.rv);
    return v.rv;

  } catch(e){
    console.error(v.whois+' abnormal end(step.'+v.step+')\n',e,v);
    return e;
  }
}

window.addEventListener('DOMContentLoaded',() => {
  const v = {};
  setWindows();
  edit(conf.mami);

  /*
  const v = {edit:document.querySelector('.Reception[name="edit"]')};
  v.table = v.edit.querySelector('[name="table"]');

  // データクレンジング
  mami['申込者所属'] = '申込者';  // 未定義なので追加しておく
  for( v.i=0 ; v.i<6 ; v.i++ ){
    if( mami['fee0'+v.i].length === 0 ){
      mami['fee0'+v.i] = (mami['参加者0'+v.i+'所属'] === '未就学児') ? '無し' : '未収';
    }
  }

  for( v.i=0 ; v.i<6 ; v.i++ ){
    v.pre = v.i === 0 ? '申込者' : ('参加者0' + v.i);
    // 申込者が不参加、または氏名・所属とも未登録の場合は表示しない
    if( v.i === 0 && mami['申込者の参加'] === '不参加'
    || mami[v.pre+'氏名'].length === 0 && mami[v.pre+'所属'].length === 0 ){
      continue;
    }
    // No
    v.table.appendChild(createElement({attr:{class:'td'},text: ('0'+v.i)}));
    // 氏名＋カナ
    v.table.appendChild(createElement({attr:{class:'td'},children:[{
      tag: 'ruby',
      html: mami[v.pre+'氏名'], 
      children: [{
        tag: 'rt',
        text: mami[v.pre+'カナ']
      }]
    }]}));
    // 所属
    v.table.appendChild(createElement({attr:{class:'td'},text: mami[v.pre+'所属']}));
    // 参加費
    v.options = [];
    ['無し','未収','既収'].forEach(x => {
      v.options.push({
        tag:'option',
        value:x,
        text:x,
        logical:{selected:(mami['fee0'+v.i] === x)},
      });
    });
    v.table.appendChild(createElement({attr:{class:'td'},children:[{
      tag: 'select',
      attr: {name:'fee0'+v.i},
      children:v.options,
    }]}));
    //v.table.appendChild(createElement({attr:{class:'td'},text: mami['fee0'+v.i]}));
  }
  */
});
</script>
</body></html>