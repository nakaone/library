<!DOCTYPE html><html xml:lang="ja" lang="ja"><head>
<title>design(drawPassport)</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link href="../szLib.css" rel="stylesheet" />
<style type="text/css">
  .drawPassport {
    width: calc(100% - 2rem);
    display: grid;
    grid-template-columns: 1fr;
    padding: 1rem;
    font-size: 1rem;
  }
  .drawPassport rt {
    font-size: 50%;
  }
  .drawPassport .label {
    margin-top: 1rem;
    width: 100%;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2rem;
  }
  .drawPassport .label p {
    grid-column: 1 / 3;
    font-size: 1.4rem;
  }
  .drawPassport .label button {
    grid-column: 3 / 4;
  }

  /* QRコード、受付番号、申込者名 */
  .drawPassport .summary {
    width: 100%;
    margin: 1rem 0px;
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 1rem;
  }
  .drawPassport .summary [name="qrcode"]{
    padding: 0rem;
    grid-row: 1 / 3;
    grid-column: 1 / 5;
  }
  .drawPassport .summary [name="entryNo"]{
    grid-row: 1 / 2;
    grid-column: 5 / 13;
  }
  .drawPassport .summary [name="entryNo"] span {
    font-size: 2rem;
  }
  .drawPassport .summary [name="申込者氏名"]{
    grid-row: 2 / 3;
    grid-column: 5 / 13;
  }
  .drawPassport .summary ruby span {
    font-size: 2rem;
  }
  .drawPassport .summary rt span {
    font-size: 1rem;
  }

  /* 参加者リスト */
  .drawPassport .list .content {
    width: 100%;
    margin: 1rem 0px;
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 0.2rem;
  }
  .drawPassport .list .content.hide {
    display: none;
  }
  .drawPassport .list .content div:nth-child(4n+1) {
    grid-column: 1 / 3;
  }
  .drawPassport .list .content div:nth-child(4n+2) {
    grid-column: 3 / 7;
  }
  .drawPassport .list .content div:nth-child(4n+3) {
    grid-column: 7 / 10;
  }
  .drawPassport .list .content div:nth-child(4n+4) {
    grid-column: 10 / 13;
  }

  /* 詳細 */
  .drawPassport .detail {

  }
  .drawPassport .detail .content {
    width: 100%;
    margin: 1rem 0px;
    display: grid;
    grid-template-columns: 2fr 3fr;
    gap: 0.2rem;
  }
  .drawPassport .detail .content.hide {
    display: none;
  }
  .drawPassport .message {
    display: block;
  }
  .drawPassport .message.hide {
    display: none;
  }

  /* ボタン領域 */
  .drawPassport .buttons {
    width: 100%;
    margin: 1rem 0px;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2rem;
  }
  .drawPassport .buttons button {
    display: block;
    width: 100%;
    font-size: 2rem;
  }
  .drawPassport .buttons [name="取消"].hide {
    display: none;
  }
  .drawPassport .buttons [name="決定"].hide {
    display: none;
  }
  .drawPassport .buttons [name="全員"].hide {
    display: none;
  }

</style>
</head><body>
  <div class="drawPassport"></div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script type="text/javascript" src="../createElement.js"></script>
<script type="text/javascript" src="../mergeDeeply.js"></script>
<script type="text/javascript">
/*
- [JavaScriptでの rem ⇔ px に変換するテクニック＆コード例](https://pisuke-code.com/javascript-convert-rem-to-px/)
*/
/** 参加者情報の表示・編集を行い、編集結果を返す
 * @param {HTMLElement} parent - 親要素
 * @param {Object} info - 参加者情報
 * @param {Object} [opt={}] - オプション
 * @param {boolean} [opt.edit=false] - 編集モードならtrue, 参照モードならfalse
 * @param {boolean} [opt.showList=false] - リスト表示ならtrue、但し編集モードなら強制表示
 * @param {boolean} [opt.showDetail=false] - 詳細を表示するならtrue
 * @returns {Object.<string, any>} 修正された項目ラベルと値
 * 
 */
const drawPassport = async (parent,info,opt={}) => {
  const v = {whois:'drawPassport',step:0,rv:null,
    // toggle: ボタンクリック時の要素表示/非表示変更
    toggle: (
      event, // {PointerEvent|string} - クリック時のイベントまたはセレクタ
      show   // {boolean} - trueなら開く
    ) => {
      console.log('toggle start.\n',event,show);
      let content;  // 表示/非表示を行う対象となる要素
      let button;   // クリックされたボタンの要素
      if( typeof event === 'string' ){
        // 初期設定時(引数がPointerEventではなくstring)
        content = parent.querySelector(event+' .content');
        button = parent.querySelector(event+' button');
      } else {
        // ボタンクリック時
        content = event.target.parentElement.parentElement
        .querySelector('.content');
        button = event.target;
      }
      console.log(content,button);
      // 表示->非表示 or 非表示->表示 を判断
      let toOpen = show ? show : (button.innerText === '表示');
      if( toOpen ){ // 表示に変更する場合
        button.innerText = '非表示';
        content.classList.remove('hide');
      } else {      // 非表示に変更する場合
        button.innerText = '表示';
        content.classList.add('hide');
      }
    }
  };
  console.log(v.whois+' start.');
  try {
    v.step = 1.1; // 描画領域をクリア
    parent.innerHTML = `
    <div class="summary">
      <div name="qrcode"></div>
      <div name="entryNo">No.<span class="v"></span></div>
      <div name="申込者氏名"><ruby><span class="v"></span>
        <rt name="申込者カナ"><span class="v"></span></rt>
      </ruby></div>
    </div>

    <div class="list">
      <div class="label">
        <p>参加者一覧</p>
        <button>表示</button>
      </div>
      <div class="content">
        <div class="th">No</div>
        <div class="th">氏名</div>
        <div class="th">所属</div>
        <div class="th">参加費</div>
      </div>
    </div>

    <div class="detail">
      <div class="label">
        <p>詳細情報</p>
        <button>非表示</button>
      </div>
      <div class="content"></div>
      <div class="message">
        <div name="editURL">
          <p>参加者一覧・詳細情報に誤謬・変更がある場合、以下のボタンをクリックして申込フォームを開いて修正してください。</p>
          <button>申込フォームを開く</button>
        </div>
      </div>
    </div>

    <div class="buttons">
      <button name="取消">取消</button>
      <button name="決定">決定</button>
      <button name="全員">全員<br>受領</button>  
    </div>
    `;

    v.step = 1.2; // モード(編集/参照)を特定
    opt.edit = opt.edit || false; //  既定値は参照モード
    opt.showList = opt.edit || opt.showList || false;
    opt.showDetail = opt.showDetail || false;
    console.log(opt);

    v.step = 1.3; // ボタンの初期状態設定
    // 参加者一覧開閉ボタン
    v.toggle('.list',opt.showList);
    parent.querySelector('.list .label button')
    .addEventListener('click',v.toggle);
    // 詳細情報開閉ボタン
    v.toggle('.detail',opt.showDetail);
    parent.querySelector('.detail .label button')
    .addEventListener('click',v.toggle);

    v.step = 2; // QRコード、受付番号、申込者名
    info.entryStr = String('0000'+info.entryNo).slice(-4);
    v.qrcode = parent.querySelector('[name="qrcode"]');
    v.qrSize = v.qrcode.clientWidth;
    new QRCode(v.qrcode,{
      text: info.entryStr,
      width: v.qrSize,
      height: v.qrSize,
      colorDark: "#000",
      colorLight: "#fff",
      correctLevel : QRCode.CorrectLevel.H,
    });

    ['entryNo','申込者氏名','申込者カナ'].forEach(x => {
      v.x = x;
      v.element = parent.querySelector('[name="'+x+'"] .v');
      v.element.innerText = info[v.x];
    });

    v.step = 3; // 参加者一覧
    v.list = parent.querySelector('div.list .content');
    for( v.i=1 ; v.i<6 ; v.i++ ){
      v.prefix = '参加者0' + v.i;
      if( info[v.prefix+'氏名'].length === 0 )
        continue;
      v.list.appendChild(createElement({
        attr: {class:'td'},
        style: {textAlign:'right'},
        text: v.i,
      }));
      v.list.appendChild(createElement(
        {attr: {class:'td'},children:[
          {tag:'ruby',text:info[v.prefix+'氏名'],children:[
            {tag:'rt',text:info[v.prefix+'カナ']}
      ]}]}));
      v.list.appendChild(createElement({
        attr: {class:'td'},
        text: info[v.prefix+'所属'],
      }));
      v.list.appendChild(createElement({
        attr: {class:'td'},
        text: info['fee0'+v.i],
      }));
    }

    v.step = 4.1; // 詳細情報
    v.detail = parent.querySelector('div.detail .content');
    ["メールアドレス","申込者の参加","宿泊、テント","引取者氏名","緊急連絡先",
    "ボランティア募集","キャンセル","備考"].forEach(x => {
      v.detail.appendChild(createElement({
        attr: {class:'th'},
        text: x,
      }));
      v.detail.appendChild(createElement({
        attr: {class:'td'},
        text: info[x],
      }));
    });
    v.step = 4.2; // 編集用URL
    v.detail.appendChild(createElement({
      attr: {class:'th'},
      text:'申込内容修正',
    }));
    v.detail.appendChild(createElement({
      tag:'button',
      text: '申込フォームを開く',
      event: {'click':()=>window.open(info.editURL,'_blank')},
    }));

    // ボタン領域の定義、ボタンクリック時の動作定義
    v.step = 5.1; // ボタンの幅を取得、高さにも適用して正方形に
    v.buttonSize = parent.querySelector('.buttons button').clientWidth;
    console.log(v.buttonSize);
    parent.querySelectorAll('.buttons button').forEach(x => {
      x.style.height = v.buttonSize + 'px';
      console.log(x.style.height,x);
    });
    v.step = 5.2; // 取消ボタンクリック時の動作定義
    v.step = 5.3; // 決定ボタンクリック時の動作定義
    v.step = 5.4; // 全員受領ボタンクリック時の動作定義

    v.step = 5.5; // 参加者一覧・詳細情報開閉ボタン
    parent.querySelector('.label button')
    .addEventListener('click',v.toggle);


    console.log(v.whois+' normal end.',v.rv);
    return v.rv;

  } catch(e){
    console.error(v.whois+' abnormal end(step.'+v.step+').',e,v);
    return e;
  }
}
window.addEventListener('DOMContentLoaded',async () => {
  const v = {whois:'DOMContentLoaded',opt:[
    {}, // 既定値の動作確認
    {edit:true},
    {edit:false},
  ]};
  console.log(v.whois+' start.');
  try {

    v.rv = await drawPassport(
      document.querySelector('div.drawPassport'),
      kokusho,
      v.opt[2], // テストパターンの指定
    );
    if( v.rv instanceof Error ) throw v.rv;
    console.log(v.whois+' normal end.',v.rv);

  } catch(e){
    console.error(e,v);
  }
});

const kokusho = {"タイムスタンプ":"2023-08-01T06:36:48.485Z","メールアドレス":"nakaone.kunihiro@gmail.com","申込者氏名":"国生　さゆり","申込者カナ":"コクショウ　サユリ","申込者の参加":"参加予定(宿泊あり)","宿泊、テント":"宿泊する(テントなし)","引取者氏名":"申込者が参加して帰宅時の付添もするのでお迎えは不要","参加者01氏名":"国生　二郎","参加者01カナ":"コクショウ　ジロウ","参加者01所属":"未就学児","参加者02氏名":"","参加者02カナ":"","参加者02所属":"","参加者03氏名":"","参加者03カナ":"","参加者03所属":"","参加者04氏名":"","参加者04カナ":"","参加者04所属":"","参加者05カナ":"","参加者05氏名":"","参加者05所属":"","緊急連絡先":"","ボランティア募集":"","備考":"","キャンセル":"","":"","name":"","entryStr":"","authority":"2","cancel":"","entryNo":"8","publicKey":"iPUMOS7fuuwQngJys2i1C+5D6bvmjrW82a0PXfyGYAyCyrlqSv8LXQdlHqwQeyrwoOv41SOaAVmLKFIFNpBBjmplfFFIxg4f6GAiVikHCMigqmCg+0XvHUEsQMSO5VHze9Sd1Tml/kcmpUEPg8zsIVSK6oFKQWLe69VFKMKt7T8=","editURL":"https://docs.google.com/forms/d/e/1FAIpQLScEzS8-uNgeM40rZvGl60uZewwHZhyPeQJAicS_LjMEYrMqfQ/viewform?edit2=2_ABaOnueEf0MZp9TyeRuVRGK6toYaRDxYmY5_-w_psQH_VRBlAkAfIB2h8Kay9qRUUITM98E","passCode":"868670","genPassCode":"2023-08-25T04:43:06.611Z","NG1":"","NG2":"","certificate":"2023-08-25T04:43:33.237Z","fee00":"","fee01":"","fee02":"","fee03":"","fee04":"","fee05":"","memo":""};
</script>
</html>