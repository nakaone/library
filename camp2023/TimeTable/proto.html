<!DOCTYPE html><html xml:lang="ja" lang="ja"><head>
<title></title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!--
<link href="../szLib.css" rel="stylesheet" />
-->
<style type="text/css" name="TimeTable">
.section {
  display: grid;
  grid-template-columns: 1fr;
}
.TimeTable .table {
  position: relative;
}
.TimeTable .unit {
  position: absolute;
  display: grid;
  grid-template-columns: 2rem 1fr 2rem;
  grid-template-rows: 1rem 1rem;
}
.TimeTable .unit .start {
  grid-row: 1 / 2;
  grid-column: 1 / 2;
  font-size: 0.7rem;
}
.TimeTable .unit .end {
  grid-row: 1 / 2;
  grid-column: 3 / 4;
  font-size: 0.7rem;
  text-align: right;
}
.TimeTable .unit .main {
  grid-row: 2 / 3;
  grid-column: 1 / 4;
  border-top: solid 0.5rem red;
  overflow: visible;
  white-space: nowrap;
}
.source {
  display: none;
}
</style>
</head><body>
<div id="TimeTable">
  <!--
    {title:"",start:"",end:"",place:"",charge:"",summary:"",note:"",resources:[]},
    {name:"",quantity:0,unit:"",procure:"",note:""}
    endがnull ⇒ マイルストーン
  -->
  <div class="source">{
    config:{
      start: '2023/09/30 08:00:00', // 表示範囲の開始時刻
      end:   '2023/10/01 12:00:00', // 表示範囲の終了時刻
      spanUnit: 2, // 1分当りの表示幅。px
      rowUnit: 40, // 1アイテム当りの表示高。px
    },
    source:[
      {section:{title:'',description:''},list:[
        {title:"スタッフ集合",start:"8:30",end:null,  // 単一行コメント
        place:"",charge:"",summary:"",note:"",resources:[]},
        {'title':'オリエンテーション',start:"8:30",end:"8:40",
        place:"",charge:"",summary:"",note:"",resources:[]},
        {title:"テント設営",start:"8:40",end:"9:10",
        place:"",charge:"",summary:"",note:"",resources:[]},
      ]},
    ],
  }</div>
</div>


<div class="TimeTable">
  <div class="wrapper">
    <div class="section" name="staff">
      <!--div class="title">全体</div>
      <div class="description">description</div-->
      <div class="table"><!-- 10分 = 1rem -->
        <div class="unit" style="top:0rem; left:3rem; width:1rem;">
          <div class="start" style="width:1rem">8:30</div>
          <div class="main" style="width:1rem">オリエンテーション</div>
        </div>
        <div class="unit" style="top:3rem; left:4rem; width:3rem;">
          <div class="start">8:40</div>
          <div class="end">9:10</div>
          <div class="main">テント設営</div>
        </div>
        <!-- カレー関係 -->
        <div class="unit" style="top:6rem; left:4rem; width:8rem;">
          <div class="start">8:40</div>
          <div class="end">10:00</div>
          <div class="main">買い出し(神内氏、3〜4名)</div>
        </div>
        <div class="unit" style="top:9rem; left:7rem; width:11rem;">
          <div class="start">9:10</div>
          <div class="end">11:00</div>
          <div class="main">灯油買出(岩佐氏)、災害用鍋準備</div>
        </div>
      </div>
    </div>
  </div>

</div>
</body>
<script type="text/javascript">

/** JavaScriptオブジェクト記述形式の文字列をオブジェクト化
 *
 * ## 処理内容
 *
 * - コメントを削除
 * - メンバ名をダブルクォーテーションで囲む
 * - 末尾にカンマがあれば削除
 * - シングルクォーテーション内にダブルクォーテーションがあればエスケープ
 *
 * ## 注意事項
 *
 * - ダブルクォーテーション内部のシングルクォーテーション使用は不可<br>
 *   ex."スタッフ'集合'"
 * - シングルクォーテーション内部のシングルクォーテーション使用は不可<br>
 *   ex.'ab\'cde\''
 *
 * ## テストソース
 *
 * {日本語:0,ひらがな:1,カタカナ:2,かナ漢字:3,全部載せAb1:4},
 * {
 *    p1:0,p2:'abc',p3:"abc",p4:'ab"c"',p5:"ab\"c\"",
 *    //NG p6:"ab'c'",
 *    //NG p7:'ab\'c\'',
 * },

 */
function objectize(str){
  const v = {whois:'objectize',step:0,rv:null};
  console.log(v.whois+' start.',str);
  try {
    // 単一行コメントの削除
    v.rv = str.replaceAll(/[\s\t]*\/\/.*?\n/g,' ');
    // JavaScript/CSS複数行コメントの削除
    v.rv = v.rv.replaceAll(/\/\*[\S\s]+?\*\//g,' ');

    // シングルクォーテーションで囲まれていた場合、ダブルクォーテーションに置換
    // 注：既に"〜"で囲まれていた場合、特に問題ないのでそのまま
    v.rv.match(/'.+?'/g).forEach(x => {
      // x1: シングルクォーテーションで囲まれた中身
      v.x1 = x.match(/^'(.*)'$/)[1];
      // ダブルクォーテーションをエスケープ
      v.x1 = v.x1.replaceAll('"','\\"');
      // ダブルクォーテーションで囲む
      v.x2 = '"' + v.x1 + '"';
      // 全体を通じて置換
      v.rv = v.rv.replaceAll(x, v.x2);
    });

    // クォーテーションで囲まれていないラベルをダブルクォーテーションで囲む
    v.label = '[A-Za-z0-9_'
    + '\u3041-\u3096' // ひらがな
    + '\u30A1-\u30FA' // かたかな
    + '々〇〻\u3400-\u9FFF\uF900-\uFAFF'  // 漢字
    + ']+';
    // r1: 囲まれていないラベルを区切り記号`{(,:`ごと抽出
    v.r1 = new RegExp('[\\[\\{,]\\s*'+v.label+'\\s*:\\s*','g');
    // r2: 区切り記号を$1,ラベルを$2にセット
    v.r2 = new RegExp('([\\[\\{,])\\s*('+v.label+')');
    console.log(v.label,v.r1,v.r2);
    v.rv.match(v.r1).forEach(x => {
      v.x1 = x.match(v.r2);
      v.x2 = v.x1[1] + '"' + v.x1[2] + '":';
      v.rv = v.rv.replaceAll(x, v.x2);
    });

    // 各行先頭・末尾の余白、改行を削除
    v.rv = v.rv.replaceAll(/\s*\n\s*/g,'');

    // ']}'直前のカンマを削除
    v.rv = v.rv.replaceAll(/,\s*]/g,']').replaceAll(/,\s*}/g,'}');
    console.log(v.rv);

    // JSON化
    v.rv = JSON.parse(v.rv);

    v.step = 3; // 終了処理
    console.log(v.whois+' normal end.',v.rv);
    return v.rv;

  } catch(e){
    console.error(v.whois+' abnormal end(step.'+v.step+').\n',e,v);
    return e;
  }
}

/**
 * @classdesc 参加者情報の表示・編集
 *
 * - [JavaScriptでの rem ⇔ px に変換するテクニック＆コード例](https://pisuke-code.com/javascript-convert-rem-to-px/)
 */
 class TimeTable {
  /**
   * @constructor
   * @param {HTMLElement|string} parent - 親要素またはそのCSSセレクタ
   * @param {Object} [opt={}] - オプション
   * @returns {true|Error}
   */
  constructor(parent,opt={}){
    const v = {whois:'TimeTable.constructor',rv:true,step:0,
      default:{ // メンバ一覧、各種オプションの既定値、CSS/HTML定義
        // メンバとして持つHTMLElementの定義
        parent: parent, // {HTMLElement} 親要素
        parentSelector: null, // {string} 親要素のCSSセレクタ
        wrapper: null, // {HTMLElement} ラッパー
        wrapperSelector: null, // {string} ラッパーのCSSセレクタ
        style: null,  // {HTMLStyleElement} CSS定義
        // CSS/HTML定義
        css:[
          /* TimeTable共通部分 */ `
          .TimeTable.act {
            margin: 1rem;
            width: calc(100% - 2rem);
            display: grid;
            row-gap: 1rem;
            grid-template-columns: 1fr;
          }
          .TimeTable {
            display: none;
          }`,
        ],
        html:[],
      },
    };
    console.log(v.whois+' start.',parent,opt);
    try {

      v.step = 1; // メンバの値セット、HTML/CSSの生成
      v.rv = setupInstance(this,opt,v.default);
      if( v.rv instanceof Error ) throw v.rv;


      v.step = 4; // 終了処理
      this.close();
      console.log(v.whois+' normal end.',v.rv);
      return v.rv;
    } catch(e){
      console.error(v.whois+' abnormal end(step.'+v.step+').\n',e,v);
      return e;
    }
  }

  /** 表示/非表示ボタンクリック時の処理を定義
   * @param {PointerEvent|string} event - クリック時のイベントまたはボタンのCSSセレクタ
   * @param {boolean} show - trueなら開く
   * @returns {void}
   */
  toggle = (event,show) => {
    const v = {whois:'TimeTable.toggle',step:1,rv:null};
    console.log(v.whois+' start.',event,show);
    try {

      let content;  // 表示/非表示を行う対象となる要素
      let button;   // クリックされたボタンの要素
      if( typeof event === 'string' ){
        v.step = 1.1; // 初期設定時(引数がPointerEventではなくstring)
        content = this.wrapper.querySelector(event+' .content');
        button = this.wrapper.querySelector(event+' button');
      } else {
        v.step = 1.2; // ボタンクリック時
        content = event.target.parentElement.parentElement
        .querySelector('.content');
        button = event.target;
      }

      v.step = 2; // 表示->非表示 or 非表示->表示 を判断
      let toOpen = show ? show : (button.innerText === '表示');
      if( toOpen ){
        v.step = 2.1; // 表示に変更する場合
        button.innerText = '非表示';
        content.classList.add('act');
      } else {
        v.step = 2.2; // 非表示に変更する場合
        button.innerText = '表示';
        content.classList.remove('act');
      }

      v.step = 3;
      console.log(v.whois+' normal end.',v.rv);
      return v.rv;

    } catch(e){
      console.error(v.whois+' abnormal end(step.'+v.step+').\n',e,v);
      return e;
    }
  }

  /** 親要素内を表示 */
  open = () => {
    this.wrapper.classList.add('act');
  }

  /** 親要素内を隠蔽 */
  close = () => {
    this.wrapper.classList.remove('act');
  }

  /**
   * @returns {null|Error}
   */
  template = () => {
    const v = {whois:'TimeTable.template',step:0,rv:null};
    console.log(v.whois+' start.');
    try {

      v.step = 3; // 終了処理
      console.log(v.whois+' normal end.',v.rv);
      return v.rv;

    } catch(e){
      console.error(v.whois+' abnormal end(step.'+v.step+').\n',e,v);
      return e;
    }
  }
}

window.addEventListener('DOMContentLoaded',() => {
  const v = {};
  v.source = document.querySelector('.source').innerText;
  v.data = objectize(v.source);

  v.rv = new TimeTable('.TimeTable',v.data);
});
</script>
</html>