<!DOCTYPE html><html xml:lang="ja" lang="ja"><head>
<title>proto3</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!--
<link href="../szLib.css" rel="stylesheet" />
-->
<style type="text/css">
.TimeTable[name="wrapper"] {
  display: block;
  width: 100%;
}
.TimeTable .table {
  display: grid;
  grid-template-columns: 4rem repeat(20, 0.5rem) repeat(77, 1fr)
}
.TimeTable .st, .TimeTable .ed {
  grid-column: 1 / 2;
  margin: auto 0.5rem auto auto;
  padding: 0.3rem 0;
  font-size: 0.8rem;
}
.TimeTable .label {
  border-left: solid 4px #666;
  padding-left: 2px;
  z-index: 2;
}
.TimeTable .line:nth-child(2n) {
  grid-column: 2 / 99;
  background-color: #eee;
  z-index: 1;
}
/* 印刷用
.TimeTable .line {
  grid-column: 2 / 99;
  border-top: dashed 1px #aaa;
  z-index: 1;
}
*/
</style>
</head><body>
<div id="TimeTable" class="TimeTable" name="wrapper">
  <div class="control">
    <select>
      <option value="16" selected>参加者</option>
      <option value="1">設営関係</option>
      <option value="2">受付関係</option>
      <option value="4">校内探検関係</option>
      <option value="8">カレー関係</option>
    </select>
  </div>
  <div class="table"></div>
</div>

</body>
<script type="text/javascript" src="../createElement.js"></script>
<script type="text/javascript" src="../mergeDeeply.js"></script>
<script type="text/javascript" src="../whichType.js"></script>
<script type="text/javascript">
class TimeTable {
  constructor(data){
    const v = {whois:'TimeTable.constructor',step:0,rv:null};
    console.log(v.whois+' start.',data);
    try {
      v.step = 1; // DOMをメンバとして登録
      this.wrapper = document.querySelector('.TimeTable[name="wrapper"]');
      this.table = this.wrapper.querySelector('.table');

      v.step = 2; // 開始時刻順にソート
      this.data = data;
      this.data.list = this.data.list.sort((a,b) => a.st < b.st ? -1 : 1);
      console.log(this.data);

      v.step = 3; // 起算オブジェクト(this.base)の計算
      // this.base.date: {number[]} - 起算点年月日を[y, M, d]形式にした配列
      this.base = {date:this.data.base.match(/\d{4}\/\d{2}\/\d{2}/)[0].split('/')};
      this.base.date[1] -= 1;  // 月は0オリジンなので修正
      // this.base.time: {number} - (時刻を含む)起算点のUNIX時刻
      this.base.time = new Date(
        ...this.base.date,
        ...this.data.base.match(/\d{2}:\d{2}/)[0].split(':')
      ).getTime();
      console.log('this.base=%s',JSON.stringify(this.base));

      v.step = 4; // イベント定義
      this.wrapper.querySelector('select')
      .addEventListener('change',this.drawTable);

      v.step = 5; // 終了処理
      this.drawTable(); // 初期画面表示
      console.log(v.whois+' normal end.',v.rv);
      return v.rv;

    } catch(e){
      console.error(v.whois+' abnormal end(step.'+v.step+').\n',e,v);
      return e;
    }
  }

  calc = (tm) => { // 時刻tmのgrid-rowとラベルを返す
    const dObj = new Date(...this.base.date, ...tm.split(':'));
    return {
      row: (dObj.getTime() - this.base.time) / this.data.span,
      label: ('0'+dObj.getHours()).slice(-2)
        + ':' + ('0'+dObj.getMinutes()).slice(-2)
    };
  }

  drawTable = () => {
    const v = {whois:'TimeTable.drawTable',step:0,rv:null,list:[],line:[]};
    console.log(v.whois+' start.',this.data);
    try {

      v.step = 1; // 前処理
      this.table.innerHTML = '';

      v.step = 2; // 表示対象フラグを取得
      v.flag = Number(this.wrapper.querySelector('select').selectedOptions[0].value);
      console.log('v.flag=%s',v.flag);

      v.step = 3; // 表示対象となるタスクを抽出
      this.data.list.forEach(x => {
        if( (v.flag & x.tag) > 0 ) v.list.push(x);
      });
      console.log('v.list=%s',JSON.stringify(v.list));

      v.step = 4; // タスクを表示
      for( v.i=0 ; v.i<v.list.length ; v.i++ ){
        v.step = 4.1; // 表示レベルを計算
        v.list[v.i].level = 0;
        for( v.j=0 ; v.j<v.i ; v.j++ ){
          if( v.list[v.j].ed >= v.list[v.i].st ){
            // 先行するタスクの終了時刻が表示対象タスクの開始時刻以後の場合
            // 表示レベルを上げる(右にシフトして表示するようにする)
            v.list[v.i].level = v.list[v.j].level + 1;
          }
        }

        v.step = 4.2; // 開始・終了時刻を表示
        v.st = this.calc(v.list[v.i].st);
        v.ed = this.calc(v.list[v.i].ed);
        this.table.appendChild(createElement({
          attr:{class:'st'},
          text:v.st.label,
          style:{'grid-row': (v.st.row * 2 + 1) + ' / ' + (v.st.row * 2 + 3)},
        }));
        this.table.appendChild(createElement({
          attr:{class:'ed'},
          text:v.ed.label,
          style:{'grid-row': (v.ed.row * 2 + 1) + ' / ' + (v.ed.row * 2 + 3)},
        }));

        v.step = 4.3; // ラベルを表示
        this.table.appendChild(createElement({
          attr:{class:'label'},
          text:v.list[v.i].label,
          style:{
            'grid-column': (v.list[v.i].level + 2) + ' / 99',
            'grid-row': (v.st.row * 2 + 2) + ' / ' + (v.ed.row * 2 + 2),
          },
        }));
        // 「上に」補助線を引く要素のgrid-rowを保存
        v.line.push(v.st.row * 2 + 2);
        v.line.push(v.ed.row * 2 + 2);

      }

      v.step = 5; // 補助線を表示
      console.log(JSON.stringify(v.line));
      v.line = [...new Set(v.line)];
      console.log(JSON.stringify(v.line));
      v.line.sort((a,b)=>{return a < b ? -1 : 1});  // 重複を排除してソート
      console.log(JSON.stringify(v.line));
      for( v.i=1 ; v.i<v.line.length ; v.i++ ){
        this.table.appendChild(createElement({
          attr:{class:'line'},
          style:{'grid-row':v.line[v.i-1]+' / '+v.line[v.i]},
        }));

      }

      v.step = 6;
      console.log(v.whois+' normal end.',v.rv);
      return v.rv;

    } catch(e){
      console.error(v.whois+' abnormal end(step.'+v.step+').\n',e,v);
      return e;
    }
  }

}

window.addEventListener('DOMContentLoaded',() => {
  const data = {
    base: '2023/09/30 08:30', // 表示領域左端の時刻
    span: 10 * 60 * 1000, // 時刻目盛の最小単位。既定値は10分(ミリ秒表記)
    list: [
      {st:'08:30', ed:'09:00', label:'集合、オリエンテーション', tag:15, PIC:''},

      // 本部・設営班 (v.flag=1)
      {st:'09:00', ed:'09:20', label:'本部テント設営', tag:1, PIC:'', note:[
        'ランタンと電源準備',
        '受付は机2椅子4',
        'ウォーターサーバ設置、麦茶＋コップ(スタッフ用)を用意',
      ]},
      {st:'09:20', ed:'09:40', label:'受付テント設営', tag:3, PIC:'', note:[
        '受付は机2椅子4＋カラーコーン5,6個',
      ]},
      {st:'09:40', ed:'10:30', label:'ブルーシート敷設、区画線引', tag:1, PIC:''},
      {st:'13:40', ed:'17:30', label:'参加者テント設営対応', tag:1, PIC:''},
      {st:'20:30', ed:'21:00', label:'就寝準備', tag:17, PIC:''},
      {st:'21:00', ed:'29:00', label:'夜間巡回', tag:15, PIC:''},
      {st:'32:00', ed:'34:00', label:'片付け', tag:15, PIC:''},
      {st:'33:00', ed:'33:10', label:'閉会式', tag:16, PIC:''},

      // 受付班 (v.flag=2)
      {st:'09:40', ed:'10:00', label:'案内標識設置', tag:2, PIC:'',note:[
        '東門に「正門に回ってください」の標識',
      ]},
      {st:'10:00', ed:'11:00', label:'予行演習', tag:2, PIC:'',note:[]},
      {st:'13:30', ed:'16:00', label:'受付', tag:18, PIC:'嶋津＋2,3名',note:[
        '「受付開始以降、校庭遊び禁止」を注意書きに付記',
        '「遊んだものは片付けよう」の注意書き(＋標識？)',
      ]},
      {st:'19:00', ed:'21:00', label:'お迎え対応', tag:2, PIC:'',note:[
        'お迎えの個別確認はしない(声かけのみ)',
      ]},

      // 校内探検班 (v.flag=4)
      {st:'14:00', ed:'17:00', label:'校内探検準備', tag:4, PIC:'八木氏＋3,4名'},
      {st:'17:00', ed:'17:30', label:'お化け集合、打ち合わせ', tag:4, PIC:''},
      {st:'18:30', ed:'20:30', label:'校内探検', tag:21, PIC:''},

      // カレー班 (v.flag=8)
      {st:'09:00', ed:'09:30', label:'灯油買い出し', tag:8, PIC:'岩佐氏'},
      {st:'09:20', ed:'10:20', label:'カレー鍋設営', tag:8, PIC:'岩佐氏'},
      {st:'09:30', ed:'11:00', label:'材料買い出し', tag:8, PIC:'', note:[
        '買い出し用に飯田氏が車提供',
      ]},
      {st:'13:00', ed:'17:30', label:'カレー準備', tag:8, PIC:'神内氏、鐘江氏、＋8名位'},
      {st:'29:00', ed:'30:30', label:'朝食準備', tag:8, PIC:'',note:[
        '「紙コップ、箸の準備」を注意書きに付記',
        '紙コップ・箸は各自準備だが、不足に備え多少購入しておく',
        '素麺つゆはおやじで準備',
      ]},

      // 一般参加者 (v.flag=16)
      {st:'14:00', ed:'14:10', label:'開会式', tag:17, PIC:'会長、校長or副校長'},
      {st:'13:40', ed:'17:30', label:'テント設営、自由行動(遊戯)', tag:16, PIC:''},
      {st:'17:30', ed:'18:30', label:'カレー配膳、夕食', tag:24, PIC:''},
      {st:'19:00', ed:'21:00', label:'日帰り組帰宅(要お迎え)', tag:16, PIC:''},

      //{st:'21:00', ed:'30:30', label:'就寝', tag:16, PIC:''},
      {st:'30:30', ed:'31:00', label:'起床', tag:16, PIC:''},
      {st:'31:00', ed:'31:10', label:'ラジオ体操', tag:16, PIC:''},
      {st:'31:10', ed:'33:00', label:'片付け', tag:16, PIC:''},
      {st:'31:30', ed:'32:00', label:'朝食', tag:16, PIC:''},
    ],
  };
  const v = {};

  v.TimeTable = new TimeTable(data);
  //v.TimeTable.drawTable();


});
</script>
</html>