<!DOCTYPE html><html xml:lang="ja" lang="ja"><head>
<title>proto4</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css" class="core"></style>
</head><body><div id="TimeTable"></div></body>
<!-- 外部Script -->
<!-- 自作ライブラリ -->
<script type="text/javascript" src="../setupInstance/core.js"></script>
<script type="text/javascript" src="../createElement.js"></script>
<script type="text/javascript" src="../mergeDeeply.js"></script>
<script type="text/javascript" src="../whichType.js"></script>
<script type="text/javascript">
/**
 * @classdesc 参加者情報の表示・編集
 *
 * - [JavaScriptでの rem ⇔ px に変換するテクニック＆コード例](https://pisuke-code.com/javascript-convert-rem-to-px/)
 */
class TimeTable {

  /** Resource: 必要資材型定義
   * @typedef Resource
   * @prop {string} name - 資材名
   * @prop {number} [quantity] - 数量
   * @prop {string} [unit] - 単位
   * @prop {string} [procure] - 調達方法
   * @prop {number} [budget] - 予算
   * @prop {string} [note] - 備考
   */

  /** Task: 作業項目型定義
   * 開始・終了時刻はbaseの日付。翌日以降にまたがる場合、+24n時間する
   * @typedef Task
   * @prop {string} st - 開始時刻。constructorでTimeLineに変換
   * @prop {string} ed - 終了時刻。constructorでTimeLineに変換
   * @prop {string} label - タスク名称
   * @prop {string} [summary=''] - 作業概要
   * @prop {number} tag - 担当グループのフラグ
   * @prop {string} [PIC=''] - 担当者名
   * @prop {string} [location=''] - 場所
   * @prop {string} [note] - 備考。htmlで記述
   * @prop {string[]} [pending=[]] - 懸念点、残課題事項
   * @prop {Resource[]} [resources=[]] - 必要な物
   * 以下はconstructor内で追加される導出項目
   * @prop {number} id - 0からの連番(this.tasksの添字)
   */

  /** ドロップダウンオプション(作業班)
   * @typedef DropDownOpt
   * @prop {string} label - ラベル
   * @prop {number} value - 表示制御フラグ
   */

  /**
   * @constructor
   * @param {HTMLElement|string} parent - 親要素またはそのCSSセレクタ
   * @param {Object} [opt={}] - オプション
   * @returns {true|Error}
   */
  constructor(parent,opt={}){
    const v = {whois:'TimeTable.constructor',rv:true,step:0,
      default:{ // メンバ一覧、各種オプションの既定値、CSS/HTML定義
        base: '', // {string} - 基準日。yyyy/MM/dd形式
        baseObj: null, // {Date} - 基準日の日付オブジェクト
        baseArr: [], // {number[]} - 基準日の[y,M,d]
        span: 10 * 60 * 1000, // 時刻目盛の最小単位。既定値は10分(ミリ秒表記)
        options: [],  // ドロップダウンの選択肢(select内のoption)
        tasks: [], // {Task[]} - 開始・終了時刻順に並べたタスク配列
        min: Infinity, // {number} - 開始時刻の最小値(UNIX時間)
        max: -Infinity, // {number} - 終了時刻の最大値(UNIX時間)

        // メンバとして持つHTMLElementの定義
        parent: parent, // {HTMLElement} 親要素
        parentSelector: null, // {string} 親要素のCSSセレクタ
        wrapper: null, // {HTMLElement} ラッパー
        wrapperSelector: null, // {string} ラッパーのCSSセレクタ
        style: null,  // {HTMLStyleElement} CSS定義

        // CSS/HTML定義
        css:[
          /* TimeTable共通部分 */ `
          .TimeTable[name="wrapper"] {
            display: none;
            z-index: 0;
          }
          .TimeTable[name="wrapper"].act {
            display: block;
          }
          .TimeTable .table {
            display: grid;
            grid-template-columns: repeat(var(--colNum), 1rem) 1fr;
            grid-template-rows: 1.5rem 3rem repeat(var(--rowNum), 1.5rem);
          }
          .TimeTable .table .time {
            grid-row: 2 / 3;
            font-size: 0.8rem;
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            transform-origin: center;
          }
          .TimeTable .table .task {
            background-color: #bbb;
          }
          .TimeTable .table .zone {
            grid-row: 3 / calc(var(--rowNum) + 3);
            border: solid 1px red;
          }
          `,
          /*
            transform: rotate(-90deg);
          */
        ],
        html:[
          {attr:{class:'control'},children:[{tag:'select'}]},
          {attr:{class:'table'}},
          {attr:{class:'detail'}},
        ],
      },
    };
    console.log(v.whois+' start.',parent,opt);
    try {

      v.step = 1; // メンバの値セット、HTML/CSSの生成
      v.rv = setupInstance(this,opt,v.default);
      if( v.rv instanceof Error ) throw v.rv;

      v.step = 2; // DOMをメンバとして登録
      this.table = this.wrapper.querySelector('.table');
      this.select = this.wrapper.querySelector('.control select');
      this.detail = this.wrapper.querySelector('.detail');

      v.step = 3; // プルダウンを設定
      this.options.forEach(x => {
        this.select.appendChild(createElement(
          {tag:'option',attr:{value:x.value},text:x.label},
        ))
      });

      v.step = 4; // base文字列からbaseObj, baseArrを作成
      this.baseObj = new Date(this.base);
      if( isNaN(this.baseObj.getTime()) )
        throw new Error('"'+this.base+'" is invalid datetime.');
      this.baseArr = [
        this.baseObj.getFullYear(),
        this.baseObj.getMonth(),
        this.baseObj.getDate()
      ];

      v.step = 5.1; // 表示する時間帯の計算
      ['st','ed'].forEach(x => {
        this.tasks.forEach(y => {
          y[x] = this.objectizeTime(y[x]);
          if( y[x] instanceof Error ) throw y[x];
          this.min = this.min < y[x].unix ? this.min : y[x].unix;
          this.max = this.max > y[x].unix ? this.max : y[x].unix;
        });
      });
      v.step = 5.2; // CSS変数colNumに値をセット
      v.num = (this.max - this.min) / this.span;
      document.documentElement.style.setProperty('--colNum',v.num);

      v.step = 6; // 開始時刻・終了時刻順にソート
      this.tasks = this.tasks.sort(
        (a,b) => a.st.unix === b.st.unix
        ? (a.ed.unix <= b.ed.unix ? -1 : 1)
        : (a.st.unix < b.st.unix ? -1 : 1)
      );

      v.step = 7; // タスクの初期値設定
      for( v.i=0 ; v.i<this.tasks.length ; v.i++ ){
        this.tasks[v.i].id = v.i;
        this.tasks[v.i].st = this.calcLine(this.tasks[v.i].st);
        if( this.tasks[v.i].st instanceof Error )
          throw new Error('"' + JSON.stringify(this.tasks[v.i]) + '" is invalid start time.');
        this.tasks[v.i].ed = this.calcLine(this.tasks[v.i].ed);
        if( this.tasks[v.i].ed instanceof Error )
          throw new Error('"' + JSON.stringify(this.tasks[v.i]) + '" is invalid end time.');
        this.tasks[v.i].summary = this.tasks[v.i].summary || '';
        this.tasks[v.i].PIC = this.tasks[v.i].PIC || '';
        this.tasks[v.i].location = this.tasks[v.i].location || '';
        this.tasks[v.i].pending = this.tasks[v.i].pending || [];
        this.tasks[v.i].resources = this.tasks[v.i].resources || [];
        this.tasks[v.i].note = this.tasks[v.i].note || '';
      }

      v.step = 8; // イベント定義、初期画面表示
      this.select.addEventListener('change',this.drawGantt);
      v.rv = this.drawGantt();
      if( v.rv instanceof Error ) throw v.rv;

      v.step = 9; // 終了処理
      console.log(v.whois+' normal end.',this);
      return v.rv;
    } catch(e){
      console.error(v.whois+' abnormal end(step.'+v.step+').\n',e,v);
      return e;
    }
  }

  /** TimeLine: タイムラインオブジェクト型定義
   * @typedef TimeLine - タイムラインオブジェクト
   * @prop {Date} obj - 日時オブジェクト
   * @prop {number} unix - 日時オブジェクトのUNIX時刻
   * @prop {string} dateStr - 表示用日付文字列。yyyy/MM/dd形式
   * @prop {string} timeStr - 表示用時刻文字列。hh:mm形式
   * @prop {number} time - 時刻表示の左側のグリッドライン
   * @prop {number} task - タスク表示の左側のグリッドライン
   */

  /** 時刻文字列をオブジェクトに変換
   * @param {string} arg - 時刻文字列
   * @returns {TimeLine|Error}
   */
  objectizeTime = (arg) => {
    const v = {whois:'TimeTable.objectizeTime',step:0,rv:{}};
    console.log(v.whois+' start.',arg);
    try {

      v.step = 1; // 引数をDate型に変換
      v.m = arg.match(/^([0-9]+):([0-9]+)$/);
      if( v.m === null )
        throw new Error('"'+arg+'" is invalid time string.');

      v.step = 2;
      v.d = new Date(...this.baseArr,v.m[1],v.m[2]);
      if( isNaN(v.d.getTime()) )
        throw new Error('"'+arg+'" is invalid time string.');

      v.step = 3; // 戻り値の作成
      v.rv = {
        obj: v.d,
        unix: v.d.getTime(),
        dateStr: v.d.getFullYear()
          + '/' + ('0'+(v.d.getMonth()+1)).slice(-2)
          + '/' + ('0'+v.d.getDate()).slice(-2),
        timeStr: ('0'+v.d.getHours()).slice(-2)
          + ':' + ('0'+v.d.getMinutes()).slice(-2),
      };

      v.step = 3; // 終了処理
      console.log(v.whois+' normal end.',v.rv);
      return v.rv;

    } catch(e){
      console.error(v.whois+' abnormal end(step.'+v.step+').\n',e,v);
      return e;
    }
  }


  /** 時刻オブジェクトからタイムラインを計算する
   * @param {TimeLine} arg - 時刻オブジェクト
   * @returns {TimeLine|Error}
   */
  calcLine = (arg) => {
    const v = {whois:'TimeTable.calcLine',step:0,rv:{}};
    console.log(v.whois+' start.',arg);
    try {

      v.step = 1;
      v.x = arg.unix - this.min;
      v.n = Math.round(v.x / this.span);
      if( v.n * this.span !== v.x ) // span間隔に合った時刻か確認
        throw new Error('"'+JSON.stringify(arg)+'" is invalid time TimeLine object.');

      v.step = 2;
      v.rv = Object.assign(arg,{
        time: v.n * 2 + 1,
        task: v.n * 2 + 2,
      });

      v.step = 3; // 終了処理
      console.log(v.whois+' normal end.',v.rv);
      return v.rv;

    } catch(e){
      console.error(v.whois+' abnormal end(step.'+v.step+').\n',e,v);
      return e;
    }
  }

  drawGantt = () => {
    const v = {whois:'TimeTable.drawGantt',step:0,rv:null,
      tasks:[],tl:[],timeline:[]};
    console.log(v.whois+' start.');
    try {

      v.step = 1; // 前処理
      this.table.innerHTML = '';

      v.step = 2; // 表示対象フラグを取得
      v.flag = Number(this.select.selectedOptions[0].value);
      console.log('v.flag=%s',v.flag);

      v.step = 3; // 表示対象となるタスクを抽出
      this.tasks.forEach(x => {
        if( (v.flag & x.tag) > 0 ){
          v.tl.push(x.st);
          v.tl.push(x.ed);
          v.tasks.push(x);
        }
      });
      console.log('v.tl=%s',JSON.stringify(v.tl));
      // テーブル領域の行数をセット
      document.documentElement.style.setProperty('--rowNum',v.tasks.length);

      // 時刻(タイムライン)と補助線を表示
      v.step = 4.1; // v.timelineを時刻順にソート
      v.tl = v.tl.sort((a,b) => a.unix < b.unix ? -1 : 1);
      // 時刻の重複を削除
      v.timeline = [v.tl[0]];
      for( v.i=1 ; v.i<v.tl.length ; v.i++ ){
        if( v.tl[v.i-1].unix < v.tl[v.i].unix ){
          v.timeline.push(v.tl[v.i]);
        }
      }
      console.log('v.timeline=%s',JSON.stringify(v.timeline));

      for( v.i=0 ; v.i<(v.timeline.length - 1) ; v.i++ ){
        this.table.appendChild(createElement({
          attr: {class:'time'},
          text: v.timeline[v.i].timeStr,
          style: {
            'grid-column': v.timeline[v.i].time
            + ' / ' + v.timeline[v.i+1].time
        }}));
        this.table.appendChild(createElement({
          attr: {class:'zone'},
          style: {
            'grid-column': v.timeline[v.i].task
            + ' / ' + v.timeline[v.i+1].task
        }}));
      }

      v.step = 3; // 終了処理
      console.log(v.whois+' normal end.',v.rv);
      return v.rv;

    } catch(e){
      console.error(v.whois+' abnormal end(step.'+v.step+').\n',e,v);
      return e;
    }
  }



  /**
   * @returns {null|Error}
   */
  template = () => {
    const v = {whois:'TimeTable.template',step:0,rv:null};
    console.log(v.whois+' start.');
    try {

      v.step = 3; // 終了処理
      console.log(v.whois+' normal end.',v.rv);
      return v.rv;

    } catch(e){
      console.error(v.whois+' abnormal end(step.'+v.step+').\n',e,v);
      return e;
    }
  }
}



window.addEventListener('DOMContentLoaded',() => {
  const v = {};

  v.TimeTable = new TimeTable('#TimeTable',{
    base: '2023/9/30', // 基準日
    span: 10 * 60 * 1000, // 時刻目盛の最小単位。既定値は10分(ミリ秒表記)
    options: [  // ドロップダウンの選択肢(select内のoption)
      {label:'全て',value:31},
      {label:'参加者',value:16},
      {label:'設営関係',value:1},
      {label:'受付関係',value:2},
      {label:'校内探検関係',value:4},
      {label:'カレー関係',value:8},
    ],
    // 以降の開始/終了時刻表記は①上記span単位、②hh:mm形式、③日付を跨る場合、hhは+24H
    tasks: [
      {st:'8:30', ed:'09:00', label:'集合、オリエンテーション', tag:15, PIC:'', remain:[
        '所要時間の不足を懸念、10->30分間に修正。これに伴い、オリエンテーション後の各種作業の開始時刻を繰り下げ'
      ]},
      {st:'08:40', ed:'10:00', label:'dummy', tag:15},
      {st:'08:40', ed:'10:10', label:'dummy2', tag:15},
/*
      // 本部・設営班 (v.flag=1)
      {st:'09:00', ed:'09:20', label:'本部設営', tag:1, PIC:'', note:[
        'ランタンと電源準備',
        '受付は机2椅子4',
        'ウォーターサーバ設置、麦茶＋コップ(スタッフ用)を用意',
      ], remain:[]},
      {st:'09:20', ed:'09:40', label:'受付設営', tag:3, PIC:'', note:[
        '受付は机2椅子4＋カラーコーン5,6個',
      ], remain:[]},
      {st:'09:40', ed:'10:30', label:'ブルーシート敷設、区画線引', tag:1, PIC:'', remain:[]},
      {st:'13:40', ed:'17:30', label:'参加者テント設営対応', tag:1, PIC:'', remain:[]},
      {st:'20:30', ed:'21:00', label:'就寝準備', tag:17, PIC:'', remain:[]},
      {st:'21:00', ed:'29:00', label:'夜間巡回', tag:15, PIC:'', remain:[]},
      {st:'32:00', ed:'34:00', label:'片付け(スタッフ)', tag:15, PIC:'', remain:[]},
      {st:'33:00', ed:'33:10', label:'閉会式', tag:16, PIC:'', remain:[]},

      // 受付班 (v.flag=2)
      {st:'09:40', ed:'10:00', label:'案内標識設置', tag:2, PIC:'',note:[
        '東門に「正門に回ってください」の標識',
        '正門に「参加者パスを表示してください」の標識',
      ], remain:[]},
      {st:'10:00', ed:'11:00', label:'予行演習', tag:2, PIC:'',note:[], remain:[
        '予行演習用のマニュアル整備(嶋津)'
      ]},
      {st:'13:30', ed:'16:00', label:'受付', tag:18, PIC:'嶋津＋2,3名',note:[
        '「受付開始以降、校庭遊び禁止」を注意書きに付記',
        '「遊んだものは片付けよう」の注意書き(＋標識？)',
      ], remain:[]},
      {st:'19:00', ed:'21:00', label:'お迎え対応', tag:2, PIC:'',note:[
        'お迎えの個別確認はしない(声かけのみ)',
      ], remain:[]},

      // 校内探検班 (v.flag=4)
      {st:'14:00', ed:'17:00', label:'校内探検準備', tag:4, PIC:'八木氏＋3,4名', remain:[]},
      {st:'17:00', ed:'17:30', label:'お化け集合、打ち合わせ', tag:4, PIC:'', remain:[]},
      {st:'18:30', ed:'20:30', label:'校内探検', tag:21, PIC:'', remain:[]},

      // カレー班 (v.flag=8)
      {st:'09:00', ed:'09:30', label:'灯油買い出し', tag:8, PIC:'岩佐氏', remain:[]},
      {st:'09:20', ed:'10:20', label:'カレー鍋設営', tag:8, PIC:'岩佐氏', remain:[]},
      {st:'09:30', ed:'11:00', label:'材料買い出し', tag:8, PIC:'', note:[
        '買い出し用に飯田氏が車提供',
      ], remain:[]},
      {st:'13:00', ed:'17:30', label:'カレー準備', tag:8, PIC:'神内氏、鐘江氏、＋8名位', remain:[]},
      {st:'29:00', ed:'30:30', label:'朝食準備', tag:8, PIC:'',note:[
        '「紙コップ、箸の準備」を注意書きに付記',
        '紙コップ・箸は各自準備だが、不足に備え多少購入しておく',
        '素麺つゆはおやじで準備',
      ], remain:[]},

      // 一般参加者 (v.flag=16)
      {st:'14:00', ed:'14:10', label:'開会式', tag:17, PIC:'会長、校長or副校長', remain:[]},
      {st:'13:40', ed:'17:30', label:'テント設営、自由行動(遊戯)', tag:16, PIC:'', remain:[]},
      {st:'17:30', ed:'18:30', label:'カレー配膳、夕食', tag:24, PIC:'', remain:[]},
      {st:'19:00', ed:'21:00', label:'日帰り組帰宅(要お迎え)', tag:16, PIC:'', remain:[]},

      //{st:'21:00', ed:'30:30', label:'就寝', tag:16, PIC:''},
      {st:'30:30', ed:'31:00', label:'起床', tag:16, PIC:'', remain:[]},
      {st:'31:00', ed:'31:10', label:'ラジオ体操', tag:16, PIC:'', remain:[]},
      {st:'31:10', ed:'33:00', label:'参加者テント片付け', tag:16, PIC:'', remain:[]},
      {st:'31:30', ed:'32:00', label:'朝食', tag:16, PIC:'', remain:[]},
*/

/*
*/
    ],
  });

});
</script>
</html>