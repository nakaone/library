<!DOCTYPE html><html xml:lang="ja" lang="ja"><head>
<title>onFormSubmit</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css" class="core">/* コアCSS */
</style>
</head><body>
<div><!-- 開始：HTML -->
<h1>onFormSubmit</h1>
<p>開発者コンソールの「Uncaught ReferenceError: require is not defined」は無視して問題無し</p>
</div><!-- 終了：HTML領域 -->

<div><!-- 開始：Script領域 -->
<!-- 外部Script -->

<script type="text/javascript" class="core">/* コアScript */
/** 管理局として必要な権限を要求
 * @param {void}
 * @returns {void}
 */
 function initMaster(){
  // シートへのアクセス権
  const s = szSheet('master');
  console.log(s.data.length);

  // メール発信
  console.log(MailApp.getRemainingDailyQuota());
  MailApp.sendEmail("nakaone.kunihiro@gmail.com", "test", String(new Date()));
  console.log(MailApp.getRemainingDailyQuota());
}

/** 申込フォームの入力を受け、シートの更新＋受付メールの発信を行う
 * 
 * @param {Object} e - [イベント](https://developers.google.com/apps-script/guides/triggers/events?hl=ja#form-submit)オブジェクト
 * @returns {void} なし
 * 
 * ### 処理概要
 * 
 * ```mermaid
 * sequenceDiagram
 *   autonumber
 *   actor camera as カメラ
 *   actor browser as ブラウザ
 *   actor mail as メーラ
 *   participant Form as 申込受付<br>(フォーム)
 *   participant master as 管理局
 * 
 *   camera ->> Form : QRコードから参加申請フォームへ誘導
 *   Form ->> browser : 参加申請フォーム表示
 *   browser ->> Form : 入力、送信
 *   Form ->> master : 送信内容、編集用URL
 *   activate master
 *   Note right of master : onFormSubmit()
 *   master ->> master : 受付番号採番、編集用URL保存
 *   master ->> mail : 受付番号、URL
 *   deactivate master
 * ```
 * 
 * 参加者の追加・削除やキャンセル登録のため、登録者(参加者)がフォームを編集する必要があるが、編集用URLはGoogle Spreadには記録されず、フォームの登録情報にしか存在しない。
 * 
 * そこで①フォームの登録情報を全件取得し、②引数から何行目に書かれたか特定し、③タイムスタンプをキーに編集用URLを取得、という手順を踏む。
 * 
 * <img src="https://i0.wp.com/tgg.jugani-japan.com/tsujike/wp-content/uploads/210426-001.png?w=1256&ssl=1" width="80%" />
 * 
 * ※回答シートとフォームで添字が一致しないかと考えたが、結果的には一致していない。よって「タイムスタンプのgetTime()」を検索キーとする。
 * 
 * 1. フォームから渡されるオブジェクトから以下の情報を取得
 *    1. "range"から書き込まれた行(e.range.getRow())
 *    2. "namedValues"からメールアドレス(e.namedValues["メールアドレス"][0])
 * 2. フォームの情報を取得
 *    1. 全回答情報を取得(FormApp.openById(v.formId).getResponses())
 *    2. {UNIX時刻:editURL}のマップを作成
 * 3. シート"master"に追加情報を記入
 *    1. 要既定値設定項目(entryNo/editURL/authority)の空欄に既定値を設定
 *    2. "range"から書き込まれた行の情報はメール送信用に保存
 * 4. 回答者にメールを送信
 * 
 * ### 参考
 * 
 * - [GASでGoogleフォームの値を取得する](https://walking-elephant.blogspot.com/2021/01/gas.formapp.html)
 * - GAS公式 [Class FormApp](https://developers.google.com/apps-script/reference/forms/form-app?hl=ja)
 * - GAS公式 [Class Form](https://developers.google.com/apps-script/reference/forms/form?hl=ja)
 * 
 * メール送信については以下を参照。
 * 
 * - [Google App Script メモ（メール送信制限 回避術）](https://zenn.dev/tatsuya_okzk/articles/259203cc416328)
 * - GAS公式[createDraft](https://developers.google.com/apps-script/reference/gmail/gmail-app?hl=ja#createdraftrecipient,-subject,-body,-options)
 * 
 * ### 導入時の注意
 * 
 * 以下の手順でトリガーを設定すること。<br>
 * AppsScript > 時計アイコン > トリガーを追加 > 「Masterのトリガーを追加」
 * 
 * - 実行する関数を選択：onFormSubmit
 * - 実行するデプロイを選択：Head
 * - イベントのソースを選択：スプレッドシートから
 * - イベントの種類を選択：フォーム送信時
 * - エラー通知設定：今すぐ通知を受け取る
 * 
 * ### 参考：フォーム上のonFormSubmitに渡される引数
 * 
 * <ul>
 * <li>GAS公式 <a href="https://developers.google.com/apps-script/guides/triggers/events#google_forms_events">Google フォームのイベント</a>
 * <li><a href="https://tgg.jugani-japan.com/tsujike/2021/05/gas-form5/#toc2">フォームのコンテナバインドのフォーム送信時イベントオブジェクト</a>
 * </ul>
 * <img src="https://i0.wp.com/tgg.jugani-japan.com/tsujike/wp-content/uploads/210427-001.png?w=1256&ssl=1" width="80%" />
 * <ul>
 * <li>response : <a href="https://developers.google.com/apps-script/reference/forms/form-response">Form Response</a> Object
 * <ul>
 * <li><a href="https://developers.google.com/apps-script/reference/forms/form-response#geteditresponseurl">getEditResponseUrl()</a>
 * <li><a href="https://developers.google.com/apps-script/reference/forms/form-response#gettimestamp">getTimestamp()</a>
 * </ul>
 * <li>source : <a href="https://developers.google.com/apps-script/reference/forms/form">Form</a>
 * </ul>
 */
function onFormSubmit(e){
  const v = {rv:null,form:{},
    whois:'管理局.onFormSubmit',

    // formId: フォーム編集画面のURL(下の「〜」の部分)
    // https://docs.google.com/forms/d/〜/edit
    // log > fy2023 > 20230930_校庭キャンプ > サイト・フォーム > 申込フォーム
    formId:'1wsEtp-SdI0ypsoIzaWFXH6rPEn9G5ywL98OSUqJHCyQ',

    // content: メール本文
    content: `<p>To: _name 様</p>

<p>下北沢小おやじの会です。<br>
この度は「校庭キャンプ2023」にお申し込みいただき、ありがとうございました。</p>

<p>昨年度大変多くの参加をいただいたため、今回定員オーバーの場合は申込締切日に抽選させていただき、結果はメールでご連絡差し上げることとしました。<br>
お申し込み即参加可能とはならず誠に恐縮ですが、何卒ご理解いただけますようお願い申し上げます。</p>

<p>参加要項を以下に掲載しています。持ち物や注意事項を記載しており、またイベント当日の受付で必要になりますので、事前にご確認いただけますようお願い申し上げます。<br>
_camp2023</p>

<p>なお申込〜イベント当日の間に何らかの事情でお申し込み内容に変更がある場合、またはお申し込み自体をキャンセルする場合、以下から申込内容を修正いただけますようお願いいたします。<br>
_editURL</p>

<p>尚ご不明な点がございましたら、以下までご連絡お願いいたします。<br>
shimokitasho.oyaji@gmail.com</p>`,

    // button: ボタンに適用するCSS
    button: 'style="'
      + 'display : inline-block;'
      + 'text-decoration: none;'
      + 'font-size : 18pt;'
      + 'text-align : center;'
      + 'cursor : pointer;'
      + 'padding : 12px 12px;'
      + 'background : #1a1aff;'
      + 'color : #ffffff;'
      + 'line-height : 1em;'
      + 'transition : .3s;'
      + 'box-shadow : 6px 6px 5px #666666;'
      + 'border : 2px solid #1a1aff;'
    + '" onMouseOver="'
      + 'box-shadow: none;'
      + 'color: #1a1aff;'
      + 'background: #ffffff;'
    + '" onMouseOut="'
      + 'box-shadow: 6px 6px 5px #666666;'
      + 'color: #ffffff;'
      + 'background: #1a1aff;'
    + '"',
  };
  try {
    console.log(v.whois+' start.',e.response); // onFormSubmit開始ログ

    v.step = '1';  // フォームから渡されるオブジェクトから行番号とメアドを取得
    v.lineNum = e.range.getRow();
    v.email = e.namedValues["メールアドレス"][0];
    console.log('lineNum:%s, email:%s',v.lineNum,v.email);

    v.step = '2'; // フォームの情報を取得
    v.responses = FormApp.openById(v.formId).getResponses();
    for( v.i=0 ; v.i<v.responses.length ; v.i++ ){
      v.timestamp = v.responses[v.i].getTimestamp().getTime();
      console.log('2.1. timestamp='+v.timestamp);
      v.form[String(v.timestamp)] = {
        timestamp: v.timestamp,
        email: v.responses[v.i].getRespondentEmail(),
        editURL: v.responses[v.i].getEditResponseUrl()
      }
    }
    console.log('v.form='+JSON.stringify(v.form));

    v.step = '3'; // シート"master"に追加情報を記入
    v.sheet = szSheet('master','タイムスタンプ');
    for( v.i=0 ; v.i<v.sheet.data.length ; v.i++ ){
      v.d = v.sheet.data[v.i];
      v.stamp = new Date(v.d['タイムスタンプ']).getTime();
      if( !v.d.entryNo || !v.d.editURL || !v.d.authority ){
        v.updateResult = v.sheet.update({
          entryNo: v.i+1,
          editURL: v.form[String(v.stamp)].editURL,
          authority: 1,
        },{num:v.i,append:false});
        //console.log('updateResult:'+JSON.stringify(v.updateResult));
      }
      if( v.i === (v.lineNum - 2) ){
        v.entryData = v.sheet.data[v.i];
        console.log('entryData:'+JSON.stringify(v.entryData));
      }
    }

    v.step = '4';   // 回答者にメールを送信
    v.step = '4.1'; // プレーン・html共通部分の置換
    v.content = v.content.replace('_name',v.entryData['申込者氏名']);
    v.camp2023 = 'https://shimokitazawashooyajinokai.on.drv.tw'
      + '/public/camp2023.html?id=' + v.entryData.entryNo;
    console.log('4.1 content='+v.content);

    v.step = '4.2'; // プレーンの作成
    v.plane = v.content
      .replaceAll(/<.+?>/g,'')  // htmlタグの削除
      .replace('_camp2023',v.camp2023)
      .replace('_editURL',v.entryData.entryNo);
    console.log("4.2 plane="+v.plane);

    v.step = '4.3'; // htmlの作成
    v.html = v.content
      .replace('_camp2023','<a ' + v.button + ' href="'
        + v.camp2023 + '" class="button">参加案内</a>')
      .replace('_editURL','<a ' + v.button + ' href="'
        + v.entryData.editURL + '" class="button">回答を編集</a>');
    v.html = '<!DOCTYPE html><html xml:lang="ja" lang="ja">'
      + '<head></head><body>' + v.html + '</body></html>';
    console.log("4.3 html="+v.html);

    v.draft = GmailApp.createDraft(
      v.entryData['メールアドレス'],
      '[受付]校庭キャンプ2023 申込',
      v.plane,
      {
        htmlBody: v.html,
        name: '下北沢小おやじの会',
      }
    );
    v.draftId = v.draft.getId();
    GmailApp.getDraft(v.draftId).send();

    console.log('Mail Remaining Daily Quota:'+MailApp.getRemainingDailyQuota());

    console.log(v.whois+' end.'); // onFormSubmit正常終了ログ
  } catch(e) {
    console.error(v.whois+' abnormal end.\n',e,v);
  }
}
</script>

<script type="text/javascript" class="test">/* テスト用 */
/*
const onFormSubmitTest = () => {
  // e = {range:{rowStart:3}}
  e={"authMode":"FULL","namedValues":{"ボランティア":[""],"参加する時間帯":[""],"メールアドレス":["nakaone.kunihiro@gmail.com"],"キャンセル":[""],"参加者②氏名":[""],"参加者②学年":[""],"折り紙希望":[""],"備考":[""],"タイムスタンプ":["2023/03/01 17:13:12"],"参加者①学年":["","3"],"参加者①氏名":["てすと　さぶろう"],"参加者③学年":[""],"ML配信":["可"],"保護者の同伴":[""],"参加者③氏名":[""]},"range":{"columnEnd":15,"columnStart":1,"rowEnd":6,"rowStart":6},"source":{},"triggerUid":"14956232","values":["2023/03/01 17:13:12","nakaone.kunihiro@gmail.com","てすと　さぶろう","","","","","可","","","","3","","","",""]};
  onFormSubmit(e);
}
*/

function onFormSubmitTest(){
  const v = {data:[
    'fuga','hoge',
  ]};
  console.log('onFormSubmitTest start.');
  try {

    for( let i=0 ; i<v.data.length ; i++ ){
      v.result = onFormSubmit(v.data[i]);
      console.log(v.result);
    }
    console.log('onFormSubmitTest end.');

  } catch(e){
    console.error('onFormSubmitTest abnormal end.',e);
  }
}
</script>

<!-- 自作ライブラリ -->
<script type="text/javascript" class="core" data-embed="../component/postMails.js"></script>
<script type="text/javascript" class="core" data-embed="../component/szSheet.js"></script>

</div><!-- 終了：Script領域 -->
</body></html>