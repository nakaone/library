<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: core.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: core.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* 【開発ロードマップ】
  underDev/SpreadDb/core.js
    create tableでpKey設定機能を追加
    update(append)で更新＋追加機能をテスト
  underDev/GASutil/test/proto.js
    SpreadDbの元ソースをlibからunderDevに変更
    configでファイル一覧に以下項目を追加
      - 修正前：現状(マイドライブ〜所属フォルダ＋現ファイル名)
          移動処理後は修正後(移動先フルパス)
      - 修正後：移動先指定(移動先フルパス＋新ファイル名)
          移動処理後は空欄
      - 結果：処理前は空欄、処理後は修正前
      - 備考
  underDev/GASutil/getFilePropertiesメソッド
    フルパス情報取得機能追加
  underDev/GASutil/listFilesメソッド
    シート更新機能を削除
    テーブル更新はlistFilesで行う
  underDev/GASutil/updateFileListメソッド(新規)
    シート更新機能をlistFilesからここに移動
  underDev/GASutil/moveFileメソッド(新規)
    ファイル情報テーブルを元にファイル名変更＋フォルダ移動
    ファイル情報テーブルを更新(修正前・修正後・結果)
*/
/**
 * @typedef {Object} FileProperties - ファイルの属性情報
 * @property {string} id - ファイルID
 * @property {string} name - ファイル名
 * @property {string} mime - MIMEタイプ
 * @property {string} desc - 説明
 * @property {string} url - ファイルを開くURL
 * @property {string[]} viewers - 閲覧者・コメント投稿者(e-mail)のリスト
 * @property {string[]} editors - 編集者(e-mail)のリスト
 * @property {string} created - ファイルの作成(アップロード)日付。拡張ISO8601形式の文字列
 * @property {string} updated - ファイルの最終更新日付。拡張ISO8601形式の文字列
 */

/** GASutil: GAS 関連のユーティリティ集
 * @namespace GASutil
 * @param {Object} arg={}
 * @param {Object} [arg.db] - SpreadDbへの起動時引数
 * @param {schemaDef} [arg.db.schema] - schema
 * @param {Object} [arg.db.opt] - opt。現状無し
 * @param {string} [arg.FileListSheetName=null] - ファイル一覧を保存するシート名
 */
function GASutil(arg={}) {
  const pv = { whois: 'GASutil', rv: null};

  /** getFileProperties: Fileオブジェクトから属性情報を取得し、FilePropertiesオブジェクトとして返す
   * @memberof GASutil
   * @param {GoogleAppsScript.Drive.File} file - DriveのFileオブジェクト
   * @returns {FileProperties} ファイルの属性情報
   */
  function getFileProperties(file){
    const rv = {
      id: file.getId(), // ID
      name: file.getName(), // ファイル名
      mime: file.getMimeType(),
      desc: file.getDescription(),  // 説明
      url: file.getUrl(), // ファイルを開くURL
      //download : file.getDownloadUrl(),  // ダウンロードに使用するURL
      viewers: [], // {string[]} 閲覧者・コメント投稿者のリスト
      editors: [], // {string[]} 編集者(e-mail)のリスト
      created: toLocale(file.getDateCreated()), // {string} ファイルの作成(アップロード)日付。拡張ISO8601形式の文字列
      updated: toLocale(file.getLastUpdated()), // {string} ファイルの最終更新日付。拡張ISO8601形式の文字列
    };

    // Userからe-mailを抽出
    // class User: https://developers.google.com/apps-script/reference/drive/user?hl=ja
    file.getViewers().forEach(x => rv.viewers.push(x.getEmail()));
    file.getEditors().forEach(x => rv.editors.push(x.getEmail()));
    return rv;
  }

  /** listFiles: 指定フォルダ直下のファイル一覧を取得
   * @memberof GASutil
   * @param {string} [folderId=null] - フォルダID。nullの場合は現在のスプレッドシートが存在するフォルダ
   * @param {string} [sheetName=null] - ファイル一覧を保存するシート名
   *   - null: シートに保存しない
   *   - 空文字列: シート名はpv.FileListSheetNameを参照
   * @returns {FileProperties[]} ファイル属性情報の配列
   */
  function listFiles(folderId=null,sheetName=null) {
    const v = { whois: 'listFiles', rv: [], base: new Date().getTime() };
    // base: 開発用にold.jsonを作成する際、リスト化対象日時を指定(ex. new Date('2025/4/1'))
    dev.start(v.whois, [...arguments]);
    try {

      // -------------------------------------------------------------
      dev.step(1);  // 対象フォルダの特定
      // -------------------------------------------------------------
      if( folderId === null ){
        dev.step(1.1);  // 本スプレッドシートのIDを取得
        v.spread = SpreadsheetApp.getActiveSpreadsheet();
        v.spreadId = v.spread.getId();

        dev.step(1.2);  // 親フォルダおよび直下のファイルを取得
        v.parent = DriveApp.getFileById(v.spreadId).getParents();
        folderId = v.parent.next().getId();
      }

      dev.step(1.3);  // 対象フォルダのFolderオブジェクトを取得
      v.folder = DriveApp.getFolderById(folderId);
      if( v.folder instanceof Error ) throw v.folder;

      dev.step(1.4);  // 対象フォルダ直下のファイルオブジェクトを取得
      v.files = v.folder.getFiles();

      // -------------------------------------------------------------
      dev.step(2);  // ファイルを取得、その属性をオブジェクト化
      // -------------------------------------------------------------
      while (v.files.hasNext()) {
        v.file = v.files.next();
        v.rv.push(getFileProperties(v.file));
      }
      dev.dump(v.rv);

      // -------------------------------------------------------------
      dev.step(3);  // シート保存指定が有れば格納
      // -------------------------------------------------------------
      if( typeof sheetName === 'string' ){
        dev.step(3.1);  // 保存先テーブル・シート名の特定
        if( sheetName === '' ){
          if( pv.FileListSheetName ){
            sheetName = pv.FileListSheetName;
          } else {
            throw new Error('Invalid FileListSheetName');
          }
        }

        dev.step(3.2);  // RDBに格納
        v.sql = `insert into ${sheetName} select * from ?;`;
        v.r = pv.db.exec(v.sql,[v.rv]);
        if( v.r instanceof Error ) throw v.r;

        dev.step(3.3);  // シートにセーブ
        v.r = pv.db.save(sheetName);
        if( v.r instanceof Error ) throw v.r;
      }

      dev.end(); // 終了処理
      return v.rv;

    } catch (e) { dev.error(e); return e; }
  }

  dev.start(pv.whois);
  try {

    dev.step(1.1);  // 引数に既定値設定、pvに保存
    arg = mergeDeeply(arg,{
      db: null,
      FileListSheetName: null,
    });
    Object.keys(arg).forEach(x => pv[x]=arg[x]);

    dev.step(1.2);  // SpreadDbを使用する場合、pv.dbとして生成
    if( arg.db !== null ){
      if( typeof arg.db.opt === 'undefined' ) arg.db.opt = {};
      pv.db = SpreadDb(arg.db.schema,arg.db.opt);
      if( pv.db instanceof Error ) throw pv.db;
    }

    dev.step(2);  // SpreadDb.appendテスト
    pv.sql = 'insert into `ファイル一覧` values {id:1,name:"f01"};'
    + 'insert into `ファイル一覧` values {id:2,name:"f02"};'
    + 'select * from `ファイル一覧`;';
    pv.r = pv.db.exec(pv.sql);
    dev.dump(pv.r);

    dev.end(); // 終了処理
    pv.rv = {
      listFiles,
      // overLimit: 最大起動時間を超えた場合、再試行するトリガーを生成
    };
    return pv.rv;

  } catch (e) { dev.error(e); return e; }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="GASutil.html">GASutil</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Sun Sep 21 2025 17:11:58 GMT+0900 (日本標準時)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
