# Member ã‚¯ãƒ©ã‚¹ ä»•æ§˜æ›¸

## æ¦‚è¦

- Member ã¯ ã‚µãƒ¼ãƒå´ ã§ãƒ¡ãƒ³ãƒæƒ…å ±ã‚’ä¸€å…ƒçš„ã«ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹ã§ã™ã€‚
- åŠ å…¥ãƒ»ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰è©¦è¡Œãƒ»ãƒ‡ãƒã‚¤ã‚¹åˆ¥CPkeyç®¡ç†ãªã©ã®çŠ¶æ…‹ã‚’çµ±ä¸€çš„ã«æ‰±ã„ã¾ã™ã€‚
- ãƒãƒ«ãƒãƒ‡ãƒã‚¤ã‚¹åˆ©ç”¨ã‚’å‰æã¨ã—ã€memberListã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®1è¡Œã‚’1ãƒ¡ãƒ³ãƒã¨ã—ã¦ç®¡ç†ã—ã¾ã™ã€‚

## çŠ¶æ…‹é·ç§»

```mermaid
stateDiagram-v2
  [*] --> æœªåŠ å…¥
  æœªåŠ å…¥ --> å¯©æŸ»ä¸­ : åŠ å…¥è¦æ±‚
  å¯©æŸ»ä¸­ --> åŠ å…¥ä¸­ : æ‰¿èª
  å¯©æŸ»ä¸­ --> [*] : å¦èª
  state åŠ å…¥ä¸­ {
    [*] --> æœªãƒ­ã‚°ã‚¤ãƒ³
    æœªãƒ­ã‚°ã‚¤ãƒ³ --> ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œä¸­ : ãƒ­ã‚°ã‚¤ãƒ³è¦æ±‚
    ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œä¸­ --> ãƒ­ã‚°ã‚¤ãƒ³ä¸­ : æˆåŠŸ
    ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œä¸­ --> ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œä¸­ : å¤±æ•—(å›æ•°åˆ¶é™å†…)
    ãƒ­ã‚°ã‚¤ãƒ³ä¸­ --> ãƒ­ã‚°ã‚¤ãƒ³æœŸé™åˆ‡ã‚Œ
    ãƒ­ã‚°ã‚¤ãƒ³æœŸé™åˆ‡ã‚Œ --> [*]
    ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œä¸­ --> å‡çµä¸­ : å¤±æ•—(å›æ•°åˆ¶é™è¶…)
    å‡çµä¸­ --> [*]
  }
  åŠ å…¥ä¸­ --> åŠ å…¥æœŸé™åˆ‡ã‚Œ
  åŠ å…¥æœŸé™åˆ‡ã‚Œ --> [*]
```

| No | çŠ¶æ…‹ | èª¬æ˜ãƒ»åˆ¤å®šæ–¹æ³• |
| --: | :-- | :-- |
| 1 | æœªåŠ å…¥ | memberListã«å­˜åœ¨ã—ãªã„<br>memberList.memberIdã«ç„¡ã„ |
| 2 | å¯©æŸ»ä¸­ | ç®¡ç†è€…æ‰¿èªå¾…ã¡<br>!memberList.accepted && !memberList.reportResult |
| 3 | åŠ å…¥ä¸­ | æœ‰åŠ¹ãƒ¡ãƒ³ãƒã€‚æœŸé™å†…ã§ã‚ã‚Œã°èªè¨¼å¯èƒ½<br>0 < memberList.accepted && Date.now() < memberList.expire |
| 4 | &emsp;æœªãƒ­ã‚°ã‚¤ãƒ³ | å½“è©²ãƒ‡ãƒã‚¤ã‚¹ã§ã¯æœ‰åŠ¹ãªCPkeyãŒæœªç™ºè¡Œã€ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã®çŠ¶æ…‹<br>ï¼ˆä»–ãƒ‡ãƒã‚¤ã‚¹ã§ã¯ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã§ã‚ã£ã¦ã‚‚ã‚ˆã„ï¼‰<br>memberId[deviceId].CPkeyUpdated+authConfig.loginLifeTime < Date.now() |
| 5 | &emsp;ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œä¸­ | èªè¨¼ç”¨ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ç™ºè¡Œæ¸ˆã¿ã§ã€çµæœãŒæœªç¢ºå®š<br>Date.now() < memberList.memberId[deviceId].trial[0].created + authConfig.passcodeLifeTime |
| 6 | &emsp;ãƒ­ã‚°ã‚¤ãƒ³ä¸­ | èªè¨¼ãŒæˆåŠŸã—ã€æ¨©é™ãŒå¿…è¦ãªå‡¦ç†ã‚‚è¦æ±‚ã§ãã‚‹çŠ¶æ…‹<br>Date.now() <= memberList.memberId[deviceId].CPkeyUpdated+authConfig.loginLifeTime |
| 7 | &emsp;ãƒ­ã‚°ã‚¤ãƒ³æœŸé™åˆ‡ã‚Œ | CPã‚­ãƒ¼ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦å†ä½œæˆãŒå¿…è¦ãªçŠ¶æ…‹<br>memberList.memberId[deviceId].CPkeyUpdated+authConfig.loginLifeTime < Date.now() |
| 8 | &emsp;å‡çµä¸­ | åˆ¶é™å›æ•°å†…ã«èªè¨¼ãŒæˆåŠŸã›ãšã€è©¦è¡Œã§ããªã„çŠ¶æ…‹<br>Date.now() < memberList.memberId[deviceId].trial[0].freezingUntil |
| 9 | åŠ å…¥æœŸé™åˆ‡ã‚Œ | ãƒ¡ãƒ³ãƒåŠ å…¥æ‰¿èªå¾Œã®æœ‰åŠ¹æœŸé–“ãŒåˆ‡ã‚ŒãŸçŠ¶æ…‹<br>memberList.expire < Date.now() |

## çŠ¶æ…‹é·ç§»æ™‚ã«ã‚»ãƒƒãƒˆã™ã¹ãå¤‰æ•°

| çŠ¶æ…‹ | æ›´æ–°ã•ã‚Œã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ | æ›´æ–°å†…å®¹ |
| :-- | :-- | :-- |
| å¯©æŸ»ä¸­ â†’ åŠ å…¥ä¸­ | accepted, expire | æ‰¿èªæ—¥æ™‚ã€æ‰¿èªå¾Œã®æœ‰åŠ¹æœŸé™ã‚’è¨­å®š |
| åŠ å…¥ä¸­ â†’ æœªãƒ­ã‚°ã‚¤ãƒ³ | device[].trial | èªè¨¼è©¦è¡Œå±¥æ­´ã‚’åˆæœŸåŒ–ï¼ˆç©ºé…åˆ—ï¼‰ |
| æœªãƒ­ã‚°ã‚¤ãƒ³ â†’ ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œä¸­ | device[].trial[0].passcode, created | æ–°ã—ã„ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—è¨˜éŒ² |
| ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œä¸­ â†’ ãƒ­ã‚°ã‚¤ãƒ³ä¸­ | device[].CPkey, CPkeyUpdated | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸCPkeyã‚’ç™»éŒ² |
| ãƒ­ã‚°ã‚¤ãƒ³ä¸­ â†’ ãƒ­ã‚°ã‚¤ãƒ³æœŸé™åˆ‡ã‚Œ | device[].CPkeyUpdated | æœŸé™åˆ‡ã‚Œåˆ¤å®šã«ã‚ˆã‚Šæ›´æ–°ãªã—ã€‚å†ç”Ÿæˆã‚’è¦æ±‚ |
| ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œä¸­ â†’ å‡çµä¸­ | device[].trial[0].freezingUntil | ç¾åœ¨æ™‚åˆ»ï¼‹freezingã‚’ã‚»ãƒƒãƒˆ |
| åŠ å…¥ä¸­ â†’ åŠ å…¥æœŸé™åˆ‡ã‚Œ | expire | åˆ¤å®šã®ã¿ã€‚æ›´æ–°ãªã— |

## ãƒ‡ãƒ¼ã‚¿å‹å®šç¾©

### Member

<!--::$tmp/Member.md::-->

### authTrialLog

<!--::$tmp/MemberTrialLog.md::-->

### MemberTrial

<!--::$tmp/MemberTrial.md::-->

### MemberProfile

<!--::$tmp/MemberProfile.md::-->

### MemberDevice

<!--::$tmp/MemberDevice.md::-->

## ã‚¯ãƒ©ã‚¹ãƒ»ãƒ¡ã‚½ãƒƒãƒ‰å®šç¾©

- ãƒ¡ãƒ³ãƒåŠ å…¥æ‰¿èªã¯adminãŒã‚·ãƒ¼ãƒˆä¸Šã§è¡Œã†

### constructor()

```js
/**
 * Member ã‚¯ãƒ©ã‚¹
 * @class
 * @description memberListã®1è¡Œã‚’ã‚‚ã¨ã«ã€ãƒ¡ãƒ³ãƒæƒ…å ±ã¨çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ã€‚
 */
class Member {

  /**
   * @constructor
   * @param {Object} arg
   * @param {string} arg.sheetName - memberListã®ã‚·ãƒ¼ãƒˆå
   * @param {string} arg.memberId - ãƒ¡ãƒ³ãƒè­˜åˆ¥å­(ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹)
   * @param {Object} [opt] - ã‚ªãƒ—ã‚·ãƒ§ãƒ³(authConfig)
   * @description æŒ‡å®šã•ã‚ŒãŸmemberIdã®æƒ…å ±ã‚’å–å¾—ã—ã€çŠ¶æ…‹ã‚’è§£æã—ã¦ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«å±•é–‹ã™ã‚‹ã€‚
   */
  constructor(arg, opt) {}
}
```

### getStatus(): ãƒ¡ãƒ³ãƒã®ç¾åœ¨çŠ¶æ…‹ã‚’åˆ¤å®šã™ã‚‹

```js
/**
 * ãƒ¡ãƒ³ãƒã®ç¾åœ¨çŠ¶æ…‹ã‚’åˆ¤å®šã™ã‚‹
 * @param {void}
 * @returns {string} ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¿”ã™ï¼ˆä¾‹ï¼š"æœªåŠ å…¥"ã€"ãƒ­ã‚°ã‚¤ãƒ³ä¸­"ãªã©ï¼‰
 */
```

### register(): æ–°è¦ãƒ¡ãƒ³ãƒã‚’ç™»éŒ²ã™ã‚‹

```js
/**
 * æ–°è¦ãƒ¡ãƒ³ãƒã‚’ç™»éŒ²ã™ã‚‹
 * @param {string} name - ãƒ¡ãƒ³ãƒå
 * @param {string} memberId - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
 * @param {MemberProfile} profile - åˆæœŸæ¨©é™ãƒ»å±æ€§æƒ…å ±
 * @returns {Object} ç™»éŒ²çµæœ
 */
```

### createPasscode(): ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ç”Ÿæˆå‡¦ç†

```js
/**
 * ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ç”Ÿæˆå‡¦ç†
 * @param {string} deviceId
 * @returns {MemberTrial} æ–°ã—ã„èªè¨¼è©¦è¡Œæƒ…å ±
 */
```

### verifyPasscode(): å…¥åŠ›ã•ã‚ŒãŸãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æ¤œè¨¼ã™ã‚‹

```js
/**
 * å…¥åŠ›ã•ã‚ŒãŸãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æ¤œè¨¼ã™ã‚‹
 * @param {string} deviceId
 * @param {string} entered - å…¥åŠ›ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰
 * @param {number} timestamp - åˆ¤å®šæ™‚åˆ»
 * @returns {MemberTrialLog} åˆ¤å®šçµæœ
 */
```

### updateCPkey(): CPkeyæ›´æ–°å‡¦ç†ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé€ä¿¡ã«åŸºã¥ãï¼‰

```js
  /**
   * CPkeyæ›´æ–°å‡¦ç†ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé€ä¿¡ã«åŸºã¥ãï¼‰
   * @param {string} deviceId
   * @param {string} newCPkey
   * @returns {boolean} ç™»éŒ²çµæœ
   */
```

### maintenance(): åŠ å…¥æœŸé™ãƒ»CPkeyæœŸé™ãªã©ã®å®šæœŸãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†

| åŒºåˆ†             | å‡¦ç†å†…å®¹                                                                                                   | å¯¾è±¡ãƒ»ç›®çš„                  |
| :------------- | :----------------------------------------------------------------------------------------------------- | :--------------------- |
| ğŸ• **æœŸé™ç®¡ç†**    | - `memberList.expire` ã‚’éããŸãƒ¡ãƒ³ãƒã‚’ã€ŒåŠ å…¥æœŸé™åˆ‡ã‚Œã€ã«ã™ã‚‹<br>- `device[].CPkeyUpdated` ãŒ `loginLifeTime` è¶…éãªã‚‰CPkeyã‚’ç„¡åŠ¹åŒ– | åŠ å…¥æœŸé™ãƒ»CPkeyã®æœ‰åŠ¹æœŸé™åˆ‡ã‚Œã®è‡ªå‹•å‡¦ç† |
| ğŸ§Š **å‡çµè§£é™¤**    | - `trial[].freezingUntil < Date.now()` ãªã‚‰å‡çµçŠ¶æ…‹ã‚’è§£é™¤                                                       | èªè¨¼è©¦è¡Œå¤±æ•—ã«ã‚ˆã‚‹å‡çµæœŸé–“çµ‚äº†å¾Œã®è‡ªå‹•è§£é™¤  |
| ğŸ§¹ **å±¥æ­´æ•´ç†**    | - `trial.log`ã®å¤ã„å±¥æ­´ã‚’`generationMax`è¶…éåˆ†ã ã‘å‰Šé™¤<br>- ä¸è¦ãƒ‡ãƒã‚¤ã‚¹ï¼ˆé•·æœŸé–“éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼‰ã‚’å‰Šé™¤                                    | ãƒ‡ãƒ¼ã‚¿è‚¥å¤§åŒ–é˜²æ­¢ã€æ•´åˆæ€§ç¶­æŒ         |
| ğŸ§­ **æ•´åˆæ€§è£œæ­£**   | - CPkeyãŒå­˜åœ¨ã—ãªã„ã®ã«`ãƒ­ã‚°ã‚¤ãƒ³ä¸­`åˆ¤å®šã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒã‚¤ã‚¹ã‚’ä¿®æ­£<br>- profile.authorityãŒç©ºã®å ´åˆã¯`authConfig.defaultAuthority`ã§è£œå®Œ      | ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆã®è‡ªå‹•ä¿®å¾©            |
| âœ‰ï¸ **é€šçŸ¥ç³»ï¼ˆä»»æ„ï¼‰** | - æœŸé™åˆ‡ã‚Œ/å‡çµ/æ›´æ–°è¦æ±‚ãªã©ãŒç™ºç”Ÿã—ãŸå ´åˆã«ç®¡ç†è€…ã‚„ãƒ¦ãƒ¼ã‚¶ã¸ãƒ¡ãƒ¼ãƒ«é€šçŸ¥                                                                  | é‹ç”¨æ”¯æ´ãƒ»ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥             |

```js
/**
 * @method maintenance
 * @desc memberListå…¨ä½“ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã€æœŸé™åˆ‡ã‚Œãƒ»å‡çµè§£é™¤ãƒ»æ•´åˆæ€§è£œæ­£ãªã©ã‚’è¡Œã†ã€‚
 * @param {Object} [opt] - å®Ÿè¡Œã‚ªãƒ—ã‚·ãƒ§ãƒ³
 * @param {boolean} [opt.notify=true] - å‡¦ç†çµæœã‚’ç®¡ç†è€…ã¸é€šçŸ¥ã™ã‚‹ã‹
 * @param {boolean} [opt.cleanup=true] - ä¸è¦ãƒ‡ãƒ¼ã‚¿(æ—§trial,æœŸé™åˆ‡ã‚Œdevice)ã‚’å‰Šé™¤ã™ã‚‹ã‹
 * @returns {Object} - å®Ÿè¡Œçµæœã‚µãƒãƒª { cleaned: number, expired: number, unfrozen: number, notified: number }
 */
```
