[0000]SchemaTest start.
-- footprint
(root)
-- arguments
(void)
[0001]Schema start.
-- footprint
[0000]SchemaTest.1
-- arguments
{
  dbName: "kz12"(String)
  tableDef: {
    kz標準: {
      note: "kawazanyoで使用する仕訳日記帳の標準"(String)
      primaryKey: [
        0: "伝票番号"(String)
        1: "明細番号"(String)
      ]
      colDef: [
        0: {
          colName: "年度"(String)
          type: "number"(String)
        }
        1: {
          colName: "伝票番号"(String)
          type: "number"(String)
          note: "伝票を一意に特定する番号"(String)
        }
        2: {
          colName: "明細番号"(String)
          type: "number"(String)
          note: "伝票内の明細行番号"(String)
        }
        3: {
          colName: "取引日"(String)
          type: "string"(String)
          alias: [
            0: "日付"(String)
            1: "取引日付"(String)
            2: "伝票日付"(String)
          ]
        }
        4: {
          colName: "摘要"(String)
          type: "string"(String)
          alias: [
            0: "取引摘要"(String)
          ]
        }
        5: {
          colName: "補助摘要"(String)
          type: "string"(String)
        }
        6: {
          colName: "借方科目"(String)
          type: "string"(String)
          alias: [
            0: "借方勘定科目"(String)
            1: "借方科目名称"(String)
          ]
        }
        7: {
          colName: "借方補助"(String)
          type: "string"(String)
          alias: [
            0: "借方補助科目"(String)
            1: "借方補助科目名称"(String)
          ]
        }
        8: {
          colName: "借方部門"(String)
          type: "string"(String)
          alias: [
            0: "借方部門名称"(String)
          ]
        }
        9: {
          colName: "借方本体"(String)
          type: "number"(String)
        }
        10: {
          colName: "借方税額"(String)
          type: "number"(String)
          alias: [
            0: "借方税金額"(String)
            1: "借方消費税"(String)
          ]
        }
        11: {
          colName: "借方金額"(String)
          type: "number"(String)
        }
        12: {
          colName: "貸方科目"(String)
          type: "string"(String)
          alias: [
            0: "貸方勘定科目"(String)
            1: "貸方科目名称"(String)
          ]
        }
        13: {
          colName: "貸方補助"(String)
          type: "string"(String)
          alias: [
            0: "貸方補助科目"(String)
            1: "貸方補助科目名称"(String)
          ]
        }
        14: {
          colName: "貸方部門"(String)
          type: "string"(String)
          alias: [
            0: "貸方部門名称"(String)
          ]
        }
        15: {
          colName: "貸方本体"(String)
          type: "number"(String)
        }
        16: {
          colName: "貸方税額"(String)
          type: "number"(String)
          alias: [
            0: "貸方税金額"(String)
            1: "貸方消費税"(String)
          ]
        }
        17: {
          colName: "貸方金額"(String)
          type: "number"(String)
        }
        18: {
          colName: "備考"(String)
          type: "string"(String)
        }
      ]
    }
    勘定科目: {
      note: "kawazanyoで使用する勘定科目の一覧。ツリー構造のテーブル"(String)
      colDef: [
        0: {
          colName: "大分類"(String)
          type: "string"(String)
          note: "BS/PL上の大分類"(String)
        }
        1: {
          colName: "中分類"(String)
          type: "string"(String)
          note: "BS/PL上の中分類"(String)
        }
        2: {
          colName: "小分類"(String)
          type: "string"(String)
          note: "BS/PL上の小分類"(String)
        }
        3: {
          colName: "科目名"(String)
          type: "string"(String)
          note: "勘定科目名"(String)
        }
        4: {
          colName: "CF分類"(String)
          type: "string"(String)
          note: "CF上の分類を' > 'で連結"(String)
        }
      ]
    }
    過年度一覧: {
      note: "過年度の仕訳日記帳データ(CSV)に関する情報"(String)
      primaryKey: [
        0: "年度"(String)
      ]
      colDef: [
        0: {
          colName: "年度"(String)
          type: "number"(String)
          note: "会計年度"(String)
        }
        1: {
          colName: "状態"(String)
          type: "string"(String)
          note: "未了 or 完了"(String)
        }
        2: {
          colName: "パス"(String)
          type: "string"(String)
          note: "年度別仕訳日記帳(CSV)へのGoogle Driveのパス"(String)
        }
        3: {
          colName: "ID"(String)
          type: "string"(String)
          note: "CSVのGoogle Drive上のファイルID"(String)
        }
        4: {
          colName: "URL"(String)
          type: "string"(String)
          note: "CSVのURL。必ずプレビューで開くよう、IDから導出"(String)
        }
        5: {
          colName: "文字コード"(String)
          type: "string"(String)
          note: "CSVの文字コード。Shift-JIS(MS932)対応"(String)
        }
        6: {
          colName: "ヘッダ"(String)
          type: "string"(String)
          note: "CSV上のヘッダ行番号。基底=1"(String)
        }
        7: {
          colName: "備考"(String)
          type: "string"(String)
          note: ""(String)
        }
        8: {
          colName: "決算書パス"(String)
          type: "string"(String)
          note: "当該会計年度のBS/PL(PDF)へパス"(String)
        }
        9: {
          colName: "決算書URL"(String)
          type: "string"(String)
          note: "同URL"(String)
        }
        10: {
          colName: "頁"(String)
          type: "string"(String)
          note: "PDF上でBS/PLが掲載されている頁番号"(String)
        }
      ]
    }
  }
  tables: {
    過年度CSV: {
      def: "kz標準"(String)
    }
    勘定科目: {
    }
    過年度一覧: {
    }
  }
  custom: {
    toLocale: "x => toLocale(x,{
        verbose: false,
        format:'yyyy/MM/dd',
        undecimber: true,
        fyEnd:'undefined',
        errValue: 'error',
      })"(String)
    convertCharacters: "x => convertCharacters(x)"(String)
  }
}
[0002]Schema.expand start.
-- footprint
[0000]SchemaTest.1 > [0001]Schema.1
-- arguments
{
  dbName: "kz12"(String)
  tableDef: {
    kz標準: {
      note: "kawazanyoで使用する仕訳日記帳の標準"(String)
      primaryKey: [
        0: "伝票番号"(String)
        1: "明細番号"(String)
      ]
      colDef: [
        0: {
          colName: "年度"(String)
          type: "number"(String)
        }
        1: {
          colName: "伝票番号"(String)
          type: "number"(String)
          note: "伝票を一意に特定する番号"(String)
        }
        2: {
          colName: "明細番号"(String)
          type: "number"(String)
          note: "伝票内の明細行番号"(String)
        }
        3: {
          colName: "取引日"(String)
          type: "string"(String)
          alias: [
            0: "日付"(String)
            1: "取引日付"(String)
            2: "伝票日付"(String)
          ]
        }
        4: {
          colName: "摘要"(String)
          type: "string"(String)
          alias: [
            0: "取引摘要"(String)
          ]
        }
        5: {
          colName: "補助摘要"(String)
          type: "string"(String)
        }
        6: {
          colName: "借方科目"(String)
          type: "string"(String)
          alias: [
            0: "借方勘定科目"(String)
            1: "借方科目名称"(String)
          ]
        }
        7: {
          colName: "借方補助"(String)
          type: "string"(String)
          alias: [
            0: "借方補助科目"(String)
            1: "借方補助科目名称"(String)
          ]
        }
        8: {
          colName: "借方部門"(String)
          type: "string"(String)
          alias: [
            0: "借方部門名称"(String)
          ]
        }
        9: {
          colName: "借方本体"(String)
          type: "number"(String)
        }
        10: {
          colName: "借方税額"(String)
          type: "number"(String)
          alias: [
            0: "借方税金額"(String)
            1: "借方消費税"(String)
          ]
        }
        11: {
          colName: "借方金額"(String)
          type: "number"(String)
        }
        12: {
          colName: "貸方科目"(String)
          type: "string"(String)
          alias: [
            0: "貸方勘定科目"(String)
            1: "貸方科目名称"(String)
          ]
        }
        13: {
          colName: "貸方補助"(String)
          type: "string"(String)
          alias: [
            0: "貸方補助科目"(String)
            1: "貸方補助科目名称"(String)
          ]
        }
        14: {
          colName: "貸方部門"(String)
          type: "string"(String)
          alias: [
            0: "貸方部門名称"(String)
          ]
        }
        15: {
          colName: "貸方本体"(String)
          type: "number"(String)
        }
        16: {
          colName: "貸方税額"(String)
          type: "number"(String)
          alias: [
            0: "貸方税金額"(String)
            1: "貸方消費税"(String)
          ]
        }
        17: {
          colName: "貸方金額"(String)
          type: "number"(String)
        }
        18: {
          colName: "備考"(String)
          type: "string"(String)
        }
      ]
    }
    勘定科目: {
      note: "kawazanyoで使用する勘定科目の一覧。ツリー構造のテーブル"(String)
      colDef: [
        0: {
          colName: "大分類"(String)
          type: "string"(String)
          note: "BS/PL上の大分類"(String)
        }
        1: {
          colName: "中分類"(String)
          type: "string"(String)
          note: "BS/PL上の中分類"(String)
        }
        2: {
          colName: "小分類"(String)
          type: "string"(String)
          note: "BS/PL上の小分類"(String)
        }
        3: {
          colName: "科目名"(String)
          type: "string"(String)
          note: "勘定科目名"(String)
        }
        4: {
          colName: "CF分類"(String)
          type: "string"(String)
          note: "CF上の分類を' > 'で連結"(String)
        }
      ]
    }
    過年度一覧: {
      note: "過年度の仕訳日記帳データ(CSV)に関する情報"(String)
      primaryKey: [
        0: "年度"(String)
      ]
      colDef: [
        0: {
          colName: "年度"(String)
          type: "number"(String)
          note: "会計年度"(String)
        }
        1: {
          colName: "状態"(String)
          type: "string"(String)
          note: "未了 or 完了"(String)
        }
        2: {
          colName: "パス"(String)
          type: "string"(String)
          note: "年度別仕訳日記帳(CSV)へのGoogle Driveのパス"(String)
        }
        3: {
          colName: "ID"(String)
          type: "string"(String)
          note: "CSVのGoogle Drive上のファイルID"(String)
        }
        4: {
          colName: "URL"(String)
          type: "string"(String)
          note: "CSVのURL。必ずプレビューで開くよう、IDから導出"(String)
        }
        5: {
          colName: "文字コード"(String)
          type: "string"(String)
          note: "CSVの文字コード。Shift-JIS(MS932)対応"(String)
        }
        6: {
          colName: "ヘッダ"(String)
          type: "string"(String)
          note: "CSV上のヘッダ行番号。基底=1"(String)
        }
        7: {
          colName: "備考"(String)
          type: "string"(String)
          note: ""(String)
        }
        8: {
          colName: "決算書パス"(String)
          type: "string"(String)
          note: "当該会計年度のBS/PL(PDF)へパス"(String)
        }
        9: {
          colName: "決算書URL"(String)
          type: "string"(String)
          note: "同URL"(String)
        }
        10: {
          colName: "頁"(String)
          type: "string"(String)
          note: "PDF上でBS/PLが掲載されている頁番号"(String)
        }
      ]
    }
  }
  tables: {
    過年度CSV: {
      def: "kz標準"(String)
    }
    勘定科目: {
    }
    過年度一覧: {
    }
  }
  custom: {
    toLocale: "x => toLocale(x,{
        verbose: false,
        format:'yyyy/MM/dd',
        undecimber: true,
        fyEnd:'undefined',
        errValue: 'error',
      })"(String)
    convertCharacters: "x => convertCharacters(x)"(String)
  }
}



===== result


[0000]SchemaTest step.1
0: {
  dbName: "kz12"(String)
  note: ""(String)
  tableDef: {
    kz標準: {
      note: "kawazanyoで使用する仕訳日記帳の標準"(String)
      primaryKey: [
        0: "伝票番号"(String)
        1: "明細番号"(String)
      ]
      colDef: [
        0: {
          colName: "年度"(String)
          type: "number"(String)
        }
        1: {
          colName: "伝票番号"(String)
          type: "number"(String)
          note: "伝票を一意に特定する番号"(String)
        }
        2: {
          colName: "明細番号"(String)
          type: "number"(String)
          note: "伝票内の明細行番号"(String)
        }
        3: {
          colName: "取引日"(String)
          type: "string"(String)
          alias: [
            0: "日付"(String)
            1: "取引日付"(String)
            2: "伝票日付"(String)
          ]
        }
        4: {
          colName: "摘要"(String)
          type: "string"(String)
          alias: [
            0: "取引摘要"(String)
          ]
        }
        5: {
          colName: "補助摘要"(String)
          type: "string"(String)
        }
        6: {
          colName: "借方科目"(String)
          type: "string"(String)
          alias: [
            0: "借方勘定科目"(String)
            1: "借方科目名称"(String)
          ]
        }
        7: {
          colName: "借方補助"(String)
          type: "string"(String)
          alias: [
            0: "借方補助科目"(String)
            1: "借方補助科目名称"(String)
          ]
        }
        8: {
          colName: "借方部門"(String)
          type: "string"(String)
          alias: [
            0: "借方部門名称"(String)
          ]
        }
        9: {
          colName: "借方本体"(String)
          type: "number"(String)
        }
        10: {
          colName: "借方税額"(String)
          type: "number"(String)
          alias: [
            0: "借方税金額"(String)
            1: "借方消費税"(String)
          ]
        }
        11: {
          colName: "借方金額"(String)
          type: "number"(String)
        }
        12: {
          colName: "貸方科目"(String)
          type: "string"(String)
          alias: [
            0: "貸方勘定科目"(String)
            1: "貸方科目名称"(String)
          ]
        }
        13: {
          colName: "貸方補助"(String)
          type: "string"(String)
          alias: [
            0: "貸方補助科目"(String)
            1: "貸方補助科目名称"(String)
          ]
        }
        14: {
          colName: "貸方部門"(String)
          type: "string"(String)
          alias: [
            0: "貸方部門名称"(String)
          ]
        }
        15: {
          colName: "貸方本体"(String)
          type: "number"(String)
        }
        16: {
          colName: "貸方税額"(String)
          type: "number"(String)
          alias: [
            0: "貸方税金額"(String)
            1: "貸方消費税"(String)
          ]
        }
        17: {
          colName: "貸方金額"(String)
          type: "number"(String)
        }
        18: {
          colName: "備考"(String)
          type: "string"(String)
        }
      ]
    }
    勘定科目: {
      note: "kawazanyoで使用する勘定科目の一覧。ツリー構造のテーブル"(String)
      colDef: [
        0: {
          colName: "大分類"(String)
          type: "string"(String)
          note: "BS/PL上の大分類"(String)
        }
        1: {
          colName: "中分類"(String)
          type: "string"(String)
          note: "BS/PL上の中分類"(String)
        }
        2: {
          colName: "小分類"(String)
          type: "string"(String)
          note: "BS/PL上の小分類"(String)
        }
        3: {
          colName: "科目名"(String)
          type: "string"(String)
          note: "勘定科目名"(String)
        }
        4: {
          colName: "CF分類"(String)
          type: "string"(String)
          note: "CF上の分類を' > 'で連結"(String)
        }
      ]
    }
    過年度一覧: {
      note: "過年度の仕訳日記帳データ(CSV)に関する情報"(String)
      primaryKey: [
        0: "年度"(String)
      ]
      colDef: [
        0: {
          colName: "年度"(String)
          type: "number"(String)
          note: "会計年度"(String)
        }
        1: {
          colName: "状態"(String)
          type: "string"(String)
          note: "未了 or 完了"(String)
        }
        2: {
          colName: "パス"(String)
          type: "string"(String)
          note: "年度別仕訳日記帳(CSV)へのGoogle Driveのパス"(String)
        }
        3: {
          colName: "ID"(String)
          type: "string"(String)
          note: "CSVのGoogle Drive上のファイルID"(String)
        }
        4: {
          colName: "URL"(String)
          type: "string"(String)
          note: "CSVのURL。必ずプレビューで開くよう、IDから導出"(String)
        }
        5: {
          colName: "文字コード"(String)
          type: "string"(String)
          note: "CSVの文字コード。Shift-JIS(MS932)対応"(String)
        }
        6: {
          colName: "ヘッダ"(String)
          type: "string"(String)
          note: "CSV上のヘッダ行番号。基底=1"(String)
        }
        7: {
          colName: "備考"(String)
          type: "string"(String)
          note: ""(String)
        }
        8: {
          colName: "決算書パス"(String)
          type: "string"(String)
          note: "当該会計年度のBS/PL(PDF)へパス"(String)
        }
        9: {
          colName: "決算書URL"(String)
          type: "string"(String)
          note: "同URL"(String)
        }
        10: {
          colName: "頁"(String)
          type: "string"(String)
          note: "PDF上でBS/PLが掲載されている頁番号"(String)
        }
      ]
    }
  }
  tables: {
    過年度CSV: {
      def: "kz標準"(String)
      data: [
      ]
      note: ""(String)
      primaryKey: [
      ]
      colDef: [
      ]
      top: 1(Number)
      left: 1(Number)
      startingRowNumber: 2(Number)
      name: ""(String)
      header: [
      ]
      col: {
      }
    }
    勘定科目: {
      def: ""(String)
      data: [
      ]
      note: ""(String)
      primaryKey: [
      ]
      colDef: [
      ]
      top: 1(Number)
      left: 1(Number)
      startingRowNumber: 2(Number)
      name: ""(String)
      header: [
      ]
      col: {
      }
    }
    過年度一覧: {
      def: ""(String)
      data: [
      ]
      note: ""(String)
      primaryKey: [
      ]
      colDef: [
      ]
      top: 1(Number)
      left: 1(Number)
      startingRowNumber: 2(Number)
      name: ""(String)
      header: [
      ]
      col: {
      }
    }
  }
  custom: {
    toLocale: "x => toLocale(x,{
        verbose: false,
        format:'yyyy/MM/dd',
        undecimber: true,
        fyEnd:'undefined',
        errValue: 'error',
      })"(Arrow)
    convertCharacters: "x => convertCharacters(x)"(Arrow)
  }
  original: "{"dbName":"kz12","tableDef":{"kz標準":{"note":"kawazanyoで使用する仕訳日記帳の標準","primaryKey":["伝票番号","明細番号"],"colDef":[{"colName":"年度","type":"number"},{"colName":"伝票番号","type":"number","note":"伝票を一意に特定する番号"},{"colName":"明細番号","type":"number","note":"伝票内の明細行番号"},{"colName":"取引日","type":"string","alias":["日付","取引日付","伝票日付"]},{"colName":"摘要","type":"string","alias":["取引摘要"]},{"colName":"補助摘要","type":"string"},{"colName":"借方科目","type":"string","alias":["借方勘定科目","借方科目名称"]},{"colName":"借方補助","type":"string","alias":["借方補助科目","借方補助科目名称"]},{"colName":"借方部門","type":"string","alias":["借方部門名称"]},{"colName":"借方本体","type":"number"},{"colName":"借方税額","type":"number","alias":["借方税金額","借方消費税"]},{"colName":"借方金額","type":"number"},{"colName":"貸方科目","type":"string","alias":["貸方勘定科目","貸方科目名称"]},{"colName":"貸方補助","type":"string","alias":["貸方補助科目","貸方補助科目名称"]},{"colName":"貸方部門","type":"string","alias":["貸方部門名称"]},{"colName":"貸方本体","type":"number"},{"colName":"貸方税額","type":"number","alias":["貸方税金額","貸方消費税"]},{"colName":"貸方金額","type":"number"},{"colName":"備考","type":"string"}]},"勘定科目":{"note":"kawazanyoで使用する勘定科目の一覧。ツリー構造のテーブル","colDef":[{"colName":"大分類","type":"string","note":"BS/PL上の大分類"},{"colName":"中分類","type":"string","note":"BS/PL上の中分類"},{"colName":"小分類","type":"string","note":"BS/PL上の小分類"},{"colName":"科目名","type":"string","note":"勘定科目名"},{"colName":"CF分類","type":"string","note":"CF上の分類を' > 'で連結"}]},"過年度一覧":{"note":"過年度の仕訳日記帳データ(CSV)に関する情報","primaryKey":["年度"],"colDef":[{"colName":"年度","type":"number","note":"会計年度"},{"colName":"状態","type":"string","note":"未了 or 完了"},{"colName":"パス","type":"string","note":"年度別仕訳日記帳(CSV)へのGoogle Driveのパス"},{"colName":"ID","type":"string","note":"CSVのGoogle Drive上のファイルID"},{"colName":"URL","type":"string","note":"CSVのURL。必ずプレビューで開くよう、IDから導出"},{"colName":"文字コード","type":"string","note":"CSVの文字コード。Shift-JIS(MS932)対応"},{"colName":"ヘッダ","type":"string","note":"CSV上のヘッダ行番号。基底=1"},{"colName":"備考","type":"string","note":""},{"colName":"決算書パス","type":"string","note":"当該会計年度のBS/PL(PDF)へパス"},{"colName":"決算書URL","type":"string","note":"同URL"},{"colName":"頁","type":"string","note":"PDF上でBS/PLが掲載されている頁番号"}]}},"tables":{"過年度CSV":{"def":"kz標準"},"勘定科目":{},"過年度一覧":{}},"custom":{"toLocale":"x => toLocale(x,{\n        verbose: false,\n        format:'yyyy/MM/dd',\n        undecimber: true,\n        fyEnd:'undefined',\n        errValue: 'error',\n      })","convertCharacters":"x => convertCharacters(x)"}}"(String)
  created: "2025-09-15T15:55:47.055+09:00"(String)
  expand: "function expand(schema) {
    const v = { whois: `${pv.whois}.expand`, rv: null, schema:{}};
    dev.start(v.whois, [...arguments]);
    try {

      // -------------------------------------------------------------
      dev.step(1); // schema全体の処理
      // -------------------------------------------------------------

      dev.step(1.1);  // 「引数 > pv.schema > 既定値」の優先順位で値を設定
      Object.keys(pv.schemaDef).forEach(x => {
        v.schema[x] = typeof schema[x] !== 'undefined' ? schema[x]
        : ( typeof pv.schema[x] !== 'undefined' ? pv.schema[x] : pv.schemaDef[x]);
      });

      dev.step(1.2);  // 過去のoriginalが存在していればマージして再設定
      v.schema.original = JSON.stringify(typeof pv.schema.original !== 'undefined'
      ? mergeDeeply(JSON.parse(pv.schema.original),schema) : schema);

      dev.step(1.3);  // 引数にもpv.schemaにも依存しない項目の設定
      v.schema.created = toLocale(new Date());
      v.schema.expand = expand;

      dev.step(1.4);  // customを関数化
      // 既に関数化されていた場合(再作成の場合)、何もしない
      for( v.fn in v.schema.custom ){
        if( typeof v.schema.custom[v.fn] !== 'function' )
          v.schema.custom[v.fn] = new Function('return '+v.schema.custom[v.fn])();
      }

      // -------------------------------------------------------------
      dev.step(2); // table毎の処理
      // -------------------------------------------------------------
      for( [v.name,v.table] of Object.entries(v.schema.tables) ){
        // 未定義の項目があれば既定値を設定
        Object.keys(pv.tableDef).forEach(x => {
          if( typeof v.table[x] === 'undefined' ) v.table[x] = pv.tableDef[x];
        });
      }

      dev.end(); // 終了処理
      pv.schema = v.schema;
      return pv.schema;

    } catch (e) { dev.error(e); return e; }
  }"(Function)
}
